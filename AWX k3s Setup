# AWX on k3s (RHEL 9) — Lab Guide  
**Single Control Plane + Worker | Internal DB | Envoy Gateway | TLS**

---

## 0. Lab Assumptions

- **OS**: RHEL 9
- **Cluster**: k3s
- **Control Plane Node**
  - Hostname: `rhel9-awx-k3s`
  - IP: `172.16.61.146`
- **Worker Node**
  - Hostname: `rhel9-awx-worker01`
  - IP: `172.16.61.148`
- **Database**: Internal (AWX operator-managed Postgres)
- **Ingress**: Envoy Gateway (Gateway API)
- **TLS**: Self-signed (lab only)
- **DNS Model**: Name-based (no port in URL)
- **Client DNS**: `/etc/hosts` on **laptop only**, not on VMs

---

## 1. Base OS Preparation (RHEL 9)

### 1.1 Hostname & Networking (Run FIRST)

> ⚠️ Hostname must be set **before** subscription registration.

```bash
hostnamectl set-hostname rhel9-awx-k3s

nmcli con mod ens160 ipv4.method manual \
  ipv4.addresses 172.16.61.146/24 \
  ipv4.gateway 172.16.61.2 \
  ipv4.dns "8.8.8.8 1.1.1.1"

nmcli con up ens160


1.2 Subscription Manager & Time Sync
subscription-manager register

subscription-manager repos \
  --enable=rhel-9-for-x86_64-baseos-rpms \
  --enable=rhel-9-for-x86_64-appstream-rpms

dnf install -y chrony
systemctl enable --now chronyd
timedatectl set-ntp true

1.3 Kernel & System Tuning (k3s / Containers)
cat <<EOF >/etc/sysctl.d/99-k3s.conf
net.ipv4.ip_forward = 1
vm.max_map_count = 262144
fs.inotify.max_user_watches = 524288
fs.inotify.max_user_instances = 512
EOF

sysctl --system


Disable swap:

swapoff -a
sed -i '/swap/d' /etc/fstab

2. Install k3s (Control Plane)

Disable Traefik (we use Envoy):

curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--disable traefik" sh -


Verify:

kubectl get nodes
kubectl get pods -A

3. Firewall Configuration (firewalld ON)
3.1 Enable firewalld
systemctl enable --now firewalld

3.2 Create k3s Zone (Pod Networking)
firewall-cmd --permanent --new-zone=k3s
firewall-cmd --permanent --zone=k3s --set-target=ACCEPT
firewall-cmd --permanent --zone=k3s --add-source=10.42.0.0/16

3.3 Open Required Ports (public zone)
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --permanent --add-port=6443/tcp     # Kubernetes API
firewall-cmd --permanent --add-port=10250/tcp    # kubelet
firewall-cmd --permanent --add-port=30080/tcp    # AWX NodePort (lab)
firewall-cmd --permanent --add-port=8472/udp     # Flannel VXLAN
firewall-cmd --permanent --add-masquerade
firewall-cmd --reload

4. Install Metrics Server (Required by AWX)
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml


Patch args:

kubectl patch deployment metrics-server -n kube-system --type='json' -p='[
  {
    "op": "replace",
    "path": "/spec/template/spec/containers/0/args",
    "value": [
      "--cert-dir=/tmp",
      "--secure-port=10250",
      "--kubelet-insecure-tls",
      "--kubelet-preferred-address-types=InternalIP,Hostname,ExternalIP",
      "--metric-resolution=30s"
    ]
  }
]'


Verify:

kubectl get pods -n kube-system

5. Install AWX Operator (2.19.1)
5.1 Dependencies
dnf install -y git curl tar wget unzip jq nc bind-utils net-tools iproute htop tmux

5.2 Clone Operator
git clone https://github.com/ansible/awx-operator.git
cd awx-operator
git checkout 2.19.1

5.3 Install kustomize
curl -LO https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv5.3.0/kustomize_v5.3.0_linux_amd64.tar.gz
tar -xzf kustomize_v5.3.0_linux_amd64.tar.gz
mv kustomize /usr/local/bin/

5.4 Deploy Operator
kubectl create namespace awx
kustomize build config/default > awx-operator.yaml
kubectl apply -n awx -f awx-operator.yaml

6. Deploy AWX (Internal Postgres)

awx-clean.yml

apiVersion: awx.ansible.com/v1beta1
kind: AWX
metadata:
  name: awx
  namespace: awx
spec:
  service_type: nodeport
  nodeport_port: 30080

  postgres_keepalives: true
  replicas: 1

  create_preload_data: true
  admin_user: admin
  auto_upgrade: true

  projects_persistence: false
  set_self_labels: true


Apply:

kubectl apply -f awx-clean.yml
kubectl get pods -n awx -w

7. Install Gateway API CRDs
kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/latest/download/standard-install.yaml

8. Install Envoy Gateway
kubectl apply -f https://github.com/envoyproxy/gateway/releases/latest/download/install.yaml


Verify:

kubectl get pods -n envoy-gateway-system

9. Create Envoy GatewayClass
apiVersion: gateway.networking.k8s.io/v1
kind: GatewayClass
metadata:
  name: envoy
spec:
  controllerName: gateway.envoyproxy.io/gatewayclass-controller

kubectl apply -f envoy-gatewayclass.yaml
kubectl get gatewayclass

10. Create Gateway & HTTPRoute for AWX
10.1 Gateway
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: awx-envoy-gateway
  namespace: awx
spec:
  gatewayClassName: envoy
  listeners:
  - name: http
    port: 80
    protocol: HTTP
  - name: https
    port: 443
    protocol: HTTPS
    tls:
      mode: Terminate
      certificateRefs:
      - name: awx-tls

10.2 HTTPRoute
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: awx-envoy-route
  namespace: awx
spec:
  hostnames:
  - awx.lab
  parentRefs:
  - name: awx-envoy-gateway
  rules:
  - backendRefs:
    - name: awx-service
      port: 80


Apply:

kubectl apply -f awx-gateway.yaml
kubectl apply -f awx-httproute.yaml

11. TLS (Self-Signed, Lab)
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout awx.key \
  -out awx.crt \
  -subj "/CN=awx.lab"

kubectl create secret tls awx-tls \
  --cert=awx.crt \
  --key=awx.key \
  -n awx

12. Client DNS (Laptop Only)

Add to laptop /etc/hosts:

172.16.61.146  awx.lab


⚠️ No /etc/hosts change required on the VM.

13. Validation
curl -I http://awx.lab
curl -vk https://awx.lab


Browser:

https://awx.lab/#/login


✅ No port required
✅ TLS working
✅ Envoy Gateway routing
✅ Internal Postgres

14. Worker Node Join (Optional)

14. Add a Worker Node
14.1 On Control Plane – Get Join Token
cat /var/lib/rancher/k3s/server/node-token

14.2 On Worker (RHEL 9)
hostnamectl set-hostname rhel9-awx-worker01
Open firewall ports (same as control plane).

Join the cluster
curl -sfL https://get.k3s.io | K3S_URL=https://<control plane IP>:6443 K3S_TOKEN=<PASTE_NODE_TOKEN> sh -


Verify:

kubectl get nodes
