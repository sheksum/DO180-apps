---
- name: Register multiple systems to Red Hat Satellite
  hosts: all
  become: true
  gather_facts: false

  vars:
    hostgroup: "Service Management Connector (SMx)"
    activation_key: "rhel9"

  tasks:
    - name: Generate host registration command on Satellite
      delegate_to: localhost
      shell: |
        hammer host-registration generate-command \
          --hostgroup "{{ hostgroup }}" \
          --insecure 1 \
          --setup-insights 0 \
          --force 1 \
          --activation-key {{ activation_key }}
      register: registration_cmd
      run_once: true

    - name: Run registration command on target
      shell: "{{ registration_cmd.stdout }}"
      when: registration_cmd.stdout is defined
