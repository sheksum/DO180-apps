cat > gateway-api/gateway.yaml << 'EOF'
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: pai-gateway
  namespace: openshift-ingress
spec:
  gatewayClassName: openshift-default
  listeners:
    - name: http
      protocol: HTTP
      port: 80
      allowedRoutes:
        namespaces:
          from: Selector
          selector:
            matchLabels:
              app.kubernetes.io/part-of: pai

    - name: https-dev
      protocol: HTTPS
      port: 443
      hostname: "*.dev.ocp-ai.calix.local"
      tls:
        mode: Terminate
        certificateRefs:
          - name: wildcard-dev-tls-secret
            kind: Secret
      allowedRoutes:
        namespaces:
          from: Selector
          selector:
            matchLabels:
              env: dev

    - name: https-test
      protocol: HTTPS
      port: 443
      hostname: "*.test.ocp-ai.calix.local"
      tls:
        mode: Terminate
        certificateRefs:
          - name: wildcard-test-tls-secret
            kind: Secret
      allowedRoutes:
        namespaces:
          from: Selector
          selector:
            matchLabels:
              env: test

    - name: https-prod
      protocol: HTTPS
      port: 443
      hostname: "*.prod.ocp-ai.calix.local"
      tls:
        mode: Terminate
        certificateRefs:
          - name: wildcard-prod-tls-secret
            kind: Secret
      allowedRoutes:
        namespaces:
          from: Selector
          selector:
            matchLabels:
              env: prod
EOF




cat > gateway-api/certificates.yaml << 'EOF'
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: wildcard-dev-tls
  namespace: openshift-ingress
spec:
  secretName: wildcard-dev-tls-secret
  issuerRef:
    name: vault-issuer
    kind: ClusterIssuer
  dnsNames:
    - "*.dev.ocp-ai.calix.local"
  duration: 8760h
  renewBefore: 720h
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: wildcard-test-tls
  namespace: openshift-ingress
spec:
  secretName: wildcard-test-tls-secret
  issuerRef:
    name: vault-issuer
    kind: ClusterIssuer
  dnsNames:
    - "*.test.ocp-ai.calix.local"
  duration: 8760h
  renewBefore: 720h
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: wildcard-prod-tls
  namespace: openshift-ingress
spec:
  secretName: wildcard-prod-tls-secret
  issuerRef:
    name: vault-issuer
    kind: ClusterIssuer
  dnsNames:
    - "*.prod.ocp-ai.calix.local"
  duration: 8760h
  renewBefore: 720h
EOF




cat > gateway-api/http-redirect.yaml << 'EOF'
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: http-to-https-redirect
  namespace: openshift-ingress
spec:
  parentRefs:
    - name: pai-gateway
      namespace: openshift-ingress
      sectionName: http
  rules:
    - filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            statusCode: 301
EOF



cd ~/ocp-ai-config
git add gateway-api/
git status
git commit -m "feat: Gateway API TLS - wildcard certs, HTTPS listeners, HTTP redirect"
git push origin main



oc get application gateway-api -n openshift-gitops -w
