DEV_PASS=$(openssl rand -base64 24)
TEST_PASS=$(openssl rand -base64 24)
PROD_PASS=$(openssl rand -base64 24)

echo "Dev:  $DEV_PASS"
echo "Test: $TEST_PASS"
echo "Prod: $PROD_PASS"

vault kv put kv/pai/dev/minio-credentials MINIO_ROOT_USER=minioadmin MINIO_ROOT_PASSWORD="$DEV_PASS"
vault kv put kv/pai/test/minio-credentials MINIO_ROOT_USER=minioadmin MINIO_ROOT_PASSWORD="$TEST_PASS"
vault kv put kv/pai/prod/minio-credentials MINIO_ROOT_USER=minioadmin MINIO_ROOT_PASSWORD="$PROD_PASS"


# Copy 01-external-secrets.yaml and 02-minio-all-envs.yaml to plnx-admin first
# Then:
oc apply -f 01-external-secrets.yaml

# Wait for sync, verify
oc get externalsecrets -A | grep minio
# All three should show SecretSynced / True


oc apply -f 02-minio-all-envs.yaml


# Pods running
oc get pods -n pai-dev -l app=minio
oc get pods -n pai-test -l app=minio
oc get pods -n pai-prod -l app=minio

# LB IPs assigned
oc get svc -A --field-selector spec.type=LoadBalancer

# HTTPRoutes
oc get httproutes -A | grep minio

# Health check
curl -sk https://minio.dev.ocp-ai.calix.local




apiVersion: aistor.min.io/v1
kind: ObjectStore
metadata:
  name: my-objectstore
  labels:
    app: minio
  annotations:
    prometheus.io/path: /minio/v2/metrics/cluster
    prometheus.io/port: '9000'
    prometheus.io/scrape: 'true'
  namespace: aistor
spec:
  firewall:
    imagePullPolicy: IfNotPresent
    enabled: false
  cache:
    enabled: false
  configuration:
    name: storage-configuration
  pvcProtection: false
  pools:
    - spreadZoneConfig:
        enabled: false
      annotations:
        io.kubernetes.cri-o.TrySkipVolumeSELinuxLabel: 'true'
      securityContext:
        fsGroupChangePolicy: OnRootMismatch
      volumeClaimTemplate:
        apiVersion: v1
        kind: persistentvolumeclaims
        spec:
          resources:
            requests:
              storage: 1Ti
          accessModes:
            - ReadWriteOnce
          storageClassName: directpv-min-io
      name: pool-0
      runtimeClassName: selinux
      servers: 4
      volumesPerServer: 4
  kes:
    imagePullPolicy: IfNotPresent
    replicas: 2
  certificates:
    disableAutoCert: false
  mountPath: /export
  podManagementPolicy: Parallel
  rollingTimeoutSeconds: 600


