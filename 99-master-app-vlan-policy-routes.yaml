DEV_PASS=$(openssl rand -base64 24)
TEST_PASS=$(openssl rand -base64 24)
PROD_PASS=$(openssl rand -base64 24)

echo "Dev:  $DEV_PASS"
echo "Test: $TEST_PASS"
echo "Prod: $PROD_PASS"

vault kv put kv/pai/dev/minio-credentials MINIO_ROOT_USER=minioadmin MINIO_ROOT_PASSWORD="$DEV_PASS"
vault kv put kv/pai/test/minio-credentials MINIO_ROOT_USER=minioadmin MINIO_ROOT_PASSWORD="$TEST_PASS"
vault kv put kv/pai/prod/minio-credentials MINIO_ROOT_USER=minioadmin MINIO_ROOT_PASSWORD="$PROD_PASS"


# Copy 01-external-secrets.yaml and 02-minio-all-envs.yaml to plnx-admin first
# Then:
oc apply -f 01-external-secrets.yaml

# Wait for sync, verify
oc get externalsecrets -A | grep minio
# All three should show SecretSynced / True


oc apply -f 02-minio-all-envs.yaml


# Pods running
oc get pods -n pai-dev -l app=minio
oc get pods -n pai-test -l app=minio
oc get pods -n pai-prod -l app=minio

# LB IPs assigned
oc get svc -A --field-selector spec.type=LoadBalancer

# HTTPRoutes
oc get httproutes -A | grep minio

# Health check
curl -sk https://minio.dev.ocp-ai.calix.local



cat <<'EOF' | oc apply -f -
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: minio-credentials
  namespace: pai-dev
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-store
    kind: SecretStore
  target:
    name: minio-credentials
    creationPolicy: Owner
  data:
    - secretKey: MINIO_ROOT_USER
      remoteRef:
        key: pai/dev/minio-credentials
        property: MINIO_ROOT_USER
    - secretKey: MINIO_ROOT_PASSWORD
      remoteRef:
        key: pai/dev/minio-credentials
        property: MINIO_ROOT_PASSWORD
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: minio-credentials
  namespace: pai-test
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-store
    kind: SecretStore
  target:
    name: minio-credentials
    creationPolicy: Owner
  data:
    - secretKey: MINIO_ROOT_USER
      remoteRef:
        key: pai/test/minio-credentials
        property: MINIO_ROOT_USER
    - secretKey: MINIO_ROOT_PASSWORD
      remoteRef:
        key: pai/test/minio-credentials
        property: MINIO_ROOT_PASSWORD
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: minio-credentials
  namespace: pai-prod
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-store
    kind: SecretStore
  target:
    name: minio-credentials
    creationPolicy: Owner
  data:
    - secretKey: MINIO_ROOT_USER
      remoteRef:
        key: pai/prod/minio-credentials
        property: MINIO_ROOT_USER
    - secretKey: MINIO_ROOT_PASSWORD
      remoteRef:
        key: pai/prod/minio-credentials
        property: MINIO_ROOT_PASSWORD
EOF
