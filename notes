Creation Date: 13 Aug 2025
Update Date: 13 Aug 2025
Status: Closed
Project: VKS
Component: Calico / Keel
Brief Summary: Patching kqde2-gen1 caused CLI access loss, Rancher agent disconnection, and Calico to ToRs BGP peering failures due to documented steps conflicting with AVID guidelines for --disable-vault and capi-secrets handling.
Summary
During the image upgrade of kqde2-gen1 under CHG340229, keel was rendered with the --disable-vault option and capi-secrets were applied, following the existing patching documentation. This conflicted with AVID guidelines, which state that the --disable-vault option should be removed when rendering keel and that capi-secrets should only be applied during upgrades to components such as Calico.
As a result, the cluster experienced:
Loss of CLI access
Rancher cluster agent disconnection
Calico to ToRs BGP peering failures, triggering a NOC alert
Impact
Partial service disruption on kqde2-gen1, affecting management access, authentication, and network routing to ToRs until resolution.
Root Causes
Patching documentation was followed as written.
The documented steps conflicted with AVID guidelines.
This led to use of the --disable-vault option during keel rendering and unnecessary application of capi-secrets, causing authentication loss, Rancher disconnection, and BGP routing issues.
Resolution
Re-rendered keel without the --disable-vault option.
Rolled the cattle-cluster-agent deployment to restore management connectivity.
Restarted Calico pods on two affected nodes to clear loopback issues.
Verified CLI access, Rancher connectivity, and workload health.
Detection
Identified during patching when CLI access was lost. Confirmed by NOC alerts for Calico to ToRs BGP peering failures.
Action Items
Update patching documentation to align with AVID guidelines for --disable-vault and capi-secrets usage.
Provide refresher training on AVID patching guidelines to the operations team.
