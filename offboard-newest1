#!/usr/bin/env bash
set -euo pipefail

# Configuration
NETAPP_API="https://plano_aff_cl.calix.local/api"
NETAPP_CREDS="svc_lifecycle:d94def47f1dd637527028656aac69359bfb1f6492cf03c1198b142686fa7e98c"
NETAPP_VOL_UUID="3825009b-5037-11ef-8de2-d039eabbae46"
IPA_KEYTAB="/etc/krb5/ipa_svc.keytab"
IPA_PRINCIPAL="svc_user_lifecycle"
LOG_FILE="/var/log/user_offboard.log"
DRY_RUN="false"

# Functions
log() { echo "$(date '+%F %T') [$1] $USER_ID - $2" | tee -a "$LOG_FILE"; }

check_kerberos() {
    klist -s 2>/dev/null || kinit -kt "$IPA_KEYTAB" "$IPA_PRINCIPAL" || {
        log "ERROR" "Kerberos authentication failed"
        exit 1
    }
}

find_user() {
    local search="$1"
    # Try direct lookup first
    ipa user-show "$search" &>/dev/null && echo "$search" && return
    # Try by full name
    local uid=$(ipa user-find --cn="$search" --raw 2>/dev/null | grep "^  uid:" | head -1 | awk '{print $2}')
    [[ -n "$uid" ]] && echo "$uid" && return
    return 1
}

check_netapp_home() {
    local user="$1"
    local http_code=$(curl -sk -o /dev/null -w "%{http_code}" -u "$NETAPP_CREDS" \
        "${NETAPP_API}/storage/volumes/${NETAPP_VOL_UUID}/files/${user}?return_metadata=true")
    [[ "$http_code" == "200" ]] && echo "true" || echo "false"
}

# Main
USER_ID=""
[[ "$1" == "--dry-run" ]] && DRY_RUN="true" && shift
USER_ID="$1"
[[ -z "$USER_ID" ]] && { echo "Usage: $0 <username> [--dry-run]"; exit 1; }

log "INFO" "Starting offboard: $USER_ID"
[[ "$DRY_RUN" == "true" ]] && log "INFO" "DRY-RUN MODE"

# Step 1: Authenticate
check_kerberos

# Step 2: Find user
log "INFO" "Finding user in IPA"
FOUND_USER=$(find_user "$USER_ID") || { log "ERROR" "User not found"; exit 1; }
[[ "$FOUND_USER" != "$USER_ID" ]] && USER_ID="$FOUND_USER" && log "INFO" "Resolved to: $USER_ID"
log "OK" "User found: $USER_ID"

# Step 3: Check NetApp home
log "INFO" "Checking NetApp home directory"
HAS_HOME=$(check_netapp_home "$USER_ID")
log "OK" "NetApp home exists: $HAS_HOME"

# Step 4: Disable user
log "INFO" "Disabling IPA user"
if [[ "$DRY_RUN" == "true" ]]; then
    log "INFO" "[DRY-RUN] Would disable user"
else
    ipa user-disable "$USER_ID" &>/dev/null && log "OK" "User disabled" || log "WARN" "Disable failed"
fi

# Step 5: Delete user
log "INFO" "Deleting IPA user"
if [[ "$DRY_RUN" == "true" ]]; then
    log "INFO" "[DRY-RUN] Would delete user"
else
    ipa user-del "$USER_ID" &>/dev/null && log "OK" "User deleted" || log "ERROR" "Delete failed"
fi

# Step 6: Quarantine NetApp home directory
if [[ "$HAS_HOME" == "true" ]]; then
    log "INFO" "Quarantining NetApp home directory"
    if [[ "$DRY_RUN" == "true" ]]; then
        log "INFO" "[DRY-RUN] Would quarantine home to _decommissioned/"
    else
        local timestamp=$(date +%F_%H%M%S)
        if [[ -d "/na/plnaff/unix_homes/lab_unix_homes/${USER_ID}" ]]; then
            mv "/na/plnaff/unix_homes/lab_unix_homes/${USER_ID}" \
               "/na/plnaff/unix_homes/lab_unix_homes/_decommissioned/${USER_ID}_${timestamp}" \
               && log "OK" "Home quarantined to _decommissioned/${USER_ID}_${timestamp}" \
               || log "ERROR" "Failed to quarantine home directory"
        else
            log "WARN" "Home directory not found on NFS mount"
        fi
    fi
else
    log "INFO" "No NetApp home directory to quarantine"
fi

log "OK" "Offboard complete: $USER_ID"
