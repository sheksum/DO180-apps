#!/usr/bin/env bash
# Usage: SSH_KEY=~/.ssh/deploy_key ./push-existing-sources-lockdown.sh hosts.txt

set -euo pipefail
LOGFILE="push-sources.log"
HOSTS_FILE="${1:-}"
SOURCES_DIR="sources-files"

[ -f "$HOSTS_FILE" ] || { echo "Usage: $0 <hosts_file>"; exit 1; }

SSH_OPTS="-o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no"
[ -n "${SSH_KEY:-}" ] && SSH_OPTS="$SSH_OPTS -i $SSH_KEY"

ok=0; fail=0
echo "Run started $(date)" | tee -a "$LOGFILE"

while IFS= read -r host || [[ -n "$host" ]]; do
  host="${host%%$'\r'*}"
  [ -z "$host" ] && continue
  [[ "$host" =~ ^# ]] && continue

  echo "=== $host ===" | tee -a "$LOGFILE"

  distro=$(ssh $SSH_OPTS "deploy@$host" "lsb_release -cs 2>/dev/null || echo unknown") || distro="unknown"
  case "$distro" in
    xenial|bionic|focal|jammy|noble)
      src_file="landscape-ubuntu-${distro}-onprem.list"
      ;;
    *)
      echo "SKIP: unsupported distro ($distro)" | tee -a "$LOGFILE"
      continue
      ;;
  esac

  if scp $SSH_OPTS "$SOURCES_DIR/$src_file" "deploy@$host:/tmp/$src_file"; then
    if ssh $SSH_OPTS "deploy@$host" "
      sudo rm -f /etc/apt/sources.list.d/*.list;
      sudo mv /tmp/$src_file /etc/apt/sources.list.d/landscape-ubuntu-${distro}-onprem.list;
      sudo chown root:root /etc/apt/sources.list.d/landscape-ubuntu-${distro}-onprem.list;
      sudo chmod 644 /etc/apt/sources.list.d/landscape-ubuntu-${distro}-onprem.list;
    "; then
      echo "OK" | tee -a "$LOGFILE"
      ok=$((ok+1))
    else
      echo "FAIL: install step" | tee -a "$LOGFILE"
      fail=$((fail+1))
    fi
  else
    echo "FAIL: scp failed" | tee -a "$LOGFILE"
    fail=$((fail+1))
  fi
done < "$HOSTS_FILE"

echo "-----" | tee -a "$LOGFILE"
echo "Run finished: OK=$ok FAIL=$fail ($(date))" | tee -a "$LOGFILE"
