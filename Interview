#!/bin/bash

# Script: check-calico-peering.sh
# Purpose: Quickly check BGP peering status across all Calico nodes
# Logs the output per pod and stores in a timestamped file under /tmp

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
LOG_FILE="/tmp/calico_bgp_peering_${TIMESTAMP}.log"

echo -e "[INFO] Checking Calico BGP peering protocols on all nodes..."
echo -e "[INFO] Logs will be saved to: $LOG_FILE\n"

pods=$(kubectl get pods -n calico-system -l k8s-app=calico-node -o jsonpath='{.items[*].metadata.name}')

echo "[INFO] Calico BGP Peering Check - $TIMESTAMP" >> "$LOG_FILE"
echo "---------------------------------------------" >> "$LOG_FILE"

for pod in $pods; do
    echo -e "\n>>> Pod: $pod <<<"
    echo -e "\n>>> Pod: $pod <<<" >> "$LOG_FILE"
    echo "======================================" >> "$LOG_FILE"
    output=$(kubectl exec -it "$pod" -n calico-system -c calico-node -- sh -c "birdcl show protocols" 2>&1)
    if [ $? -ne 0 ]; then
        echo "[WARN]  $pod: Failed to exec or run birdcl"
        echo "[WARN]  $pod: Failed to exec or run birdcl" >> "$LOG_FILE"
        echo "$output" >> "$LOG_FILE"
    else
        echo "$output" | tee -a "$LOG_FILE"
    fi
    echo "======================================" >> "$LOG_FILE"
done

echo -e "\n[INFO] Check finished at $(date -u)"
echo -e "[DONE] Calico BGP peering check complete."
echo -e "View the full results with: cat $LOG_FILE"
