

oc apply -f - <<EOF
apiVersion: metallb.io/v1beta1
kind: MetalLB
metadata:
  name: metallb
  namespace: metallb-system
spec:
  logLevel: warn
EOF

oc apply -f - <<EOF
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: ai-services-dev
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.160-10.172.248.163
  autoAssign: false
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: ai-services-test
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.165-10.172.248.168
  autoAssign: false
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: ai-services-prod
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.170-10.172.248.173
  autoAssign: false
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: reserved-future
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.175-10.172.248.180
  autoAssign: false
EOF



ipaddresspool.metallb.io/ai-services-dev created
ipaddresspool.metallb.io/ai-services-test created
ipaddresspool.metallb.io/ai-services-prod created
ipaddresspool.metallb.io/reserved-future created



oc apply -f - <<EOF
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: l2-vlan1510
  namespace: metallb-system
spec:
  ipAddressPools:
    - ai-services-dev
    - ai-services-test
    - ai-services-prod
EOF




oc apply -f - <<EOF
apiVersion: v1
kind: Namespace
metadata:
  name: pai-dev
  labels:
    env: dev
    app.kubernetes.io/part-of: pai
---
apiVersion: v1
kind: Namespace
metadata:
  name: pai-test
  labels:
    env: test
    app.kubernetes.io/part-of: pai
---
apiVersion: v1
kind: Namespace
metadata:
  name: pai-prod
  labels:
    env: prod
    app.kubernetes.io/part-of: pai
EOF



oc apply -f - <<EOF
apiVersion: v1
kind: Service
metadata:
  name: nginx-test-lb
  namespace: pai-dev
  annotations:
    metallb.universe.tf/address-pool: ai-services-dev
    metallb.universe.tf/loadBalancerIPs: "10.172.248.160"
spec:
  type: LoadBalancer
  loadBalancerIP: "10.172.248.160"
  ports:
    - port: 80
      targetPort: 8080
  selector:
    app: nginx-test
EOF



NAME            TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
nginx-test-lb   LoadBalancer   172.30.37.234   <pending>     80:30808/TCP   45s
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ oc describe svc nginx-test-lb -n pai-dev | tail -20
Annotations:              metallb.universe.tf/address-pool: ai-services-dev
                          metallb.universe.tf/loadBalancerIPs: 10.172.248.160
Selector:                 app=nginx-test
Type:                     LoadBalancer
IP Family Policy:         SingleStack
IP Families:              IPv4
IP:                       172.30.37.234
IPs:                      172.30.37.234
Desired LoadBalancer IP:  10.172.248.160
Port:                     <unset>  80/TCP
TargetPort:               8080/TCP
NodePort:                 <unset>  30808/TCP
Endpoints:                10.129.0.154:8080
Session Affinity:         None
External Traffic Policy:  Cluster
Internal Traffic Policy:  Cluster
Events:
  Type     Reason            Age   From                Message
  ----     ------            ----  ----                -------
  Warning  AllocationFailed  72s   metallb-controller  Failed to allocate IP for "pai-dev/nginx-test-lb": service can not have both metallb.io/loadBalancerIPs and svc.Spec.LoadBalancerIP
hsuma@plnx-admin:~$



oc delete svc nginx-test-lb -n pai-dev

oc apply -f - <<EOF
apiVersion: v1
kind: Service
metadata:
  name: nginx-test-lb
  namespace: pai-dev
  annotations:
    metallb.universe.tf/address-pool: ai-services-dev
    metallb.universe.tf/loadBalancerIPs: "10.172.248.160"
spec:
  type: LoadBalancer
  ports:
    - port: 80
      targetPort: 8080
  selector:
    app: nginx-test
EOF


# Check which speaker owns the VIP
oc logs -l component=speaker -n metallb-system --tail=10

# Check if the endpoint is healthy
oc get endpoints nginx-test-lb -n pai-dev

# Try from a node directly
oc debug node/ocp-ai-master01.calix.local -- curl -s -o /dev/null -w "%{http_code}" http://10.172.248.160


hsuma@plnx-admin:~$ oc logs -l component=speaker -n metallb-system --tail=10
Defaulted container "speaker" out of: speaker, kube-rbac-proxy
Defaulted container "speaker" out of: speaker, kube-rbac-proxy
Defaulted container "speaker" out of: speaker, kube-rbac-proxy
{"caller":"announcer.go:131","error":"creating NDP responder for \"d4e9f9ac00cf7bb\": listen ip6:ipv6-icmp fe80::f484:9ff:fe96:49e2%d4e9f9ac00cf7bb: bind: cannot assign requested address","interface":"d4e9f9ac00cf7bb","level":"error","msg":"failed to create NDP responder","op":"createNDPResponder","ts":"2026-02-26T03:00:00Z"}
{"caller":"speakerlist.go:269","error":null,"expected":2,"joined":1,"level":"error","msg":"partial join","op":"memberDiscovery","ts":"2026-02-26T02:43:07Z"}
{"caller":"speakerlist.go:269","error":"1 error occurred:\n\t* Failed to join 10.172.248.152:9122: dial tcp 10.172.248.152:9122: connect: connection refused\n\n","expected":1,"joined":0,"level":"error","msg":"partial join","op":"memberDiscovery","ts":"2026-02-26T02:43:07Z"}
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ oc get endpoints nginx-test-lb -n pai-dev
Warning: v1 Endpoints is deprecated in v1.33+; use discovery.k8s.io/v1 EndpointSlice
NAME            ENDPOINTS           AGE
nginx-test-lb   10.129.0.154:8080   2m46s
hsuma@plnx-admin:~$ oc debug node/ocp-ai-master01.calix.local -- curl -s -o /dev/null -w "%{http_code}" http://10.172.248.160
Starting pod/ocp-ai-master01calixlocal-debug-qnld9 ...
To use host binaries, run `chroot /host`. Instead, if you need to access host namespaces, run `nsenter -a -t 1`.
403
Removing debug pod ...
hsuma@plnx-admin:~$


hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ ip addr show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:50:56:b5:7a:3a brd ff:ff:ff:ff:ff:ff
    altname enp2s1
    inet 10.172.248.105/24 brd 10.172.248.255 scope global ens33
       valid_lft forever preferred_lft forever
    inet6 fe80::250:56ff:feb5:7a3a/64 scope link
       valid_lft forever preferred_lft forever
hsuma@plnx-admin:~$ arping -c 3 ens33 10.172.248.160
arping: Too many args on command line. Expected at most one.
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ ip route get 10.172.248.150
10.172.248.150 dev ens33 src 10.172.248.105 uid 13232
    cache
hsuma@plnx-admin:~$


hsuma@plnx-admin:~$ arping -c 3 -I ens33 10.172.248.160
arping: libnet_init(LIBNET_LINK, ens33): libnet_open_link(): UID/EUID 0 or capability CAP_NET_RAW required
arping: you may need to run as root
hsuma@plnx-admin:~$ sudo arping -c 3 -I ens33 10.172.248.160
ARPING 10.172.248.160
60 bytes from 00:25:b5:51:0b:68 (10.172.248.160): index=0 time=526.104 usec
60 bytes from 00:25:b5:50:0a:68 (10.172.248.160): index=1 time=619.438 usec
60 bytes from 00:25:b5:51:0b:68 (10.172.248.160): index=2 time=388.058 usec
60 bytes from 00:25:b5:50:0a:68 (10.172.248.160): index=3 time=461.321 usec
60 bytes from 00:25:b5:50:0a:68 (10.172.248.160): index=4 time=326.507 usec
60 bytes from 00:25:b5:51:0b:68 (10.172.248.160): index=5 time=404.006 usec

--- 10.172.248.160 statistics ---
3 packets transmitted, 6 packets received,   0% unanswered (3 extra)
rtt min/avg/max/std-dev = 0.327/0.454/0.619/0.096 ms
hsuma@plnx-admin:~$




					<p>For systems using the Apache HTTP Server:
					You may now add content to the directory <tt>/var/www/html/</tt>. Note that until you do so, people visiting your website will see this page, and not your content. To prevent this page from ever being used, follow the instructions in the file <tt>/etc/httpd/conf.d/welcome.conf</tt>.</p>

					<p>For systems using NGINX:
					You should now put your content in a location of your
					choice and edit the <code>root</code> configuration directive
					in the <strong>nginx</strong> configuration file
					<code>/etc/nginx/nginx.conf</code>.</p>

					<div class="logos">
						<a href="https://access.redhat.com/products/red-hat-enterprise-linux"><img src= "/icons/poweredby.png" alt="[ Powered by Red Hat Enterprise Linux ]" /></a>
						<img src= "poweredby.png" alt="[ Powered by Red Hat Enterprise Linux ]" />
					</div>
				</div>
			</div>
		</div>
	<div class="footer">
		<a href="https://apache.org">Apache&trade;</a> is a registered trademark of <a href="https://apache.org">the Apache Software Foundation</a> in the United States and/or other countries.
        <br />
		<a href="https://nginx.com">NGINX&trade;</a> is a registered trademark of <a href="https://www.f5.com">F5 Networks, Inc.</a>.
	</div>
	</body>
* Connection #0 to host 10.172.248.160 left intact
</html>hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ oc logs -l component=speaker -n metallb-system --tail=10
Defaulted container "speaker" out of: speaker, kube-rbac-proxy
Defaulted container "speaker" out of: speaker, kube-rbac-proxy
Defaulted container "speaker" out of: speaker, kube-rbac-proxy
{"caller":"announcer.go:131","error":"creating NDP responder for \"d4e9f9ac00cf7bb\": listen ip6:ipv6-icmp fe80::f484:9ff:fe96:49e2%d4e9f9ac00cf7bb: bind: cannot assign requested address","interface":"d4e9f9ac00cf7bb","level":"error","msg":"failed to create NDP responder","op":"createNDPResponder","ts":"2026-02-26T03:00:00Z"}
{"caller":"speakerlist.go:269","error":null,"expected":2,"joined":1,"level":"error","msg":"partial join","op":"memberDiscovery","ts":"2026-02-26T02:43:07Z"}
{"caller":"speakerlist.go:269","error":"1 error occurred:\n\t* Failed to join 10.172.248.152:9122: dial tcp 10.172.248.152:9122: connect: connection refused\n\n","expected":1,"joined":0,"level":"error","msg":"partial join","op":"memberDiscovery","ts":"2026-02-26T02:43:07Z"}
hsuma@plnx-admin:~$
