

oc apply -f - <<EOF
apiVersion: metallb.io/v1beta1
kind: MetalLB
metadata:
  name: metallb
  namespace: metallb-system
spec:
  logLevel: warn
EOF

oc apply -f - <<EOF
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: ai-services-dev
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.160-10.172.248.163
  autoAssign: false
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: ai-services-test
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.165-10.172.248.168
  autoAssign: false
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: ai-services-prod
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.170-10.172.248.173
  autoAssign: false
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: reserved-future
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.175-10.172.248.180
  autoAssign: false
EOF



ipaddresspool.metallb.io/ai-services-dev created
ipaddresspool.metallb.io/ai-services-test created
ipaddresspool.metallb.io/ai-services-prod created
ipaddresspool.metallb.io/reserved-future created



oc apply -f - <<EOF
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: l2-vlan1510
  namespace: metallb-system
spec:
  ipAddressPools:
    - ai-services-dev
    - ai-services-test
    - ai-services-prod
EOF




oc apply -f - <<EOF
apiVersion: v1
kind: Namespace
metadata:
  name: pai-dev
  labels:
    env: dev
    app.kubernetes.io/part-of: pai
---
apiVersion: v1
kind: Namespace
metadata:
  name: pai-test
  labels:
    env: test
    app.kubernetes.io/part-of: pai
---
apiVersion: v1
kind: Namespace
metadata:
  name: pai-prod
  labels:
    env: prod
    app.kubernetes.io/part-of: pai
EOF



oc apply -f - <<EOF
apiVersion: v1
kind: Service
metadata:
  name: nginx-test-lb
  namespace: pai-dev
  annotations:
    metallb.universe.tf/address-pool: ai-services-dev
    metallb.universe.tf/loadBalancerIPs: "10.172.248.160"
spec:
  type: LoadBalancer
  loadBalancerIP: "10.172.248.160"
  ports:
    - port: 80
      targetPort: 8080
  selector:
    app: nginx-test
EOF



NAME            TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
nginx-test-lb   LoadBalancer   172.30.37.234   <pending>     80:30808/TCP   45s
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ oc describe svc nginx-test-lb -n pai-dev | tail -20
Annotations:              metallb.universe.tf/address-pool: ai-services-dev
                          metallb.universe.tf/loadBalancerIPs: 10.172.248.160
Selector:                 app=nginx-test
Type:                     LoadBalancer
IP Family Policy:         SingleStack
IP Families:              IPv4
IP:                       172.30.37.234
IPs:                      172.30.37.234
Desired LoadBalancer IP:  10.172.248.160
Port:                     <unset>  80/TCP
TargetPort:               8080/TCP
NodePort:                 <unset>  30808/TCP
Endpoints:                10.129.0.154:8080
Session Affinity:         None
External Traffic Policy:  Cluster
Internal Traffic Policy:  Cluster
Events:
  Type     Reason            Age   From                Message
  ----     ------            ----  ----                -------
  Warning  AllocationFailed  72s   metallb-controller  Failed to allocate IP for "pai-dev/nginx-test-lb": service can not have both metallb.io/loadBalancerIPs and svc.Spec.LoadBalancerIP
hsuma@plnx-admin:~$



oc delete svc nginx-test-lb -n pai-dev

oc apply -f - <<EOF
apiVersion: v1
kind: Service
metadata:
  name: nginx-test-lb
  namespace: pai-dev
  annotations:
    metallb.universe.tf/address-pool: ai-services-dev
    metallb.universe.tf/loadBalancerIPs: "10.172.248.160"
spec:
  type: LoadBalancer
  ports:
    - port: 80
      targetPort: 8080
  selector:
    app: nginx-test
EOF


# Check which speaker owns the VIP
oc logs -l component=speaker -n metallb-system --tail=10

# Check if the endpoint is healthy
oc get endpoints nginx-test-lb -n pai-dev

# Try from a node directly
oc debug node/ocp-ai-master01.calix.local -- curl -s -o /dev/null -w "%{http_code}" http://10.172.248.160
=======


apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: pai-services-dev
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.160-10.172.248.163
  autoAssign: false
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: pai-services-test
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.165-10.172.248.168
  autoAssign: false
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: pai-services-prod
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.170-10.172.248.173
  autoAssign: false
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: reserved-future
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.175-10.172.248.180
  autoAssign: false






apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: l2-vlan1510
  namespace: metallb-system
spec:
  ipAddressPools:
    - pai-services-dev
    - pai-services-test
    - pai-services-prod


apiVersion: v1
kind: Namespace
metadata:
  name: pai-dev
  labels:
    env: dev
    app.kubernetes.io/part-of: pai
---
apiVersion: v1
kind: Namespace
metadata:
  name: pai-test
  labels:
    env: test
    app.kubernetes.io/part-of: pai
---
apiVersion: v1
kind: Namespace
metadata:
  name: pai-prod
  labels:
    env: prod
    app.kubernetes.io/part-of: pai



apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: metallb
  namespace: openshift-gitops
  labels:
    app.kubernetes.io/part-of: ocp-ai-platform
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: git@bitbucket.org:calixprod/ocp-ai-platform.git
    targetRevision: main
    path: ocp-ai-config/metallb
  destination:
    server: https://kubernetes.default.svc
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - ServerSideApply=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
```

Create those files, then:
```
cd ~/ocp-ai-platform
git add ocp-ai-config/metallb/
git commit -m "Task 6: MetalLB instance, IP pools, L2 advertisement, PAI namespaces"
git push origin main
```

Then apply the ArgoCD app:
```
oc apply -f ocp-ai-config/metallb/argocd-app-metallb.yaml

oc delete ipaddresspool ai-services-dev ai-services-test ai-services-prod reserved-future -n metallb-system

oc apply -f - <<EOF
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: pai-services-dev
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.160-10.172.248.163
  autoAssign: false
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: pai-services-test
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.165-10.172.248.168
  autoAssign: false
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: pai-services-prod
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.170-10.172.248.173
  autoAssign: false
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: reserved-future
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.175-10.172.248.180
  autoAssign: false
EOF


oc delete l2advertisement l2-vlan1510 -n metallb-system

oc apply -f - <<EOF
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: l2-vlan1510
  namespace: metallb-system
spec:
  ipAddressPools:
    - pai-services-dev
    - pai-services-test
    - pai-services-prod
EOF


