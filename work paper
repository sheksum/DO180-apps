hsuma@plnx-admin:~$ oc get pods -n metallb-system
NAME                                                   READY   STATUS    RESTARTS   AGE
metallb-operator-controller-manager-68b4948857-hn29n   1/1     Running   0          2m45s
metallb-operator-webhook-server-6c48f9b746-ln7vr       1/1     Running   0          2m45s


oc apply -f - <<EOF
apiVersion: metallb.io/v1beta1
kind: MetalLB
metadata:
  name: metallb
  namespace: metallb-system
spec:
  logLevel: warn
EOF


hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ oc get pods -n metallb-system -o wide
NAME                                                   READY   STATUS    RESTARTS   AGE     IP               NODE                          NOMINATED NODE   READINESS GATES
controller-fb7fcb695-ltvg5                             2/2     Running   0          44s     10.128.0.198     ocp-ai-master02.calix.local   <none>           <none>
metallb-operator-controller-manager-68b4948857-hn29n   1/1     Running   0          8m51s   10.129.0.150     ocp-ai-master01.calix.local   <none>           <none>
metallb-operator-webhook-server-6c48f9b746-ln7vr       1/1     Running   0          8m51s   10.129.0.151     ocp-ai-master01.calix.local   <none>           <none>
speaker-52dbz                                          2/2     Running   0          44s     10.172.248.152   ocp-ai-master03.calix.local   <none>           <none>
speaker-6wx7x                                          2/2     Running   0          44s     10.172.248.150   ocp-ai-master01.calix.local   <none>           <none>
speaker-k2cnq                                          2/2     Running   0          44s     10.172.248.151   ocp-ai-master02.calix.local   <none>           <none>


oc apply -f - <<EOF
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: ai-services-dev
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.160-10.172.248.163
  autoAssign: false
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: ai-services-test
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.165-10.172.248.168
  autoAssign: false
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: ai-services-prod
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.170-10.172.248.173
  autoAssign: false
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: reserved-future
  namespace: metallb-system
spec:
  addresses:
    - 10.172.248.175-10.172.248.180
  autoAssign: false
EOF



ipaddresspool.metallb.io/ai-services-dev created
ipaddresspool.metallb.io/ai-services-test created
ipaddresspool.metallb.io/ai-services-prod created
ipaddresspool.metallb.io/reserved-future created



oc apply -f - <<EOF
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: l2-vlan1510
  namespace: metallb-system
spec:
  ipAddressPools:
    - ai-services-dev
    - ai-services-test
    - ai-services-prod
EOF




oc apply -f - <<EOF
apiVersion: v1
kind: Namespace
metadata:
  name: pai-dev
  labels:
    env: dev
    app.kubernetes.io/part-of: pai
---
apiVersion: v1
kind: Namespace
metadata:
  name: pai-test
  labels:
    env: test
    app.kubernetes.io/part-of: pai
---
apiVersion: v1
kind: Namespace
metadata:
  name: pai-prod
  labels:
    env: prod
    app.kubernetes.io/part-of: pai
EOF



oc apply -f - <<EOF
apiVersion: v1
kind: Service
metadata:
  name: nginx-test-lb
  namespace: pai-dev
  annotations:
    metallb.universe.tf/address-pool: ai-services-dev
    metallb.universe.tf/loadBalancerIPs: "10.172.248.160"
spec:
  type: LoadBalancer
  loadBalancerIP: "10.172.248.160"
  ports:
    - port: 80
      targetPort: 8080
  selector:
    app: nginx-test
EOF



NAME            TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
nginx-test-lb   LoadBalancer   172.30.37.234   <pending>     80:30808/TCP   45s
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ oc describe svc nginx-test-lb -n pai-dev | tail -20
Annotations:              metallb.universe.tf/address-pool: ai-services-dev
                          metallb.universe.tf/loadBalancerIPs: 10.172.248.160
Selector:                 app=nginx-test
Type:                     LoadBalancer
IP Family Policy:         SingleStack
IP Families:              IPv4
IP:                       172.30.37.234
IPs:                      172.30.37.234
Desired LoadBalancer IP:  10.172.248.160
Port:                     <unset>  80/TCP
TargetPort:               8080/TCP
NodePort:                 <unset>  30808/TCP
Endpoints:                10.129.0.154:8080
Session Affinity:         None
External Traffic Policy:  Cluster
Internal Traffic Policy:  Cluster
Events:
  Type     Reason            Age   From                Message
  ----     ------            ----  ----                -------
  Warning  AllocationFailed  72s   metallb-controller  Failed to allocate IP for "pai-dev/nginx-test-lb": service can not have both metallb.io/loadBalancerIPs and svc.Spec.LoadBalancerIP
hsuma@plnx-admin:~$



oc delete svc nginx-test-lb -n pai-dev

oc apply -f - <<EOF
apiVersion: v1
kind: Service
metadata:
  name: nginx-test-lb
  namespace: pai-dev
  annotations:
    metallb.universe.tf/address-pool: ai-services-dev
    metallb.universe.tf/loadBalancerIPs: "10.172.248.160"
spec:
  type: LoadBalancer
  ports:
    - port: 80
      targetPort: 8080
  selector:
    app: nginx-test
EOF


# Check which speaker owns the VIP
oc logs -l component=speaker -n metallb-system --tail=10

# Check if the endpoint is healthy
oc get endpoints nginx-test-lb -n pai-dev

# Try from a node directly
oc debug node/ocp-ai-master01.calix.local -- curl -s -o /dev/null -w "%{http_code}" http://10.172.248.160


hsuma@plnx-admin:~$ oc logs -l component=speaker -n metallb-system --tail=10
Defaulted container "speaker" out of: speaker, kube-rbac-proxy
Defaulted container "speaker" out of: speaker, kube-rbac-proxy
Defaulted container "speaker" out of: speaker, kube-rbac-proxy
{"caller":"announcer.go:131","error":"creating NDP responder for \"d4e9f9ac00cf7bb\": listen ip6:ipv6-icmp fe80::f484:9ff:fe96:49e2%d4e9f9ac00cf7bb: bind: cannot assign requested address","interface":"d4e9f9ac00cf7bb","level":"error","msg":"failed to create NDP responder","op":"createNDPResponder","ts":"2026-02-26T03:00:00Z"}
{"caller":"speakerlist.go:269","error":null,"expected":2,"joined":1,"level":"error","msg":"partial join","op":"memberDiscovery","ts":"2026-02-26T02:43:07Z"}
{"caller":"speakerlist.go:269","error":"1 error occurred:\n\t* Failed to join 10.172.248.152:9122: dial tcp 10.172.248.152:9122: connect: connection refused\n\n","expected":1,"joined":0,"level":"error","msg":"partial join","op":"memberDiscovery","ts":"2026-02-26T02:43:07Z"}
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ oc get endpoints nginx-test-lb -n pai-dev
Warning: v1 Endpoints is deprecated in v1.33+; use discovery.k8s.io/v1 EndpointSlice
NAME            ENDPOINTS           AGE
nginx-test-lb   10.129.0.154:8080   2m46s
hsuma@plnx-admin:~$ oc debug node/ocp-ai-master01.calix.local -- curl -s -o /dev/null -w "%{http_code}" http://10.172.248.160
Starting pod/ocp-ai-master01calixlocal-debug-qnld9 ...
To use host binaries, run `chroot /host`. Instead, if you need to access host namespaces, run `nsenter -a -t 1`.
403
Removing debug pod ...
hsuma@plnx-admin:~$


hsuma@plnx-admin:~$ arping -c 10.172.248.160
ARPing 2.22, by Thomas Habets <thomas@habets.se>
usage: arping [ -0aAbdDeFpPqrRuUv ] [ -w <sec> ] [ -W <sec> ] [ -S <host/ip> ]
              [ -T <host/ip ] [ -s <MAC> ] [ -t <MAC> ] [ -c <count> ]
              [ -C <count> ] [ -i <interface> ] [ -m <type> ] [ -g <group> ]
              [ -V <vlan> ] [ -Q <priority> ] <host/ip/MAC | -B>
For complete usage info, use --help or check the manpage.
hsuma@plnx-admin:~$
