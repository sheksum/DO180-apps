services:
  registry:
    image: registry:2
    container_name: registry
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY: /var/lib/registry
      REGISTRY_STORAGE_DELETE_ENABLED: "true"
    volumes:
      - /opt/registry/data:/var/lib/registry

  registry-ui:
    image: konradkleine/docker-registry-frontend:v2
    container_name: registry-ui
    restart: unless-stopped
    ports:
      - "8080:80"
    environment:
      ENV_DOCKER_REGISTRY_HOST: plnx-ai-registry.calix.local
      ENV_DOCKER_REGISTRY_PORT: 5000
    depends_on:
      - registry

  dex:
    image: ghcr.io/dexidp/dex:v2.39.1
    container_name: dex
    restart: unless-stopped
    command: ["dex", "serve", "/etc/dex/config.yaml"]
    volumes:
      - /opt/registry/dex/config.yaml:/etc/dex/config.yaml:ro
      - /opt/registry/dex/dex.db:/var/dex/dex.db
      - /etc/ssl/certs:/etc/ssl/certs:ro
    depends_on:
      - registry

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    container_name: oauth2-proxy
    restart: unless-stopped
    command:
      - --http-address=0.0.0.0:4180
      - --provider=oidc
      - --oidc-issuer-url=https://plnx-ai-registry.calix.local/dex
      - --redirect-url=https://plnx-ai-registry.calix.local/oauth2/callback
      - --email-domain=*
      - --scope=openid email profile groups
      - --cookie-secure=true
      - --cookie-samesite=lax
      - --cookie-refresh=1h
      - --cookie-expire=8h
      - --set-xauthrequest=true
      - --pass-authorization-header=true
      - --skip-provider-button=true
      - --oidc-groups-claim=groups
      - --upstream=static://200
    environment:
      OAUTH2_PROXY_CLIENT_ID: registry-ui
      OAUTH2_PROXY_CLIENT_SECRET: CHANGE_ME__OAUTH2_PROXY_CLIENT_SECRET
      OAUTH2_PROXY_COOKIE_SECRET: CHANGE_ME__COOKIE_SECRET
    depends_on:
      - dex

  nginx-ui-proxy:
    image: nginx:stable
    container_name: nginx-ui-proxy
    restart: unless-stopped
    ports:
      - "443:443"
    volumes:
      - /opt/registry/certs:/etc/nginx/certs:ro
      - /opt/registry/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - registry-ui
      - oauth2-proxy
      - dex