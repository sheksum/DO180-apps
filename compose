services:
  registry:
    image: registry:2
    container_name: registry
    ports:
      - "5000:5000"
    environment:
      REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY: /var/lib/registry
      REGISTRY_STORAGE_DELETE_ENABLED: "true"
    volumes:
      - /opt/registry/data:/var/lib/registry

  registry-ui:
    image: konradkleine/docker-registry-frontend:v2
    container_name: registry-ui
    ports:
      - "8080:80"
    environment:
      ENV_DOCKER_REGISTRY_HOST: plnx-ai-registry.calix.local
      ENV_DOCKER_REGISTRY_PORT: 5000
    depends_on:
      - registry
    volumes:
      - /etc/hosts:/etc/hosts:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro

  oauth2-proxy:
    image: bitnami/oauth2-proxy:latest
    container_name: oauth2-proxy
    ports:
      - "4180:4180"
    environment:
      OAUTH2_PROXY_PROVIDER: ldap
      OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:4180

      # ---- LDAP / IPA ----
      OAUTH2_PROXY_LDAP_URL: "ldaps://cpeg-ipareplica.ipa.calix.local:636"
      OAUTH2_PROXY_LDAP_BIND_DN: "uid=svc_nginx_registry,cn=users,cn=accounts,dc=ipa,dc=calix,dc=local"
      OAUTH2_PROXY_LDAP_BIND_PASSWORD: "school1"
      OAUTH2_PROXY_LDAP_BASE_DN: "dc=ipa,dc=calix,dc=local"
      OAUTH2_PROXY_LDAP_USER_SEARCH_FILTER: "(uid={username})"

      # Optional: restrict to group
      OAUTH2_PROXY_LDAP_GROUP_SEARCH_BASE_DN: "cn=groups,cn=accounts,dc=ipa,dc=calix,dc=local"
      OAUTH2_PROXY_LDAP_GROUP_SEARCH_FILTER: "(member={dn})"
      OAUTH2_PROXY_ALLOWED_GROUPS: "cn=docker-registry-users,cn=groups,cn=accounts,dc=ipa,dc=calix,dc=local"

      # ---- oauth2-proxy basics ----
      OAUTH2_PROXY_COOKIE_SECRET: "REPLACE_WITH_32_BYTE_BASE64"
      OAUTH2_PROXY_COOKIE_SECURE: "true"
      OAUTH2_PROXY_COOKIE_HTTPONLY: "true"
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "true"
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"

    depends_on:
      - registry

  nginx-ui-proxy:
    image: nginx:stable
    container_name: nginx-ui-proxy
    ports:
      - "443:443"
    volumes:
      - /opt/registry/certs:/etc/nginx/certs:ro
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - registry
      - registry-ui
      - oauth2-proxy