---
- name: Deploy and trust Calix Root CA certificates
  hosts: all
  become: yes
  vars:
    cert_src_dir: /tmp/certs       # location on plnx-admin
    ubuntu_cert_dir: /usr/local/share/ca-certificates
    rhel_cert_dir: /etc/pki/ca-trust/source/anchors
    test_url: https://pln-stash.calix.local

  tasks:
    - name: Clean up old certs on Ubuntu (keep ipa*)
      ansible.builtin.shell: |
        find {{ ubuntu_cert_dir }} -type f ! -name "ipa*" -delete
      when: ansible_os_family == "Debian"

    - name: Clean up old certs on RHEL (keep ipa*)
      ansible.builtin.shell: |
        find {{ rhel_cert_dir }} -type f ! -name "ipa*" -delete
      when: ansible_os_family == "RedHat"

    - name: Copy new certificates to Ubuntu
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: "{{ ubuntu_cert_dir }}/"
        owner: root
        group: root
        mode: '0644'
      with_fileglob:
        - "{{ cert_src_dir }}/*.crt"
      when: ansible_os_family == "Debian"
      notify:
        - Update trust store on Debian/Ubuntu
        - Validate HTTPS
        - Show response headers

    - name: Copy new certificates to RHEL
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: "{{ rhel_cert_dir }}/"
        owner: root
        group: root
        mode: '0644'
      with_fileglob:
        - "{{ cert_src_dir }}/*.crt"
      when: ansible_os_family == "RedHat"
      notify:
        - Update trust store on RHEL/CentOS
        - Validate HTTPS
        - Show response headers

  handlers:
    - name: Update trust store on Debian/Ubuntu
      ansible.builtin.command: update-ca-certificates -f
      when: ansible_os_family == "Debian"
      changed_when: true

    - name: Update trust store on RHEL/CentOS
      ansible.builtin.command: update-ca-trust extract
      when: ansible_os_family == "RedHat"
      changed_when: true

    - name: Validate HTTPS
      ansible.builtin.command: curl -sS --fail -I "{{ test_url }}"
      register: curl_head
      changed_when: false
      failed_when: curl_head.rc != 0

    - name: Show response headers
      ansible.builtin.debug:
        var: curl_head.stdout_lines
