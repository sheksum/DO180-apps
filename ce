#!/usr/bin/env bash
# seed-users-nssdb-min.sh
# Usage: sudo ./seed-users-nssdb-min.sh /path/to/users.txt

USERS_FILE="${1:?Provide users file}"

CA_ROOT="/usr/local/share/ca-certificates/CalixROOTCA.crt"
CA_INT2="/usr/local/share/ca-certificates/CalixInterCA2.crt"
CA_INT1="/usr/local/share/ca-certificates/CalixInterCA1.crt"

ts() { date +%Y%m%d-%H%M%S; }

while IFS= read -r u; do
  [[ -z "${u// }" || "$u" =~ ^# ]] && continue

  HOME_DIR="$(getent passwd "$u" | cut -d: -f6)"
  [[ -z "$HOME_DIR" || ! -d "$HOME_DIR" ]] && { echo "Skip $u (no home)"; continue; }

  echo "=== [$u] $HOME_DIR"

  # Rename per-user Chrome config/cache and .local
  [[ -d "$HOME_DIR/.config/google-chrome" ]] && mv "$HOME_DIR/.config/google-chrome" "$HOME_DIR/.config/google-chrome.bak.$(ts)"
  [[ -d "$HOME_DIR/.cache/google-chrome"  ]] && mv "$HOME_DIR/.cache/google-chrome"  "$HOME_DIR/.cache/google-chrome.bak.$(ts)"
  [[ -d "$HOME_DIR/.local"                ]] && mv "$HOME_DIR/.local"                "$HOME_DIR/.local.bak.$(ts)"

  # Kill Chrome processes for this user (if any)
  pkill -9 -u "$u" chrome 2>/dev/null || true

  # Reset NSS DB
  DB="$HOME_DIR/.pki/nssdb"
  [[ -d "$DB" ]] && mv "$DB" "$HOME_DIR/.pki/nssdb.backup.$(ts)"
  sudo -u "$u" mkdir -p "$DB"
  sudo -u "$u" certutil -d "sql:$DB" -N --empty-password

  # Import CAs
  sudo -u "$u" certutil -d "sql:$DB" -A -t "C,," -n "calixRootCA"   -i "$CA_ROOT"
  sudo -u "$u" certutil -d "sql:$DB" -A -t "C,," -n "calixInterCA2" -i "$CA_INT2"
  sudo -u "$u" certutil -d "sql:$DB" -A -t "C,," -n "calixEntCA"    -i "$CA_INT1"

  # Verify
  sudo -u "$u" certutil -d "sql:$DB" -L || true

  echo "=== [$u] done"
  echo
done < "$USERS_FILE"

echo "Complete. Users can log back in and relaunch Chrome."
