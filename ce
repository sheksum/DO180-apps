#!/bin/bash
# hosts.txt = list of servers (one per line)

HOSTS_FILE="hosts.txt"
SSH_USER="deploy"

DEBIAN_DIR="/usr/local/share/ca-certificates"
RHEL_DIR="/etc/pki/ca-trust/source/anchors"
CERTS=("CalixROOTCA.crt" "CalixInterCA1.crt" "CalixInterCA2.crt")

LOGFILE="verify_failures.log"
: > "$LOGFILE"   # truncate log file

for host in $(cat "$HOSTS_FILE"); do
  echo ">>> $host"

  # detect OS family
  OS=$(ssh -o BatchMode=yes -o ConnectTimeout=5 $SSH_USER@$host 'grep "^ID=" /etc/os-release' 2>/dev/null)

  if [[ "$OS" == *"ubuntu"* || "$OS" == *"debian"* ]]; then
    CA_DIR=$DEBIAN_DIR
  else
    CA_DIR=$RHEL_DIR
  fi

  # check certs
  for c in "${CERTS[@]}"; do
    if ssh $SSH_USER@$host "[ -f $CA_DIR/$c ]"; then
      echo "  OK: $CA_DIR/$c"
    else
      echo "  MISSING: $CA_DIR/$c"
      echo "$host - missing $CA_DIR/$c" >> "$LOGFILE"
    fi
  done

  # quick curl probe
  if ssh $SSH_USER@$host "curl -sS -I https://pln-stash.calix.local >/dev/null 2>&1"; then
    echo "  HTTPS OK"
  else
    echo "  HTTPS FAIL"
    echo "$host - HTTPS trust failed" >> "$LOGFILE"
  fi
done

echo
echo "Failures logged to $LOGFILE"
