- hosts: localhost
  collections: [paloaltonetworks.panos]
  vars: { provider: { hostname: "{{ pan_host }}", username: "{{ pan_user }}", password: "{{ pan_pass }}" } }
  tasks:
    - name: Build list locally
      command: bash -lc "python3 /home/deploy/get_ips.py | sort -V | uniq"
      register: cidrs
    - name: Ensure address objects
      loop: "{{ cidrs.stdout_lines }}"
      panos_address_object:
        provider: "{{ provider }}"
        name: "atlassian-{{ item | regex_replace('/','_') }}"
        value: "{{ item }}"
    - name: Address group (static) referencing all objects
      panos_address_group:
        provider: "{{ provider }}"
        name: "ag-atlassian-bitbucket"
        static_value: "{{ cidrs.stdout_lines | map('regex_replace','/','_') | map('regex_replace','^','atlassian-') | list }}"
        commit: true
