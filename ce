#!/bin/bash

echo "Checking for expired certificates in Kubernetes..."

# Get all namespaces
namespaces=$(kubectl get ns --no-headers -o custom-columns=":metadata.name")

# Current date (Epoch time)
current_date=$(date +%s)

# Iterate over namespaces
for ns in $namespaces; do
    # Get all TLS secrets in the namespace
    secrets=$(kubectl get secrets -n $ns --no-headers -o custom-columns=":metadata.name" | grep -E "tls|cert" || true)

    for secret in $secrets; do
        # Extract and decode the TLS certificate
        kubectl get secret $secret -n $ns -o jsonpath="{.data['tls\.crt']}" | base64 --decode > /tmp/tls.crt 2>/dev/null

        if [ -s /tmp/tls.crt ]; then
            # Extract expiration date in epoch format
            cert_expiry=$(openssl x509 -in /tmp/tls.crt -noout -enddate | cut -d= -f2)
            cert_expiry_epoch=$(date -d "$cert_expiry" +%s 2>/dev/null || date -j -f "%b %d %T %Y %Z" "$cert_expiry" +%s)

            # Compare with current date
            if [[ "$cert_expiry_epoch" -lt "$current_date" ]]; then
                echo "‚ùå Expired certificate found!"
                echo "   Namespace: $ns"
                echo "   Secret: $secret"
                echo "   Expired on: $cert_expiry"
                echo "-----------------------------------"
            fi
        fi
    done
done

# Cleanup
rm -f /tmp/tls.crt
echo "Expired certificate check complete."
