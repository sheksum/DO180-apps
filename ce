#!/bin/bash
set -euo pipefail

HOSTS_FILE="${HOSTS_FILE:-centos7.txt}"   # list of CentOS 7 hosts (one per line)
SSH_USER="${SSH_USER:-deploy}"            # remote user
SSH_KEY="${SSH_KEY:-$HOME/.ssh/id_rsa}"   # private key path
CERTS_DIR="${CERTS_DIR:-./files}"         # directory on controller with .crt files
LOGFILE="${LOGFILE:-push_certs_failures.log}"

SSH_OPTS=(-i "$SSH_KEY" -o BatchMode=yes -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -o ConnectTimeout=6)

: > "$LOGFILE"

for host in $(cat "$HOSTS_FILE"); do
  echo ">>> $host"

  # copy certs
  for crt in "$CERTS_DIR"/*.crt; do
    if scp "${SSH_OPTS[@]}" "$crt" "${SSH_USER}@${host}:/tmp/"; then
      ssh "${SSH_OPTS[@]}" "${SSH_USER}@${host}" "sudo mv /tmp/$(basename "$crt") /etc/pki/ca-trust/source/anchors/ && sudo chmod 644 /etc/pki/ca-trust/source/anchors/$(basename "$crt")"
      echo "  OK: pushed $(basename "$crt")"
    else
      echo "  FAIL: copy $(basename "$crt")" | tee -a "$LOGFILE"
    fi
  done

  # refresh trust store
  if ssh "${SSH_OPTS[@]}" "${SSH_USER}@${host}" "sudo update-ca-trust extract"; then
    echo "  OK: trust updated"
  else
    echo "  FAIL: update-ca-trust" | tee -a "$LOGFILE"
  fi

done

echo
echo "Failures logged to $LOGFILE"
