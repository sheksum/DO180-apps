---
- name: Deploy Calix Root + Intermediates and refresh trust
  hosts: all
  become: yes
  vars:
    ubuntu_dir: /usr/local/share/ca-certificates
    rhel_dir: /etc/pki/ca-trust/source/anchors
    calix_certs:
      - CalixROOTCA.crt
      - CalixInterCA1.crt
      - CalixInterCA2.crt

  tasks:
    - name: Pick CA directory based on OS family
      set_fact:
        ca_dir: "{{ (ansible_os_family == 'RedHat') | ternary(rhel_dir, ubuntu_dir) }}"

    - name: Clean out old non-IPA certs from CA dir
      shell: |
        shopt -s nullglob
        for f in "{{ ca_dir }}"/*.crt; do
          base="$(basename "$f")"
          [[ "$base" == ipa* ]] || rm -f "$f"
        done
      args:
        executable: /bin/bash

    - name: Copy Calix certs into CA dir
      copy:
        src: "files/{{ item }}"
        dest: "{{ ca_dir }}/{{ item }}"
        owner: root
        group: root
        mode: '0644'
      loop: "{{ calix_certs }}"

    - name: Refresh trust store on Ubuntu/Debian
      command: update-ca-certificates
      when: ansible_os_family != 'RedHat'

    - name: Refresh trust store on RHEL/CentOS
      command: update-ca-trust extract
      when: ansible_os_family == 'RedHat'
