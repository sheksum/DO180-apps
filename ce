#!/usr/bin/env bash
# seed-users-nssdb-min.sh
# Usage: sudo ./seed-users-nssdb-min.sh /path/to/users.txt

USERS_FILE="${1:?Provide users file}"

CA_ROOT="/usr/local/share/ca-certificates/CalixROOTCA.crt"
CA_INT2="/usr/local/share/ca-certificates/CalixInterCA2.crt"
CA_INT1="/usr/local/share/ca-certificates/CalixInterCA1.crt"

ts() { date +%Y%m%d-%H%M%S; }

while IFS= read -r u; do
  [[ -z "${u// }" || "$u" =~ ^# ]] && continue

  HOME_DIR="/home/$u"
  echo "=== [$u] $HOME_DIR"

  # Rename per-user Chrome config/cache and .local AS THE USER (preserve ownership)
  sudo -u "$u" bash -lc '[[ -d ~/.config/google-chrome ]] && mv ~/.config/google-chrome ~/.config/google-chrome.bak.'"$(ts)"
  sudo -u "$u" bash -lc '[[ -d ~/.cache/google-chrome  ]] && mv ~/.cache/google-chrome  ~/.cache/google-chrome.bak.'"$(ts)"
  sudo -u "$u" bash -lc '[[ -d ~/.local               ]] && mv ~/.local               ~/.local.bak.'"$(ts)"

  # Kill Chrome processes for this user (if any)
  pkill -9 -u "$u" chrome 2>/dev/null || true

  # Reset NSS DB AS THE USER
  DB="$HOME_DIR/.pki/nssdb"
  sudo -u "$u" bash -lc '[[ -d ~/.pki/nssdb ]] && mv ~/.pki/nssdb ~/.pki/nssdb.backup.'"$(ts)"
  sudo -u "$u" mkdir -p "$DB"
  sudo -u "$u" certutil -d "sql:$DB" -N --empty-password

  # Import CAs AS THE USER (your labels/flags)
  sudo -u "$u" certutil -d "sql:$DB" -A -t "C,," -n "calixRootCA"   -i "$CA_ROOT"
  sudo -u "$u" certutil -d "sql:$DB" -A -t "C,," -n "calixInterCA2" -i "$CA_INT2"
  sudo -u "$u" certutil -d "sql:$DB" -A -t "C,," -n "calixEntCA"    -i "$CA_INT1"

  # Verify
  sudo -u "$u" certutil -d "sql:$DB" -L || true

  echo "=== [$u] done"
  echo
done < "$USERS_FILE"

echo "Complete. Users can relaunch Chrome."
