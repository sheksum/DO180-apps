#!/usr/bin/env bash
set -euo pipefail

# Configuration
NETAPP_API="https://plano_aff_cl.calix.local/api"
NETAPP_CREDS="svc_lifecycle:d94def47f1dd637527028656aac69359bfb1f6492cf03c1198b142686fa7e98c"

# Volume UUIDs for all three locations
LAB_UNIX_VOL_UUID="3825009b-5037-11ef-8de2-d039eabbae46"
SD_UNIX_VOL_UUID="48168c4e-5f32-11ef-8de2-d039eabbae46"
SD_DATA_VOL_UUID="a3d2d97a-5f58-11ef-9179-d039eabb831f"

NETAPP_MOUNT_SERVER="plnx-admin.caal.dev"
NETAPP_MOUNT_SSH_KEY="$HOME/.ssh/netapp_mount_key"
IPA_KEYTAB="/etc/krb5/ipa_svc.keytab"
IPA_PRINCIPAL="svc_user_lifecycle"
LOG_FILE="/var/log/user_offboard.log"
DRY_RUN="false"

# Functions
log() { echo "$(date '+%F %T') [$1] $USER_ID - $2" | tee -a "$LOG_FILE"; }

check_kerberos() {
    klist -s 2>/dev/null || kinit -kt "$IPA_KEYTAB" "$IPA_PRINCIPAL" || {
        log "ERROR" "Kerberos authentication failed"
        exit 1
    }
}

find_user() {
    local search="$1"
    # Try direct lookup first
    ipa user-show "$search" &>/dev/null && echo "$search" && return
    # Try by full name
    local uid=$(ipa user-find --cn="$search" --raw 2>/dev/null | grep "^  uid:" | head -1 | awk '{print $2}')
    [[ -n "$uid" ]] && echo "$uid" && return
    return 1
}

check_netapp_home() {
    local user="$1"
    
    # Check lab_unix_homes  
    local lab_code=$(curl -sk -o /dev/null -w "%{http_code}" -u "$NETAPP_CREDS" \
        "${NETAPP_API}/storage/volumes/${LAB_UNIX_VOL_UUID}/files/${user}?return_metadata=true")
    
    # Check sd_unix_homes
    local sd_unix_code=$(curl -sk -o /dev/null -w "%{http_code}" -u "$NETAPP_CREDS" \
        "${NETAPP_API}/storage/volumes/${SD_UNIX_VOL_UUID}/files/${user}?return_metadata=true")
    
    # Check sd_data
    local sd_data_code=$(curl -sk -o /dev/null -w "%{http_code}" -u "$NETAPP_CREDS" \
        "${NETAPP_API}/storage/volumes/${SD_DATA_VOL_UUID}/files/${user}?return_metadata=true")
    
    # Return true/false without logging here
    if [[ "$lab_code" == "200" ]] || [[ "$sd_unix_code" == "200" ]] || [[ "$sd_data_code" == "200" ]]; then
        echo "true"
    else
        echo "false"
    fi
}

log_netapp_locations() {
    local user="$1"
    local locations_found=()
    
    # Check and log each location
    local lab_code=$(curl -sk -o /dev/null -w "%{http_code}" -u "$NETAPP_CREDS" \
        "${NETAPP_API}/storage/volumes/${LAB_UNIX_VOL_UUID}/files/${user}?return_metadata=true")
    
    local sd_unix_code=$(curl -sk -o /dev/null -w "%{http_code}" -u "$NETAPP_CREDS" \
        "${NETAPP_API}/storage/volumes/${SD_UNIX_VOL_UUID}/files/${user}?return_metadata=true")
    
    local sd_data_code=$(curl -sk -o /dev/null -w "%{http_code}" -u "$NETAPP_CREDS" \
        "${NETAPP_API}/storage/volumes/${SD_DATA_VOL_UUID}/files/${user}?return_metadata=true")
    
    # Log detailed findings
    if [[ "$lab_code" == "200" ]]; then
        log "INFO" "Home directory found in: lab_unix_homes"
        locations_found+=("lab_unix_homes")
    fi
    
    if [[ "$sd_unix_code" == "200" ]]; then
        log "INFO" "Home directory found in: sd_unix_homes"  
        locations_found+=("sd_unix_homes")
    fi
    
    if [[ "$sd_data_code" == "200" ]]; then
        log "INFO" "Home directory found in: sd_data"
        locations_found+=("sd_data")
    fi
    
    # Summary log
    if [[ ${#locations_found[@]} -gt 0 ]]; then
        log "INFO" "Total locations with home directories: ${#locations_found[@]} (${locations_found[*]})"
    else
        log "INFO" "No home directories found in any location"
    fi
}

# Main
USER_ID=""
[[ "$1" == "--dry-run" ]] && DRY_RUN="true" && shift
USER_ID="$1"
[[ -z "$USER_ID" ]] && { echo "Usage: $0 <username> [--dry-run]"; exit 1; }

log "INFO" "Starting offboard: $USER_ID"
[[ "$DRY_RUN" == "true" ]] && log "INFO" "DRY-RUN MODE"

# Step 1: Authenticate
check_kerberos

# Step 2: Find user (continue even if not found)
log "INFO" "Finding user in IPA"
FOUND_USER=$(find_user "$USER_ID" 2>/dev/null) || true

if [[ -n "$FOUND_USER" ]]; then
    if [[ "$FOUND_USER" != "$USER_ID" ]]; then
        log "INFO" "Resolved '$USER_ID' to IPA username: $FOUND_USER"
        USER_ID="$FOUND_USER"
    fi
    log "OK" "User found in IPA: $USER_ID"
    IPA_USER_EXISTS="true"
else
    log "WARN" "User not found in IPA: $USER_ID"
    IPA_USER_EXISTS="false"
fi

# Step 3: Check NetApp home directories across all locations
log "INFO" "Checking NetApp home directories across all locations"
log_netapp_locations "$USER_ID"
HAS_HOME=$(check_netapp_home "$USER_ID")
log "OK" "NetApp home directory scan complete"

# Step 4: Disable user (only if exists in IPA)
if [[ "$IPA_USER_EXISTS" == "true" ]]; then
    log "INFO" "Disabling IPA user"
    if [[ "$DRY_RUN" == "true" ]]; then
        log "INFO" "[DRY-RUN] Would disable user"
    else
        ipa user-disable "$USER_ID" &>/dev/null && log "OK" "User disabled" || log "WARN" "Disable failed"
    fi
else
    log "INFO" "Skipping IPA disable - user not found in IPA"
fi

# Step 5: Delete user (only if exists in IPA)
if [[ "$IPA_USER_EXISTS" == "true" ]]; then
    log "INFO" "Deleting IPA user"
    if [[ "$DRY_RUN" == "true" ]]; then
        log "INFO" "[DRY-RUN] Would delete user"
    else
        ipa user-del "$USER_ID" &>/dev/null && log "OK" "User deleted" || log "ERROR" "Delete failed"
    fi
else
    log "INFO" "Skipping IPA delete - user not found in IPA"
fi

# Step 6: Quarantine NetApp home directories from all locations
if [[ "$HAS_HOME" == "true" ]]; then
    if [[ "$IPA_USER_EXISTS" == "false" ]]; then
        log "INFO" "Found orphaned home directories - proceeding with quarantine"
    fi
    log "INFO" "Quarantining NetApp home directories"
    if [[ "$DRY_RUN" == "true" ]]; then
        log "INFO" "[DRY-RUN] Would quarantine homes from all locations"
    else
        timestamp=$(date +%F_%H%M%S)
        
        # Check and quarantine from lab_unix_homes
        result=$(ssh -i ${NETAPP_MOUNT_SSH_KEY} -o BatchMode=yes root@${NETAPP_MOUNT_SERVER} \
            "if [[ -d '/na/plnaff/unix_homes/lab_unix_homes/${USER_ID}' ]]; then \
                mv '/na/plnaff/unix_homes/lab_unix_homes/${USER_ID}' \
                   '/na/plnaff/unix_homes/lab_unix_homes/_decommissioned-lab-unix-homes/${USER_ID}_${timestamp}' \
                && echo 'SUCCESS-LAB: Home quarantined from lab_unix_homes' \
                || echo 'ERROR-LAB: Failed to quarantine from lab_unix_homes'; \
             else \
                echo 'NOTFOUND-LAB: No home in lab_unix_homes'; \
             fi" 2>&1)
        
        # Check and quarantine from sd_data  
        result2=$(ssh -i ${NETAPP_MOUNT_SSH_KEY} -o BatchMode=yes root@${NETAPP_MOUNT_SERVER} \
            "if [[ -d '/na/plnaff/sd_data/${USER_ID}' ]]; then \
                mv '/na/plnaff/sd_data/${USER_ID}' \
                   '/na/plnaff/sd_data/_decommissioned-sd-data/${USER_ID}_${timestamp}' \
                && echo 'SUCCESS-SD-DATA: Home quarantined from sd_data' \
                || echo 'ERROR-SD-DATA: Failed to quarantine from sd_data'; \
             else \
                echo 'NOTFOUND-SD-DATA: No home in sd_data'; \
             fi" 2>&1)
        
        # Check and quarantine from sd_unix_homes
        result3=$(ssh -i ${NETAPP_MOUNT_SSH_KEY} -o BatchMode=yes root@${NETAPP_MOUNT_SERVER} \
            "if [[ -d '/na/plnaff/unix_homes/sd_unix_homes/${USER_ID}' ]]; then \
                mv '/na/plnaff/unix_homes/sd_unix_homes/${USER_ID}' \
                   '/na/plnaff/unix_homes/sd_unix_homes/_decommissioned-sd-unix-homes/${USER_ID}_${timestamp}' \
                && echo 'SUCCESS-SD-UNIX: Home quarantined from sd_unix_homes' \
                || echo 'ERROR-SD-UNIX: Failed to quarantine from sd_unix_homes'; \
             else \
                echo 'NOTFOUND-SD-UNIX: No home in sd_unix_homes'; \
             fi" 2>&1)
        
        # Log all results
        for result_msg in "$result" "$result2" "$result3"; do
            if echo "$result_msg" | grep -q "SUCCESS-"; then
                log "OK" "$(echo "$result_msg" | sed 's/SUCCESS-[A-Z-]*: //')"
            elif echo "$result_msg" | grep -q "ERROR-"; then
                log "ERROR" "$(echo "$result_msg" | sed 's/ERROR-[A-Z-]*: //')"
            fi
        done
    fi
else
    log "INFO" "No NetApp home directories to quarantine"
fi

log "OK" "Offboard complete: $USER_ID"
