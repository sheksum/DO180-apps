#!/usr/bin/env bash
# seed-two-users-nssdb.sh
# Your original flow, with just the pre-renames you requested.

USERS=("bwing")   # <-- replace with real logins

for u in "${USERS[@]}"; do
  HOME_DIR=$(getent passwd "$u" | cut -d: -f6 || true)
  [[ -z "$HOME_DIR" || ! -d "$HOME_DIR" ]] && { echo "Skip $u (no home)"; continue; }

  # --- PRE: rename per-user Chrome config/cache and .local ---
  [ -d "$HOME_DIR/.config/google-chrome" ] && mv "$HOME_DIR/.config/google-chrome" "$HOME_DIR/.config/google-chrome.bak"
  [ -d "$HOME_DIR/.cache/google-chrome"  ] && mv "$HOME_DIR/.cache/google-chrome"  "$HOME_DIR/.cache/google-chrome.bak"
  [ -d "$HOME_DIR/.local"                ] && mv "$HOME_DIR/.local"                "$HOME_DIR/.local.bak"

  DB="$HOME_DIR/.pki/nssdb"

  # Backup old NSS DB if present
  if [ -d "$DB" ]; then
    mv "$DB" "$HOME_DIR/.pki/nssdb.backup"
    echo "[$u] backup of nssdb created"
  fi

  # Recreate DB with empty password
  sudo -u "$u" mkdir -p "$DB"
  sudo -u "$u" certutil -d "sql:$DB" -N --empty-password

  # --- Your original CA imports (unchanged labels/paths/flags) ---
  sudo -u "$u" certutil -d "sql:$DB" -A -t "C,," -n "calixRootCA"   -i /usr/local/share/ca-certificates/CalixROOTCA.crt
  sudo -u "$u" certutil -d "sql:$DB" -A -t "C,," -n "calixInterCA"  -i /usr/local/share/ca-certificates/CalixInterCA2.crt
  sudo -u "$u" certutil -d "sql:$DB" -A -t "C,," -n "calixEntCA"    -i /usr/local/share/ca-certificates/CalixInterCA1.crt

  # Verify (optional)
  sudo -u "$u" certutil -d "sql:$DB" -L
done
