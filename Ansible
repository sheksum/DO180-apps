#!/bin/bash

HOST_FILE="hosts.txt"
REMOTE_SCRIPT="/tmp/kill-ansible.sh"
LOG_FILE="kill-ansible.log"

# Build the remote script
cat << 'EOF' > $REMOTE_SCRIPT
#!/bin/bash
echo "[$(hostname)] Killing Ansible-related processes..."
sudo pkill -f ansible-playbook
sudo pkill -f sshpass
sudo pkill -f 'ssh -o ControlMaster'
echo "[$(hostname)] Cleanup complete."
EOF

chmod +x $REMOTE_SCRIPT

# Loop through hosts
while IFS= read -r HOST; do
  [[ -z "$HOST" || "$HOST" == \#* ]] && continue
  echo ">>> Running on $HOST"

  scp -o ConnectTimeout=10 -o StrictHostKeyChecking=no $REMOTE_SCRIPT deploy@$HOST:$REMOTE_SCRIPT \
    && ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no deploy@$HOST "bash $REMOTE_SCRIPT && rm -f $REMOTE_SCRIPT" \
    >> $LOG_FILE 2>&1 \
    || echo "[ERROR] Failed on $HOST" >> $LOG_FILE

done < "$HOST_FILE"

echo "Finished. See $LOG_FILE for output and errors."
