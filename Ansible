#!/bin/bash

REMOTE_SCRIPT="/tmp/kill-ansible.sh"

# The script to be executed remotely
cat << 'EOF' > $REMOTE_SCRIPT
#!/bin/bash
echo "[$(hostname)] Killing Ansible-related processes..."
sudo pkill -f ansible-playbook
sudo pkill -f sshpass
sudo pkill -f 'ssh -o ControlMaster'
echo "[$(hostname)] Cleanup complete."
EOF

chmod +x $REMOTE_SCRIPT

# Simple for loop to go through hosts
for HOST in $(cat hosts.txt); do
  echo ">>> $HOST"
  scp -o ConnectTimeout=10 -o StrictHostKeyChecking=no $REMOTE_SCRIPT deploy@$HOST:$REMOTE_SCRIPT
  ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no deploy@$HOST "bash $REMOTE_SCRIPT && rm -f $REMOTE_SCRIPT"
done
