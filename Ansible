#!/bin/bash

HOST_FILE="hosts.txt"
REMOTE_SCRIPT="/tmp/kill-ansible.sh"

# Create the remote script with sudo for pkill
cat << 'EOF' > $REMOTE_SCRIPT
#!/bin/bash
echo "[$(hostname)] Killing Ansible-related processes..."
sudo pkill -f ansible-playbook
sudo pkill -f sshpass
sudo pkill -f 'ssh -o ControlMaster'
echo "[$(hostname)] Cleanup complete."
EOF

chmod +x $REMOTE_SCRIPT

# Loop through the hosts and execute the remote script
while IFS= read -r HOST; do
  [[ -z "$HOST" || "$HOST" == \#* ]] && continue
  echo "Running cleanup on $HOST..."
  scp $REMOTE_SCRIPT deploy@"$HOST":/tmp/kill-ansible.sh
  ssh deploy@"$HOST" "chmod +x /tmp/kill-ansible.sh && /tmp/kill-ansible.sh"
done < "$HOST_FILE"
