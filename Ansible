#!/usr/bin/env bash
# Usage: SSH_KEY=~/.ssh/deploy_key ./simple-ubuntu-patch.sh hosts.txt
# Description: Cleans APT cache, updates, upgrades, and reboots if needed.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
LOGFILE="$SCRIPT_DIR/simple-ubuntu-patch.log"
HOSTS_FILE="${1:-}"

SSH_KEY="${SSH_KEY:-$HOME/.ssh/deploy_key}"
SSH_OPTS="-n -o BatchMode=yes -o ConnectTimeout=15 -o StrictHostKeyChecking=no"

if [[ -z "$HOSTS_FILE" ]]; then
  echo "Usage: $0 <hosts_file>"
  exit 1
fi

if [[ ! -f "$HOSTS_FILE" ]]; then
  echo "‚ùå Missing host file: $HOSTS_FILE"
  exit 1
fi

if [[ ! -f "$SSH_KEY" ]]; then
  echo "‚ùå Missing SSH key: $SSH_KEY"
  exit 1
fi

echo "Run started $(date)" | tee -a "$LOGFILE"

ok=0; fail=0
while IFS= read -r host; do
  [[ -z "$host" || "$host" =~ ^# ]] && continue

  echo "=== $host ===" | tee -a "$LOGFILE"
  ssh -i "$SSH_KEY" $SSH_OPTS "deploy@$host" bash -s <<'EOF' >>"$LOGFILE" 2>&1
set -e
export DEBIAN_FRONTEND=noninteractive

echo "‚Üí Cleaning APT locks and cache..."
sudo rm -f /var/lib/apt/lists/lock /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock
sudo apt-get clean -y

echo "‚Üí Updating package list..."
sudo apt-get update -y

echo "‚Üí Upgrading packages..."
sudo apt-get -yq \
  -o Dpkg::Options::="--force-confdef" \
  -o Dpkg::Options::="--force-confold" \
  upgrade

echo "‚Üí Auto-remove old packages..."
sudo apt-get -y autoremove
sudo apt-get -y autoclean

if [[ -f /var/run/reboot-required ]]; then
  echo "üîÅ Reboot required. Rebooting now..."
  sudo /sbin/reboot
else
  echo "‚úÖ No reboot required."
fi
EOF

  if [[ $? -eq 0 ]]; then
    ((ok++))
  else
    ((fail++))
    echo "‚ùå Failed on $host" | tee -a "$LOGFILE"
  fi
done < "$HOSTS_FILE"

echo "Run completed $(date): $ok succeeded, $fail failed" | tee -a "$LOGFILE"
