#!/usr/bin/env bash
set -uo pipefail

HOSTS_FILE="${1:-hosts.txt}"
SSH_KEY="${SSH_KEY:-$HOME/.ssh/deploy_key}"
USER="${USER:-deploy}"
SSH_OPTS="-o BatchMode=yes -o StrictHostKeyChecking=no -o ConnectTimeout=15"
LOGFILE="./simple-patch.log"

[[ -f "$HOSTS_FILE" ]] || { echo "Missing $HOSTS_FILE"; exit 1; }
[[ -f "$SSH_KEY"   ]]  || { echo "Missing key $SSH_KEY"; exit 1; }

echo "Run started $(date)" | tee -a "$LOGFILE"

while IFS= read -r host; do
  [[ -z "$host" || "$host" =~ ^# ]] && continue
  echo "=== $host ===" | tee -a "$LOGFILE"

  ssh -tt -i "$SSH_KEY" $SSH_OPTS "${USER}@${host}" bash -s <<'REMOTE' 2>&1 | tee -a "$LOGFILE"
set -e
export DEBIAN_FRONTEND=noninteractive
sudo rm -f /var/lib/apt/lists/lock /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock || true
sudo apt-get clean -y || true
sudo apt-get update -y
sudo apt-get -yq -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" upgrade
sudo apt-get -y autoremove || true
sudo apt-get -y autoclean  || true
if [[ -f /var/run/reboot-required ]]; then
  echo "REBOOTING"; sudo /sbin/reboot
else
  echo "NO-REBOOT"
fi
REMOTE

done < "$HOSTS_FILE"

echo "Run completed $(date)" | tee -a "$LOGFILE"
