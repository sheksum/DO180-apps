---
- name: Clean and patch Ubuntu quietly
  hosts: ubuntu
  become: true
  gather_facts: false

  tasks:
    - name: Clean and patch system
      shell: |
        rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock \
              /var/lib/dpkg/lock /var/lib/dpkg/lock-frontend
        apt-get clean -y
        apt-get update -y
        apt-get dist-upgrade -y
        apt-get autoremove -y
        apt-get autoclean -y
      args:
        warn: false
      register: patch_output
      changed_when: false
      failed_when: false

    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_flag

    - name: Print reboot notice
      debug:
        msg: "Reboot required on {{ inventory_hostname }}"
      when: reboot_flag.stat.exists
---
- name: Kill any stale Ansible or SSH processes
  hosts: localhost
  become: false
  gather_facts: false

  tasks:
    - name: Kill leftover ansible and SSH processes
      shell: |
        pkill -f ansible || true
        pkill -f "sshpass" || true
        pkill -f "ssh " || true
        rm -rf /tmp/.ansible-* || true
      args:
        warn: false
      changed_when: false
      failed_when: false

    - name: Confirm cleanup
      shell: ps aux | egrep "ansible|ssh" | grep -v grep || true
      register: process_check
      changed_when: false

    - name: Display any remaining processes
      debug:
        msg: "{{ process_check.stdout_lines }}"


