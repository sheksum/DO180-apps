vault secrets enable -path=kv kv-v2

vault kv put kv/trident/infra username=vsadmin password='<pw>'
vault kv put kv/trident/app username=vsadmin password='<pw>'


vault policy write eso-trident - <<EOF
path "kv/data/trident/*" {
  capabilities = ["read"]
}
EOF


vault write auth/kubernetes-ocp-ai/role/eso-trident \
  bound_service_account_names=external-secrets \
  bound_service_account_namespaces=trident \
  policies=eso-trident \
  ttl=1h


cat << 'EOF' | oc apply -f -
apiVersion: external-secrets.io/v1
kind: SecretStore
metadata:
  name: vault-store
  namespace: trident
spec:
  provider:
    vault:
      server: https://plnx-vault.calix.local:8200
      path: kv
      version: v2
      auth:
        kubernetes:
          mountPath: kubernetes-ocp-ai
          role: eso-trident
          serviceAccountRef:
            name: external-secrets
EOF




cat << 'EOF' | oc apply -f -
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: backend-infra-secret
  namespace: trident
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-store
    kind: SecretStore
  target:
    name: backend-infra-secret
    creationPolicy: Owner
  data:
  - secretKey: username
    remoteRef:
      key: trident/infra
      property: username
  - secretKey: password
    remoteRef:
      key: trident/infra
      property: password
EOF




cat << 'EOF' | oc apply -f -
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: backend-app-secret
  namespace: trident
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-store
    kind: SecretStore
  target:
    name: backend-app-secret
    creationPolicy: Owner
  data:
  - secretKey: username
    remoteRef:
      key: trident/app
      property: username
  - secretKey: password
    remoteRef:
      key: trident/app
      property: password
EOF


oc get externalsecrets -n trident
oc get secrets -n trident | grep backend


  version: 1
status:
  backendInfo:
    backendName: backend-app-nfs
    backendUUID: 27f061fd-e6e4-448c-a4e4-c4302ac4a01a
  deletionPolicy: delete
  lastOperationStatus: Failed
  message: 'Failed to apply the backend update; problem initializing storage driver
    ''ontap-nas'': error initializing ontap-nas driver; could not create Data ONTAP
    API client: error creating ONTAP API client: error reading SVM details: response
    code 401 (Unauthorized): incorrect or missing credentials'
  phase: Bound
hsuma@plnx-admin:~$ oc get tbc backend-app-nfs -n trident -o jsonpath='{.spec.credentials}' | jq .
{
  "name": "backend-app-secret"
}
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ oc get secrets -n trident
NAME                                 TYPE                      DATA   AGE
backend-app-secret                   Opaque                    2      6d3h
backend-infra-secret                 Opaque                    2      6d3h
builder-dockercfg-9dn8h              kubernetes.io/dockercfg   1      5d6h
default-dockercfg-bdwm2              kubernetes.io/dockercfg   1      5d6h
deployer-dockercfg-vqr6s             kubernetes.io/dockercfg   1      5d6h
trident-controller-dockercfg-t4s2g   kubernetes.io/dockercfg   1      5d6h
trident-csi                          Opaque                    6      6d3h
trident-encryption-keys              Opaque                    1      6d3h
trident-node-linux-dockercfg-rwf8z   kubernetes.io/dockercfg   1      5d6h
trident-operator-dockercfg-5kpmc     kubernetes.io/dockercfg   1      5d6h
hsuma@plnx-admin:~$ oc get tbc backend-infra-nfs -n trident -o jsonpath='{.spec.credentials}' | jq .
{
  "name": "backend-infra-secret"
}
hsuma@plnx-admin:~$


App$vm2026!Tr1dent
hsuma@plnx-admin:~$ curl -k -u vsadmin:'<redacted>' https://10.172.254.47/api/cluster
{
  "name": "plano_aff_cl",
  "uuid": "a111a540-0e0d-11ef-8e7d-d039eabbae46",
  "version": {
    "full": "NetApp Release 9.16.1P3: Thu Apr 24 02:50:10 UTC 2025",
    "generation": 9,
    "major": 16,
    "minor": 1
  },
  "disaggregated": false,
  "_links": {
    "self": {
      "href": "/api/cluster"
    }
  }
}hsuma@plnx-admin:~$


hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ oc get secret backend-app-secret -n trident -o yaml
apiVersion: v1
data:
  password: QXBwJHZtMjAyNiFUcjFkZW50
  username: dnNhZG1pbg==
kind: Secret
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"password":"QXBwJHZtMjAyNiFUcjFkZW50","username":"dnNhZG1pbg=="},"kind":"Secret","metadata":{"annotations":{},"name":"backend-app-secret","namespace":"trident"}}
  creationTimestamp: "2026-02-17T21:31:27Z"
  name: backend-app-secret
  namespace: trident
  resourceVersion: "917369"
  uid: 229faf88-0ead-49fb-a9b0-0622b4518adc
type: Opaque
hsuma@plnx-admin:~$ oc get secrets -n trident
NAME                                 TYPE                      DATA   AGE
backend-app-secret                   Opaque                    2      6d3h
backend-infra-secret                 Opaque                    2      6d3h
builder-dockercfg-9dn8h              kubernetes.io/dockercfg   1      5d6h
default-dockercfg-bdwm2              kubernetes.io/dockercfg   1      5d6h
deployer-dockercfg-vqr6s             kubernetes.io/dockercfg   1      5d6h
trident-controller-dockercfg-t4s2g   kubernetes.io/dockercfg   1      5d6h
trident-csi                          Opaque                    6      6d3h
trident-encryption-keys              Opaque                    1      6d3h
trident-node-linux-dockercfg-rwf8z   kubernetes.io/dockercfg   1      5d6h
trident-operator-dockercfg-5kpmc     kubernetes.io/dockercfg   1      5d6h
hsuma@plnx-admin:~$ oc get tbc -n trident
NAME                BACKEND NAME        BACKEND UUID                           PHASE   STATUS
backend-app-nfs     backend-app-nfs     27f061fd-e6e4-448c-a4e4-c4302ac4a01a   Bound   Failed
backend-infra-nfs   backend-infra-nfs   88ba74b5-6d56-47cf-a16d-9066ae716681   Bound   Failed
hsuma@plnx-admin:~$ oc get tbc -n trident backend-app-nfs -o yaml
apiVersion: trident.netapp.io/v1
kind: TridentBackendConfig
metadata:
  annotations:
    argocd.argoproj.io/tracking-id: trident:trident.netapp.io/TridentBackendConfig:trident/backend-app-nfs
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"trident.netapp.io/v1","kind":"TridentBackendConfig","metadata":{"annotations":{"argocd.argoproj.io/tracking-id":"trident:trident.netapp.io/TridentBackendConfig:trident/backend-app-nfs"},"name":"backend-app-nfs","namespace":"trident"},"spec":{"credentials":{"name":"backend-app-secret"},"dataLIF":"10.172.194.22","defaults":{"exportPolicy":"default","snapshotPolicy":"default","spaceReserve":"none"},"managementLIF":"10.152.0.110","storage":[{"defaults":{"snapshotPolicy":"default","spaceReserve":"none"},"labels":{"environment":"dev"}},{"defaults":{"snapshotPolicy":"default","spaceReserve":"none"},"labels":{"environment":"test"}},{"defaults":{"snapshotPolicy":"default","spaceReserve":"volume"},"labels":{"environment":"prod"}}],"storageDriverName":"ontap-nas","svm":"ocp_app_svm","version":1}}
  creationTimestamp: "2026-02-17T21:31:39Z"
  finalizers:
  - trident.netapp.io
  generation: 7
  name: backend-app-nfs
  namespace: trident
  resourceVersion: "3435002"
  uid: df168257-e589-4246-903d-9d8a493252cc
spec:
  credentials:
    name: backend-app-secret
  dataLIF: 10.172.194.22
  defaults:
    exportPolicy: default
    snapshotPolicy: default
    spaceReserve: none
  managementLIF: 10.152.0.110
  storage:
  - defaults:
      snapshotPolicy: default
      spaceReserve: none
    labels:
      environment: dev
  - defaults:
      snapshotPolicy: default
      spaceReserve: none
    labels:
      environment: test
  - defaults:
      snapshotPolicy: default
      spaceReserve: volume
    labels:
      environment: prod
  storageDriverName: ontap-nas
  svm: ocp_app_svm
  version: 1
status:
  backendInfo:
    backendName: backend-app-nfs
    backendUUID: 27f061fd-e6e4-448c-a4e4-c4302ac4a01a
  deletionPolicy: delete
  lastOperationStatus: Failed
  message: 'Failed to apply the backend update; problem initializing storage driver
    ''ontap-nas'': error initializing ontap-nas driver; could not create Data ONTAP
    API client: error creating ONTAP API client: error reading SVM details: response
    code 401 (Unauthorized): incorrect or missing credentials'
  phase: Bound
hsuma@plnx-admin:~$


sed -i 's/10.152.0.110/10.172.254.47/' trident/backend-app.yaml
sed -i 's/10.152.0.110/10.172.254.46/' trident/backend-infra.yaml
git add trident/
git commit -m "Fix managementLIF - use SVM mgmt LIFs not cluster mgmt"
git push origin main





cat << 'EOF' | oc apply -f -
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: apps-wildcard-tls
  namespace: openshift-ingress
spec:
  secretName: apps-wildcard-tls
  duration: 8760h
  renewBefore: 720h
  commonName: "*.apps.ocp-ai.calix.local"
  dnsNames:
  - "*.apps.ocp-ai.calix.local"
  issuerRef:
    name: vault-issuer
    kind: ClusterIssuer
EOF



cat << 'EOF' | oc apply -f -
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: api-tls
  namespace: openshift-config
spec:
  secretName: api-tls
  duration: 8760h
  renewBefore: 720h
  commonName: api.ocp-ai.calix.local
  dnsNames:
  - api.ocp-ai.calix.local
  issuerRef:
    name: vault-issuer
    kind: ClusterIssuer
EOF



oc get certificate -n openshift-ingress
oc get certificate -n openshift-config



oc patch ingresscontroller default -n openshift-ingress-operator \
  --type merge \
  -p '{"spec":{"defaultCertificate":{"name":"apps-wildcard-tls"}}}'



oc patch apiserver cluster \
  --type merge \
  -p '{"spec":{"servingCerts":{"namedCertificates":[{"names":["api.ocp-ai.calix.local"],"servingCertificate":{"name":"api-tls"}}]}}}'


curl -v https://console-openshift-console.apps.ocp-ai.calix.local 2>&1 | grep issuer
curl -v https://api.ocp-ai.calix.local:6443 2>&1 | grep issuer


hsuma@plnx-admin:~/ocp-ai-config$
hsuma@plnx-admin:~/ocp-ai-config$ cat << 'EOF' | oc apply -f -
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: apps-wildcard-tls
  namespace: openshift-ingress
spec:
  secretName: apps-wildcard-tls
  duration: 8760h
  renewBefore: 720h
  commonName: "*.apps.ocp-ai.calix.local"
  dnsNames:
  - "*.apps.ocp-ai.calix.local"
  issuerRef:
    name: vault-issuer
    kind: ClusterIssuer
EOF
Warning: spec.privateKey.rotationPolicy: In cert-manager >= v1.18.0, the default value changed from `Never` to `Always`.
certificate.cert-manager.io/apps-wildcard-tls created
hsuma@plnx-admin:~/ocp-ai-config$
hsuma@plnx-admin:~/ocp-ai-config$
hsuma@plnx-admin:~/ocp-ai-config$


hsuma@plnx-admin:~/ocp-ai-config$ oc get co kube-apiserver openshift-apiserver authentication
NAME                  VERSION   AVAILABLE   PROGRESSING   DEGRADED   SINCE   MESSAGE
kube-apiserver        4.20.13   True        True          False      8d      NodeInstallerProgressing: 3 nodes are at revision 12; 0 nodes have achieved new revision 13
openshift-apiserver   4.20.13   True        False         False      8d
authentication        4.20.13   True        False         True       115s    RouterCertsDegraded: secret/v4-0-config-system-router-certs.spec.data[apps.ocp-ai.calix.local] -n openshift-authentication: certificate could not validate route hostname oauth-openshift.apps.ocp-ai.calix.local: x509: certificate signed by unknown authority
hsuma@plnx-admin:~/ocp-ai-config$
hsuma@plnx-admin:~/ocp-ai-config$
hsuma@plnx-admin:~/ocp-ai-config$




vault read -field=certificate pki_root/cert/ca > /tmp/ocp-ai-root-ca.crt



oc create configmap custom-ca-bundle \
  -n openshift-config \
  --from-file=ca-bundle.crt=/tmp/ocp-ai-root-ca.crt



oc patch proxy/cluster \
  --type merge \
  -p '{"spec":{"trustedCA":{"name":"custom-ca-bundle"}}}'


watch oc get co authentication kube-apiserver



curl -v https://console-openshift-console.apps.ocp-ai.calix.local 2>&1 | grep issuer
curl -v https://api.ocp-ai.calix.local:6443 2>&1 | grep issuer


hsuma@plnx-admin:~/ocp-ai-config$ curl -v https://console-openshift-console.apps.ocp-ai.calix.local 2>&1 | grep issuer
* SSL certificate problem: unable to get local issuer certificate
curl: (60) SSL certificate problem: unable to get local issuer certificate
hsuma@plnx-admin:~/ocp-ai-config$
hsuma@plnx-admin:~/ocp-ai-config$
hsuma@plnx-admin:~/ocp-ai-config$ curl -v https://api.ocp-ai.calix.local:6443 2>&1 | grep issuer
* SSL certificate problem: unable to get local issuer certificate
curl: (60) SSL certificate problem: unable to get local issuer certificate
hsuma@plnx-admin:~/ocp-ai-config$



General
Details
Common Name (CN)	*.apps.ocp-ai.calix.local
Organization (O)	<Not Part Of Certificate>
Organizational Unit (OU)	<Not Part Of Certificate>
Common Name (CN)	Calix OCP-AI Intermediate CA
Organization (O)	<Not Part Of Certificate>
Organizational Unit (OU)	<Not Part Of Certificate>
Issued On	Monday, February 23, 2026 at 8:23:14 PM
Expires On	Tuesday, February 23, 2027 at 8:23:44 PM
Certificate	46c6bad0c6b9b6a828880bfbdf3192c8c6597c5b4b8af4af4c3fc317f256981d
Public Key	e639b159e52ebd06b8f8837661465cfa01d9e725f83546283bf54a384eeab479



General
Details
Common Name (CN)	stash.calix.local
Organization (O)	Calix
Organizational Unit (OU)	EngOps
Common Name (CN)	CalixEntCA
Organization (O)	<Not Part Of Certificate>
Organizational Unit (OU)	<Not Part Of Certificate>
Issued On	Monday, August 4, 2025 at 2:05:35 PM
Expires On	Wednesday, August 4, 2027 at 2:05:35 PM
Certificate	82f32a57b7f9cb522fd9c6013c029fcfb6833f2f82d2428d0bd9113cac2610ad
Public Key	7a9814ea9e123fa8e397d67be5d85e9e6efa6471f8e3f8b790d189eac74761a0



Here are your Jira updates:
Task 8 — GPU Operator → CLOSE

NFD, NVIDIA GPU Operator, and ClusterPolicy deployed. 8x H100L detected and validated with nvidia-smi. Taints applied (nvidia.com/gpu=true:NoSchedule) to gpu01/gpu02 — non-GPU workloads prevented from scheduling on GPU nodes. GPU Operator pods tolerate the taint and continue running. Verified with test pod scheduling to master only.

Task 9 — GitOps → CLOSE

ArgoCD installed, connected to Bitbucket via SSH deploy key (argocd-ocp-ai). App-of-Apps root application deployed with selfHeal enabled. Application manifests created for nmstate, trident, and machineconfigs — drift protection active. Caught and resolved stale managementLIF in Trident backend manifests via GitOps sync. ESO integrated with Vault for Trident secrets (no secrets in Git). ArgoCD RBAC deferred to Task 7 — requires LDAP integration first. ArgoCD controller granted cluster-admin for managing cluster-scoped resources.

Task 14 — TLS / Vault PKI → CLOSE (14.9 pending)

cert-manager installed. Vault PKI chain operational — self-signed root CA (pki_root) signed intermediate (pki_int), ClusterIssuer vault-issuer Ready. Wildcard ingress cert (*.apps.ocp-ai.calix.local) issued and applied to IngressController. API cert (api.ocp-ai.calix.local) issued and applied to APIServer. Root CA injected into cluster trust bundle via proxy/cluster. All cluster operators healthy — authentication, kube-apiserver, openshift-apiserver all Available, not Degraded. Pending: 14.9 — swap self-signed root with Calix corporate CA once IT signs the intermediate CSR.



ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "ip link show ens8f0np0; ip link show ens8f1np1"
ssh -i ~/.ssh/ocp-ai core@10.172.248.154 "ip link show ens8f0np0; ip link show ens8f1np1"


ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "echo 'core:TempPass123!' | sudo chpasswd"
ssh -i ~/.ssh/ocp-ai core@10.172.248.154 "echo 'core:TempPass123!' | sudo chpasswd"



ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "sudo ovs-vsctl show | head -20"



hsuma@plnx-admin:~/ocp-ai-config$ ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "sudo ovs-vsctl show | head -20"
2ccaea92-31b1-4724-97fd-1a465c78ad4c
    Bridge br-int
        fail_mode: secure
        datapath_type: system
        Port "755f55f1d294cff"
            Interface "755f55f1d294cff"
        Port ovn-0afb38-0
            Interface ovn-0afb38-0
                type: geneve
                options: {csum="true", key=flow, local_ip="10.172.248.153", remote_ip="10.172.248.152"}
        Port "9c6d66e77b612d9"
            Interface "9c6d66e77b612d9"
        Port "868abcaa3d3a4f5"
            Interface "868abcaa3d3a4f5"
        Port bacdc52b4f95e02
            Interface bacdc52b4f95e02
        Port "2a2f6970a5eb624"
            Interface "2a2f6970a5eb624"
        Port d35e362ba0069c0
            Interface d35e362ba0069c0
hsuma@plnx-admin:~/ocp-ai-config$



ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "sudo ovs-vsctl show" | grep -A5 "br-ex"


ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "sudo ovs-vsctl list-ports br-ex"



hsuma@plnx-admin:~/ocp-ai-config$
hsuma@plnx-admin:~/ocp-ai-config$ ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "sudo ovs-vsctl show" | grep -A5 "br-ex"
        Port patch-br-int-to-br-ex_ocp-ai-gpu01.calix.local
            Interface patch-br-int-to-br-ex_ocp-ai-gpu01.calix.local
                type: patch
                options: {peer=patch-br-ex_ocp-ai-gpu01.calix.local-to-br-int}
        Port ovn-70affb-0
            Interface ovn-70affb-0
                type: geneve
                options: {csum="true", key=flow, local_ip="10.172.248.153", remote_ip="10.172.248.154"}
        Port "07c6025e1c8f616"
--
    Bridge br-ex
        Port eno8303
            Interface eno8303
                type: system
        Port patch-br-ex_ocp-ai-gpu01.calix.local-to-br-int
            Interface patch-br-ex_ocp-ai-gpu01.calix.local-to-br-int
                type: patch
                options: {peer=patch-br-int-to-br-ex_ocp-ai-gpu01.calix.local}
        Port br-ex
            Interface br-ex
                type: internal
    ovs_version: "3.5.2-51.el9fdp"
hsuma@plnx-admin:~/ocp-ai-config$
hsuma@plnx-admin:~/ocp-ai-config$
hsuma@plnx-admin:~/ocp-ai-config$ ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "sudo ovs-vsctl list-ports br-ex"
eno8303
patch-br-ex_ocp-ai-gpu01.calix.local-to-br-int
hsuma@plnx-admin:~/ocp-ai-config$



ssh -i ~/.ssh/ocp-ai core@10.172.248.153
sudo nmcli con show
sudo bash -c 'echo "sleep 300 && nmcli device disconnect ens8f0np0 && nmcli device disconnect ens8f1np1 && systemctl restart NetworkManager" | at now + 5 min'
nohup sudo bash -c 'sleep 300 && reboot' &
sudo kill %1
sudo atrm 1

cat << 'EOF' > ~/ocp-ai-config/nmstate/nncp-gpu01.yaml
apiVersion: nmstate.io/v1
kind: NodeNetworkConfigurationPolicy
metadata:
  name: nncp-gpu01
spec:
  nodeSelector:
    kubernetes.io/hostname: ocp-ai-gpu01.calix.local
  desiredState:
    interfaces:
    - name: bond0
      type: bond
      state: up
      mtu: 9000
      ipv4:
        enabled: false
      link-aggregation:
        mode: 802.3ad
        port:
        - ens8f0np0
        - ens8f1np1
        options:
          miimon: "100"
          lacp_rate: "fast"
    - name: br-ex
      type: ovs-bridge
      state: up
      bridge:
        port:
        - name: bond0
        - name: br-ex
      ovs-db:
        external_ids:
          bridge-id: br-ex
    - name: br-ex
      type: ovs-interface
      state: up
      mtu: 9000
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.248.153
          prefix-length: 24
    - name: bond0.1792
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1792
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.192.153
          prefix-length: 23
    - name: bond0.1794
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1794
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.194.153
          prefix-length: 23
    - name: bond0.1796
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1796
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.196.153
          prefix-length: 23
    - name: bond0.1798
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1798
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.198.153
          prefix-length: 23
    - name: bond0.1793
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1793
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.200.153
          prefix-length: 23
    - name: bond0.1797
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1797
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.202.153
          prefix-length: 23
    - name: eno8303
      type: ethernet
      state: up
      ipv4:
        enabled: false
    routes:
      config:
      - destination: 0.0.0.0/0
        next-hop-address: 10.172.248.1
        next-hop-interface: br-ex
EOF

oc apply -f ~/ocp-ai-config/nmstate/nncp-gpu01.yaml


oc get nnce nncp-gpu01.ocp-ai-gpu01.calix.local -o jsonpath='{.status.conditions}' | jq .

ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "sudo kill \$(pgrep -f 'sleep 300')"


sudo bash -c 'ip link set eno8303 up && ip link set eno8303 mtu 9000 && ovs-vsctl set int br-ex mtu_request=9000 && nmcli con show --active'





cat << 'EOF' | oc apply -f -
apiVersion: nmstate.io/v1
kind: NodeNetworkConfigurationPolicy
metadata:
  name: nncp-gpu01-bond
spec:
  nodeSelector:
    kubernetes.io/hostname: ocp-ai-gpu01.calix.local
  desiredState:
    interfaces:
    - name: bond0
      type: bond
      state: up
      mtu: 9000
      ipv4:
        enabled: false
      link-aggregation:
        mode: 802.3ad
        port:
        - ens8f0np0
        - ens8f1np1
        options:
          miimon: "100"
          lacp_rate: "fast"
    - name: bond0.1792
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1792
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.192.153
          prefix-length: 23
    - name: bond0.1794
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1794
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.194.153
          prefix-length: 23
    - name: bond0.1796
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1796
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.196.153
          prefix-length: 23
    - name: bond0.1798
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1798
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.198.153
          prefix-length: 23
    - name: bond0.1793
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1793
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.200.153
          prefix-length: 23
    - name: bond0.1797
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1797
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.202.153
          prefix-length: 23
EOF


ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "cat /proc/net/bonding/bond0"
ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "ip addr show bond0"
ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "ip addr show bond0.1792"
ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "ping -c 3 10.172.192.22"
ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "ping -c 3 10.172.194.22"


ssh -i ~/.ssh/ocp-ai core@10.172.248.153 'nohup sudo bash -c "sleep 300 && reboot" &'


cat << 'EOF' | oc apply -f -
apiVersion: nmstate.io/v1
kind: NodeNetworkConfigurationPolicy
metadata:
  name: nncp-gpu01-brex
spec:
  nodeSelector:
    kubernetes.io/hostname: ocp-ai-gpu01.calix.local
  desiredState:
    interfaces:
    - name: br-ex
      type: ovs-bridge
      state: up
      bridge:
        port:
        - name: bond0.1510
        - name: br-ex
    - name: bond0.1510
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1510
      ipv4:
        enabled: false
    - name: br-ex
      type: ovs-interface
      state: up
      mtu: 9000
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.248.153
          prefix-length: 24
    - name: eno8303
      type: ethernet
      state: up
      ipv4:
        enabled: false
    routes:
      config:
      - destination: 0.0.0.0/0
        next-hop-address: 10.172.248.1
        next-hop-interface: br-ex
EOF


ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "sudo kill \$(pgrep -f 'sleep 300')"



ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "sudo ovs-vsctl list-ports br-ex"
ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "ip addr show br-ex"
oc get nodes


hsuma@plnx-admin:~$ ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "cat /proc/net/bonding/bond0"
Ethernet Channel Bonding Driver: v5.14.0-570.83.1.el9_6.x86_64

Bonding Mode: IEEE 802.3ad Dynamic link aggregation
Transmit Hash Policy: layer2 (0)
MII Status: up
MII Polling Interval (ms): 100
Up Delay (ms): 0
Down Delay (ms): 0
Peer Notification Delay (ms): 0

802.3ad info
LACP active: on
LACP rate: fast
Min links: 0
Aggregator selection policy (ad_select): stable

Slave Interface: ens8f0np0
MII Status: up
Speed: 100000 Mbps
Duplex: full
Link Failure Count: 0
Permanent HW addr: 7c:8c:09:c3:74:1e
Slave queue ID: 0
Aggregator ID: 1
Actor Churn State: monitoring
Partner Churn State: monitoring
Actor Churned Count: 0
Partner Churned Count: 0

Slave Interface: ens8f1np1
MII Status: up
Speed: 100000 Mbps
Duplex: full
Link Failure Count: 0
Permanent HW addr: 7c:8c:09:c3:74:1f
Slave queue ID: 0
Aggregator ID: 1
Actor Churn State: monitoring
Partner Churn State: monitoring
Actor Churned Count: 0
Partner Churned Count: 0


hsuma@plnx-admin:~$ ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "ip addr show bond0"
37: bond0: <BROADCAST,MULTICAST,MASTER,UP,LOWER_UP> mtu 9000 qdisc noqueue state UP group default qlen 1000
    link/ether 7c:8c:09:c3:74:1e brd ff:ff:ff:ff:ff:ff
hsuma@plnx-admin:~$


hsuma@plnx-admin:~$ ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "ip addr show bond0.1792"
38: bond0.1792@bond0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9000 qdisc noqueue state UP group default qlen 1000
    link/ether 7c:8c:09:c3:74:1e brd ff:ff:ff:ff:ff:ff
    inet 10.172.192.153/23 brd 10.172.193.255 scope global noprefixroute bond0.1792
       valid_lft forever preferred_lft forever
hsuma@plnx-admin:~$""


hsuma@plnx-admin:~$ ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "ping -c 3 10.172.192.22"
PING 10.172.192.22 (10.172.192.22) 56(84) bytes of data.
64 bytes from 10.172.192.22: icmp_seq=1 ttl=64 time=0.159 ms
64 bytes from 10.172.192.22: icmp_seq=2 ttl=64 time=0.069 ms
64 bytes from 10.172.192.22: icmp_seq=3 ttl=64 time=0.055 ms

--- 10.172.192.22 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2051ms
rtt min/avg/max/mdev = 0.055/0.094/0.159/0.046 ms
hsuma@plnx-admin:~$


hsuma@plnx-admin:~$ ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "ping -c 3 10.172.194.22"
PING 10.172.194.22 (10.172.194.22) 56(84) bytes of data.
64 bytes from 10.172.194.22: icmp_seq=1 ttl=64 time=0.081 ms
64 bytes from 10.172.194.22: icmp_seq=2 ttl=64 time=0.074 ms
64 bytes from 10.172.194.22: icmp_seq=3 ttl=64 time=0.068 ms

--- 10.172.194.22 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2079ms
rtt min/avg/max/mdev = 0.068/0.074/0.081/0.005 ms
hsuma@plnx-admin:~$



oc patch nncp nncp-gpu01-bond --type merge -p '
spec:
  desiredState:
    interfaces:
    - name: bond0.1510
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1510
      ipv4:
        enabled: false'


ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "sudo nmcli con add type vlan con-name bond0.1510 ifname bond0.1510 dev bond0 id 1510 mtu 9000 ipv4.method disabled"
ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "sudo nmcli con up bond0.1510"


ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "ip link show bond0.1510"

ssh -i ~/.ssh/ocp-ai core@10.172.248.153 'nohup sudo bash -c "sleep 300 && reboot" &'

ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "sudo ovs-vsctl del-port br-ex eno8303 && sudo ovs-vsctl add-port br-ex bond0.1510"

ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "sudo kill \$(pgrep -f 'sleep 300')"



hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "cat /proc/net/bonding/bond0"
Ethernet Channel Bonding Driver: v5.14.0-570.83.1.el9_6.x86_64

Bonding Mode: IEEE 802.3ad Dynamic link aggregation
Transmit Hash Policy: layer2 (0)
MII Status: up
MII Polling Interval (ms): 100
Up Delay (ms): 0
Down Delay (ms): 0
Peer Notification Delay (ms): 0

802.3ad info
LACP active: on
LACP rate: fast
Min links: 0
Aggregator selection policy (ad_select): stable

Slave Interface: ens8f0np0
MII Status: up
Speed: 100000 Mbps
Duplex: full
Link Failure Count: 0
Permanent HW addr: 7c:8c:09:c3:74:1e
Slave queue ID: 0
Aggregator ID: 1
Actor Churn State: none
Partner Churn State: none
Actor Churned Count: 0
Partner Churned Count: 0

Slave Interface: ens8f1np1
MII Status: up
Speed: 100000 Mbps
Duplex: full
Link Failure Count: 0
Permanent HW addr: 7c:8c:09:c3:74:1f
Slave queue ID: 0
Aggregator ID: 1
Actor Churn State: none
Partner Churn State: none
Actor Churned Count: 0
Partner Churned Count: 0
hsuma@plnx-admin:~$ ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "ip addr show bond0.1792"
18: bond0.1792@bond0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9000 qdisc noqueue state UP group default qlen 1000
    link/ether 7c:8c:09:c3:74:1e brd ff:ff:ff:ff:ff:ff
    inet 10.172.192.153/23 brd 10.172.193.255 scope global noprefixroute bond0.1792
       valid_lft forever



ssh -i ~/.ssh/ocp-ai core@10.172.248.153 'sudo bash -c "cat > /etc/systemd/system/br-ex-bond.service << EOF
[Unit]
Description=Swap br-ex uplink to bond0
After=NetworkManager.service ovs-vswitchd.service
Requires=ovs-vswitchd.service

[Service]
Type=oneshot
ExecStart=/bin/bash -c \"nmcli con add type vlan con-name bond0.1510 ifname bond0.1510 dev bond0 id 1510 mtu 9000 ipv4.method disabled 2>/dev/null; nmcli con up bond0.1510 2>/dev/null; ovs-vsctl --if-exists del-port br-ex eno8303; ovs-vsctl --may-exist add-port br-ex bond0.1510; touch /run/resolv-prepender-kni-conf-done\"
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF"'

ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "sudo systemctl daemon-reload && sudo systemctl enable br-ex-bond.service"

ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "sudo reboot"


Feb 24 04:10:13 ocp-ai-gpu01.calix.local systemd[1]: Starting Swap br-ex uplink to bond0...
Feb 24 04:10:16 ocp-ai-gpu01.calix.local bash[3705]: Connection 'bond0.1510' (e389b5ad-b0a0-421b-b61d-e7bd07068aa3) successfully added.
Feb 24 04:10:30 ocp-ai-gpu01.calix.local bash[3730]: Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/14)
Feb 24 04:10:30 ocp-ai-gpu01.calix.local ovs-vsctl[4611]: ovs|00001|vsctl|INFO|Called as ovs-vsctl --if-exists del-port br-ex eno8303
Feb 24 04:10:30 ocp-ai-gpu01.calix.local ovs-vsctl[4615]: ovs|00001|vsctl|INFO|Called as ovs-vsctl --may-exist add-port br-ex bond0.1510
Feb 24 04:10:30 ocp-ai-gpu01.calix.local ovs-vsctl[4615]: ovs|00002|db_ctl_base|ERR|no bridge named br-ex
Feb 24 04:10:30 ocp-ai-gpu01.calix.local bash[4615]: ovs-vsctl: no bridge named br-ex
Feb 24 04:10:30 ocp-ai-gpu01.calix.local systemd[1]: Finished Swap br-ex uplink to bond0.
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "sudo ovs-vsctl show | grep -A10 br-ex"
        Port patch-br-int-to-br-ex_ocp-ai-gpu01.calix.local
            Interface patch-br-int-to-br-ex_ocp-ai-gpu01.calix.local
                type: patch
                options: {peer=patch-br-ex_ocp-ai-gpu01.calix.local-to-br-int}
        Port "712f74a8d4dfa88"
            Interface "712f74a8d4dfa88"
        Port "5cdc8852bc50220"
            Interface "5cdc8852bc50220"
        Port "092eccd5d3abade"
            Interface "092eccd5d3abade"
        Port "08b5c7fa5f28842"
            Interface "08b5c7fa5f28842"
        Port "218f58cb291481a"
            Interface "218f58cb291481a"
--
    Bridge br-ex
        Port br-ex
            Interface br-ex
                type: internal
        Port eno8303
            Interface eno8303
                type: system
        Port patch-br-ex_ocp-ai-gpu01.calix.local-to-br-int
            Interface patch-br-ex_ocp-ai-gpu01.calix.local-to-br-int
                type: patch
                options: {peer=patch-br-int-to-br-ex_ocp-ai-gpu01.calix.local}
    ovs_version: "3.5.2-51.el9fdp"
hsuma@plnx-admin:~$



hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ cat ~/ocp-ai-config/nmstate/nncp-master01.yaml
apiVersion: nmstate.io/v1
kind: NodeNetworkConfigurationPolicy
metadata:
  name: storage-vlans-master01
spec:
  nodeSelector:
    kubernetes.io/hostname: ocp-ai-master01.calix.local
  desiredState:
    interfaces:
      - name: bnd0
        type: bond
        state: up
        ipv4:
          enabled: false
        link-aggregation:
          mode: active-backup
          port:
            - eno7
            - eno8
        mtu: 9000
      - name: bnd0.1792
        type: vlan
        state: up
        ipv4:
          enabled: true
          dhcp: false
          address:
            - ip: 10.172.192.150
              prefix-length: 23
        vlan:
          base-iface: bnd0
          id: 1792
      - name: bnd0.1794
        type: vlan
        state: up
        ipv4:
          enabled: true
          dhcp: false
          address:
            - ip: 10.172.194.150
              prefix-length: 23
        vlan:
          base-iface: bnd0
          id: 1794
      - name: bnd0.1796
        type: vlan
        state: up
        ipv4:
          enabled: true
          dhcp: false
          address:
            - ip: 10.172.196.150
              prefix-length: 23
        vlan:
          base-iface: bnd0
          id: 1796
      - name: bnd0.1798
        type: vlan
        state: up
        ipv4:
          enabled: true
          dhcp: false
          address:
            - ip: 10.172.198.150
              prefix-length: 23
        vlan:
          base-iface: bnd0
          id: 1798
      - name: bnd0.1793
        type: vlan
        state: up
        ipv4:
          enabled: true
          dhcp: false
          address:
            - ip: 10.172.200.150
              prefix-length: 23
        vlan:
          base-iface: bnd0
          id: 1793
      - name: bnd0.1797
        type: vlan
        state: up
        ipv4:
          enabled: true
          dhcp: false
          address:
            - ip: 10.172.202.150
              prefix-length: 23
        vlan:
          base-iface: bnd0
          id: 1797
hsuma@plnx-admin:~$



ssh -i ~/.ssh/ocp-ai core@10.172.248.153 "sudo systemctl disable br-ex-bond.service && sudo rm /etc/systemd/system/br-ex-bond.service && sudo systemctl daemon-reload"


cat << 'EOF' | oc apply -f -
apiVersion: nmstate.io/v1
kind: NodeNetworkConfigurationPolicy
metadata:
  name: nncp-gpu02-bond
spec:
  nodeSelector:
    kubernetes.io/hostname: ocp-ai-gpu02.calix.local
  desiredState:
    interfaces:
    - name: bond0
      type: bond
      state: up
      mtu: 9000
      ipv4:
        enabled: false
      link-aggregation:
        mode: 802.3ad
        port:
        - ens8f0np0
        - ens8f1np1
        options:
          miimon: "100"
          lacp_rate: "fast"
    - name: bond0.1792
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1792
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.192.154
          prefix-length: 23
    - name: bond0.1794
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1794
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.194.154
          prefix-length: 23
    - name: bond0.1796
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1796
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.196.154
          prefix-length: 23
    - name: bond0.1798
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1798
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.198.154
          prefix-length: 23
    - name: bond0.1793
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1793
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.200.154
          prefix-length: 23
    - name: bond0.1797
      type: vlan
      state: up
      mtu: 9000
      vlan:
        base-iface: bond0
        id: 1797
      ipv4:
        enabled: true
        dhcp: false
        address:
        - ip: 10.172.202.154
          prefix-length: 23
EOF
