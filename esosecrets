vault secrets enable -path=kv kv-v2

vault kv put kv/trident/infra username=vsadmin password='<pw>'
vault kv put kv/trident/app username=vsadmin password='<pw>'


vault policy write eso-trident - <<EOF
path "kv/data/trident/*" {
  capabilities = ["read"]
}
EOF


vault write auth/kubernetes-ocp-ai/role/eso-trident \
  bound_service_account_names=external-secrets \
  bound_service_account_namespaces=trident \
  policies=eso-trident \
  ttl=1h


  cat << 'EOF' | oc apply -f -
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-store
  namespace: trident
spec:
  provider:
    vault:
      server: https://plnx-vault.calix.local:8200
      path: kv
      version: v2
      auth:
        kubernetes:
          mountPath: kubernetes-ocp-ai
          role: eso-trident
          serviceAccountRef:
            name: external-secrets
EOF




cat << 'EOF' | oc apply -f -
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: backend-infra-secret
  namespace: trident
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-store
    kind: SecretStore
  target:
    name: backend-infra-secret
    creationPolicy: Owner
  data:
  - secretKey: username
    remoteRef:
      key: trident/infra
      property: username
  - secretKey: password
    remoteRef:
      key: trident/infra
      property: password
EOF




cat << 'EOF' | oc apply -f -
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: backend-app-secret
  namespace: trident
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-store
    kind: SecretStore
  target:
    name: backend-app-secret
    creationPolicy: Owner
  data:
  - secretKey: username
    remoteRef:
      key: trident/app
      property: username
  - secretKey: password
    remoteRef:
      key: trident/app
      property: password
EOF


oc get externalsecrets -n trident
oc get secrets -n trident | grep backend
