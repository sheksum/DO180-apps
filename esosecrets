vault secrets enable -path=kv kv-v2

vault kv put kv/trident/infra username=vsadmin password='<pw>'
vault kv put kv/trident/app username=vsadmin password='<pw>'


vault policy write eso-trident - <<EOF
path "kv/data/trident/*" {
  capabilities = ["read"]
}
EOF


vault write auth/kubernetes-ocp-ai/role/eso-trident \
  bound_service_account_names=external-secrets \
  bound_service_account_namespaces=trident \
  policies=eso-trident \
  ttl=1h


cat << 'EOF' | oc apply -f -
apiVersion: external-secrets.io/v1
kind: SecretStore
metadata:
  name: vault-store
  namespace: trident
spec:
  provider:
    vault:
      server: https://plnx-vault.calix.local:8200
      path: kv
      version: v2
      auth:
        kubernetes:
          mountPath: kubernetes-ocp-ai
          role: eso-trident
          serviceAccountRef:
            name: external-secrets
EOF




cat << 'EOF' | oc apply -f -
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: backend-infra-secret
  namespace: trident
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-store
    kind: SecretStore
  target:
    name: backend-infra-secret
    creationPolicy: Owner
  data:
  - secretKey: username
    remoteRef:
      key: trident/infra
      property: username
  - secretKey: password
    remoteRef:
      key: trident/infra
      property: password
EOF




cat << 'EOF' | oc apply -f -
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: backend-app-secret
  namespace: trident
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-store
    kind: SecretStore
  target:
    name: backend-app-secret
    creationPolicy: Owner
  data:
  - secretKey: username
    remoteRef:
      key: trident/app
      property: username
  - secretKey: password
    remoteRef:
      key: trident/app
      property: password
EOF


oc get externalsecrets -n trident
oc get secrets -n trident | grep backend


  version: 1
status:
  backendInfo:
    backendName: backend-app-nfs
    backendUUID: 27f061fd-e6e4-448c-a4e4-c4302ac4a01a
  deletionPolicy: delete
  lastOperationStatus: Failed
  message: 'Failed to apply the backend update; problem initializing storage driver
    ''ontap-nas'': error initializing ontap-nas driver; could not create Data ONTAP
    API client: error creating ONTAP API client: error reading SVM details: response
    code 401 (Unauthorized): incorrect or missing credentials'
  phase: Bound
hsuma@plnx-admin:~$ oc get tbc backend-app-nfs -n trident -o jsonpath='{.spec.credentials}' | jq .
{
  "name": "backend-app-secret"
}
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ oc get secrets -n trident
NAME                                 TYPE                      DATA   AGE
backend-app-secret                   Opaque                    2      6d3h
backend-infra-secret                 Opaque                    2      6d3h
builder-dockercfg-9dn8h              kubernetes.io/dockercfg   1      5d6h
default-dockercfg-bdwm2              kubernetes.io/dockercfg   1      5d6h
deployer-dockercfg-vqr6s             kubernetes.io/dockercfg   1      5d6h
trident-controller-dockercfg-t4s2g   kubernetes.io/dockercfg   1      5d6h
trident-csi                          Opaque                    6      6d3h
trident-encryption-keys              Opaque                    1      6d3h
trident-node-linux-dockercfg-rwf8z   kubernetes.io/dockercfg   1      5d6h
trident-operator-dockercfg-5kpmc     kubernetes.io/dockercfg   1      5d6h
hsuma@plnx-admin:~$ oc get tbc backend-infra-nfs -n trident -o jsonpath='{.spec.credentials}' | jq .
{
  "name": "backend-infra-secret"
}
hsuma@plnx-admin:~$


App$vm2026!Tr1dent
hsuma@plnx-admin:~$ curl -k -u vsadmin:'<redacted>' https://10.172.254.47/api/cluster
{
  "name": "plano_aff_cl",
  "uuid": "a111a540-0e0d-11ef-8e7d-d039eabbae46",
  "version": {
    "full": "NetApp Release 9.16.1P3: Thu Apr 24 02:50:10 UTC 2025",
    "generation": 9,
    "major": 16,
    "minor": 1
  },
  "disaggregated": false,
  "_links": {
    "self": {
      "href": "/api/cluster"
    }
  }
}hsuma@plnx-admin:~$
