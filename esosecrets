vault secrets enable -path=kv kv-v2

vault kv put kv/trident/infra username=vsadmin password='<pw>'
vault kv put kv/trident/app username=vsadmin password='<pw>'


vault policy write eso-trident - <<EOF
path "kv/data/trident/*" {
  capabilities = ["read"]
}
EOF


vault write auth/kubernetes-ocp-ai/role/eso-trident \
  bound_service_account_names=external-secrets \
  bound_service_account_namespaces=trident \
  policies=eso-trident \
  ttl=1h


cat << 'EOF' | oc apply -f -
apiVersion: external-secrets.io/v1
kind: SecretStore
metadata:
  name: vault-store
  namespace: trident
spec:
  provider:
    vault:
      server: https://plnx-vault.calix.local:8200
      path: kv
      version: v2
      auth:
        kubernetes:
          mountPath: kubernetes-ocp-ai
          role: eso-trident
          serviceAccountRef:
            name: external-secrets
EOF




cat << 'EOF' | oc apply -f -
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: backend-infra-secret
  namespace: trident
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-store
    kind: SecretStore
  target:
    name: backend-infra-secret
    creationPolicy: Owner
  data:
  - secretKey: username
    remoteRef:
      key: trident/infra
      property: username
  - secretKey: password
    remoteRef:
      key: trident/infra
      property: password
EOF




cat << 'EOF' | oc apply -f -
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: backend-app-secret
  namespace: trident
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-store
    kind: SecretStore
  target:
    name: backend-app-secret
    creationPolicy: Owner
  data:
  - secretKey: username
    remoteRef:
      key: trident/app
      property: username
  - secretKey: password
    remoteRef:
      key: trident/app
      property: password
EOF


oc get externalsecrets -n trident
oc get secrets -n trident | grep backend


  version: 1
status:
  backendInfo:
    backendName: backend-app-nfs
    backendUUID: 27f061fd-e6e4-448c-a4e4-c4302ac4a01a
  deletionPolicy: delete
  lastOperationStatus: Failed
  message: 'Failed to apply the backend update; problem initializing storage driver
    ''ontap-nas'': error initializing ontap-nas driver; could not create Data ONTAP
    API client: error creating ONTAP API client: error reading SVM details: response
    code 401 (Unauthorized): incorrect or missing credentials'
  phase: Bound
hsuma@plnx-admin:~$ oc get tbc backend-app-nfs -n trident -o jsonpath='{.spec.credentials}' | jq .
{
  "name": "backend-app-secret"
}
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ oc get secrets -n trident
NAME                                 TYPE                      DATA   AGE
backend-app-secret                   Opaque                    2      6d3h
backend-infra-secret                 Opaque                    2      6d3h
builder-dockercfg-9dn8h              kubernetes.io/dockercfg   1      5d6h
default-dockercfg-bdwm2              kubernetes.io/dockercfg   1      5d6h
deployer-dockercfg-vqr6s             kubernetes.io/dockercfg   1      5d6h
trident-controller-dockercfg-t4s2g   kubernetes.io/dockercfg   1      5d6h
trident-csi                          Opaque                    6      6d3h
trident-encryption-keys              Opaque                    1      6d3h
trident-node-linux-dockercfg-rwf8z   kubernetes.io/dockercfg   1      5d6h
trident-operator-dockercfg-5kpmc     kubernetes.io/dockercfg   1      5d6h
hsuma@plnx-admin:~$ oc get tbc backend-infra-nfs -n trident -o jsonpath='{.spec.credentials}' | jq .
{
  "name": "backend-infra-secret"
}
hsuma@plnx-admin:~$


App$vm2026!Tr1dent
hsuma@plnx-admin:~$ curl -k -u vsadmin:'<redacted>' https://10.172.254.47/api/cluster
{
  "name": "plano_aff_cl",
  "uuid": "a111a540-0e0d-11ef-8e7d-d039eabbae46",
  "version": {
    "full": "NetApp Release 9.16.1P3: Thu Apr 24 02:50:10 UTC 2025",
    "generation": 9,
    "major": 16,
    "minor": 1
  },
  "disaggregated": false,
  "_links": {
    "self": {
      "href": "/api/cluster"
    }
  }
}hsuma@plnx-admin:~$


hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ oc get secret backend-app-secret -n trident -o yaml
apiVersion: v1
data:
  password: QXBwJHZtMjAyNiFUcjFkZW50
  username: dnNhZG1pbg==
kind: Secret
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"password":"QXBwJHZtMjAyNiFUcjFkZW50","username":"dnNhZG1pbg=="},"kind":"Secret","metadata":{"annotations":{},"name":"backend-app-secret","namespace":"trident"}}
  creationTimestamp: "2026-02-17T21:31:27Z"
  name: backend-app-secret
  namespace: trident
  resourceVersion: "917369"
  uid: 229faf88-0ead-49fb-a9b0-0622b4518adc
type: Opaque
hsuma@plnx-admin:~$ oc get secrets -n trident
NAME                                 TYPE                      DATA   AGE
backend-app-secret                   Opaque                    2      6d3h
backend-infra-secret                 Opaque                    2      6d3h
builder-dockercfg-9dn8h              kubernetes.io/dockercfg   1      5d6h
default-dockercfg-bdwm2              kubernetes.io/dockercfg   1      5d6h
deployer-dockercfg-vqr6s             kubernetes.io/dockercfg   1      5d6h
trident-controller-dockercfg-t4s2g   kubernetes.io/dockercfg   1      5d6h
trident-csi                          Opaque                    6      6d3h
trident-encryption-keys              Opaque                    1      6d3h
trident-node-linux-dockercfg-rwf8z   kubernetes.io/dockercfg   1      5d6h
trident-operator-dockercfg-5kpmc     kubernetes.io/dockercfg   1      5d6h
hsuma@plnx-admin:~$ oc get tbc -n trident
NAME                BACKEND NAME        BACKEND UUID                           PHASE   STATUS
backend-app-nfs     backend-app-nfs     27f061fd-e6e4-448c-a4e4-c4302ac4a01a   Bound   Failed
backend-infra-nfs   backend-infra-nfs   88ba74b5-6d56-47cf-a16d-9066ae716681   Bound   Failed
hsuma@plnx-admin:~$ oc get tbc -n trident backend-app-nfs -o yaml
apiVersion: trident.netapp.io/v1
kind: TridentBackendConfig
metadata:
  annotations:
    argocd.argoproj.io/tracking-id: trident:trident.netapp.io/TridentBackendConfig:trident/backend-app-nfs
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"trident.netapp.io/v1","kind":"TridentBackendConfig","metadata":{"annotations":{"argocd.argoproj.io/tracking-id":"trident:trident.netapp.io/TridentBackendConfig:trident/backend-app-nfs"},"name":"backend-app-nfs","namespace":"trident"},"spec":{"credentials":{"name":"backend-app-secret"},"dataLIF":"10.172.194.22","defaults":{"exportPolicy":"default","snapshotPolicy":"default","spaceReserve":"none"},"managementLIF":"10.152.0.110","storage":[{"defaults":{"snapshotPolicy":"default","spaceReserve":"none"},"labels":{"environment":"dev"}},{"defaults":{"snapshotPolicy":"default","spaceReserve":"none"},"labels":{"environment":"test"}},{"defaults":{"snapshotPolicy":"default","spaceReserve":"volume"},"labels":{"environment":"prod"}}],"storageDriverName":"ontap-nas","svm":"ocp_app_svm","version":1}}
  creationTimestamp: "2026-02-17T21:31:39Z"
  finalizers:
  - trident.netapp.io
  generation: 7
  name: backend-app-nfs
  namespace: trident
  resourceVersion: "3435002"
  uid: df168257-e589-4246-903d-9d8a493252cc
spec:
  credentials:
    name: backend-app-secret
  dataLIF: 10.172.194.22
  defaults:
    exportPolicy: default
    snapshotPolicy: default
    spaceReserve: none
  managementLIF: 10.152.0.110
  storage:
  - defaults:
      snapshotPolicy: default
      spaceReserve: none
    labels:
      environment: dev
  - defaults:
      snapshotPolicy: default
      spaceReserve: none
    labels:
      environment: test
  - defaults:
      snapshotPolicy: default
      spaceReserve: volume
    labels:
      environment: prod
  storageDriverName: ontap-nas
  svm: ocp_app_svm
  version: 1
status:
  backendInfo:
    backendName: backend-app-nfs
    backendUUID: 27f061fd-e6e4-448c-a4e4-c4302ac4a01a
  deletionPolicy: delete
  lastOperationStatus: Failed
  message: 'Failed to apply the backend update; problem initializing storage driver
    ''ontap-nas'': error initializing ontap-nas driver; could not create Data ONTAP
    API client: error creating ONTAP API client: error reading SVM details: response
    code 401 (Unauthorized): incorrect or missing credentials'
  phase: Bound
hsuma@plnx-admin:~$


sed -i 's/10.152.0.110/10.172.254.47/' trident/backend-app.yaml
sed -i 's/10.152.0.110/10.172.254.46/' trident/backend-infra.yaml
git add trident/
git commit -m "Fix managementLIF - use SVM mgmt LIFs not cluster mgmt"
git push origin main





cat << 'EOF' | oc apply -f -
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: apps-wildcard-tls
  namespace: openshift-ingress
spec:
  secretName: apps-wildcard-tls
  duration: 8760h
  renewBefore: 720h
  commonName: "*.apps.ocp-ai.calix.local"
  dnsNames:
  - "*.apps.ocp-ai.calix.local"
  issuerRef:
    name: vault-issuer
    kind: ClusterIssuer
EOF



cat << 'EOF' | oc apply -f -
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: api-tls
  namespace: openshift-config
spec:
  secretName: api-tls
  duration: 8760h
  renewBefore: 720h
  commonName: api.ocp-ai.calix.local
  dnsNames:
  - api.ocp-ai.calix.local
  issuerRef:
    name: vault-issuer
    kind: ClusterIssuer
EOF



oc get certificate -n openshift-ingress
oc get certificate -n openshift-config



oc patch ingresscontroller default -n openshift-ingress-operator \
  --type merge \
  -p '{"spec":{"defaultCertificate":{"name":"apps-wildcard-tls"}}}'



oc patch apiserver cluster \
  --type merge \
  -p '{"spec":{"servingCerts":{"namedCertificates":[{"names":["api.ocp-ai.calix.local"],"servingCertificate":{"name":"api-tls"}}]}}}'


curl -v https://console-openshift-console.apps.ocp-ai.calix.local 2>&1 | grep issuer
curl -v https://api.ocp-ai.calix.local:6443 2>&1 | grep issuer


hsuma@plnx-admin:~/ocp-ai-config$
hsuma@plnx-admin:~/ocp-ai-config$ cat << 'EOF' | oc apply -f -
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: apps-wildcard-tls
  namespace: openshift-ingress
spec:
  secretName: apps-wildcard-tls
  duration: 8760h
  renewBefore: 720h
  commonName: "*.apps.ocp-ai.calix.local"
  dnsNames:
  - "*.apps.ocp-ai.calix.local"
  issuerRef:
    name: vault-issuer
    kind: ClusterIssuer
EOF
Warning: spec.privateKey.rotationPolicy: In cert-manager >= v1.18.0, the default value changed from `Never` to `Always`.
certificate.cert-manager.io/apps-wildcard-tls created
hsuma@plnx-admin:~/ocp-ai-config$
hsuma@plnx-admin:~/ocp-ai-config$
hsuma@plnx-admin:~/ocp-ai-config$


hsuma@plnx-admin:~/ocp-ai-config$ oc get co kube-apiserver openshift-apiserver authentication
NAME                  VERSION   AVAILABLE   PROGRESSING   DEGRADED   SINCE   MESSAGE
kube-apiserver        4.20.13   True        True          False      8d      NodeInstallerProgressing: 3 nodes are at revision 12; 0 nodes have achieved new revision 13
openshift-apiserver   4.20.13   True        False         False      8d
authentication        4.20.13   True        False         True       115s    RouterCertsDegraded: secret/v4-0-config-system-router-certs.spec.data[apps.ocp-ai.calix.local] -n openshift-authentication: certificate could not validate route hostname oauth-openshift.apps.ocp-ai.calix.local: x509: certificate signed by unknown authority
hsuma@plnx-admin:~/ocp-ai-config$
hsuma@plnx-admin:~/ocp-ai-config$
hsuma@plnx-admin:~/ocp-ai-config$




vault read -field=certificate pki_root/cert/ca > /tmp/ocp-ai-root-ca.crt



oc create configmap custom-ca-bundle \
  -n openshift-config \
  --from-file=ca-bundle.crt=/tmp/ocp-ai-root-ca.crt



oc patch proxy/cluster \
  --type merge \
  -p '{"spec":{"trustedCA":{"name":"custom-ca-bundle"}}}'


watch oc get co authentication kube-apiserver

