- name: Register systems with Landscape On-Prem
  hosts: all
  become: true
  vars:
    landscape_server_ip: 10.172.249.104

  tasks:

    - name: Stop Landscape client (optional)
      service:
        name: landscape-client
        state: stopped
      ignore_errors: true
      tags: reset

    - name: Remove old client registration files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /var/lib/landscape/client.conf
        - /var/lib/landscape/landscape-id
      tags: reset

    - name: Try updating apt cache (continue even if it fails)
      apt:
        update_cache: yes
        cache_valid_time: 3600
      ignore_errors: true

    - name: Ensure landscape-client is installed
      apt:
        name: landscape-client
        state: present

    - name: Ensure Landscape cert directory exists
      file:
        path: /etc/landscape
        state: directory
        mode: '0755'

    - name: Copy Landscape server certificate
      copy:
        src: files/landscape-server.pem
        dest: /etc/landscape/landscape.pem
        mode: '0644'

    - name: Register with Landscape (no registration key required)
      shell: |
        landscape-config \
          --computer-title "$(hostname)" \
          --account-name standalone \
          --url "https://{{ landscape_server_ip }}/message-system" \
          --ssl-public-key /etc/landscape/landscape.pem \
          --ping-url "http://{{ landscape_server_ip }}/ping" \
          --silent
      args:
        creates: /var/lib/landscape/client.conf
