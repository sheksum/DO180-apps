- name: Register systems with Landscape On-Prem
  hosts: all
  become: true
  vars:
    landscape_server_ip: 10.172.249.104
  tasks:
    - name: Ensure Landscape cert directory exists
      file:
        path: /etc/landscape
        state: directory
        mode: '0755'

    - name: Copy Landscape server certificate
      copy:
        src: files/landscape-server.pem
        dest: /etc/landscape/landscape.pem
        mode: '0644'

    - name: Register with Landscape (no registration key)
      shell: |
        /usr/bin/landscape-config \
          --computer-title "$(hostname)" \
          --account-name standalone \
          --url "https://{{ landscape_server_ip }}/message-system" \
          --ssl-public-key /etc/landscape/landscape.pem \
          --ping-url "http://{{ landscape_server_ip }}/ping" \
          --silent
      args:
        creates: /var/lib/landscape/client.conf
