# RKE2 Air-Gapped Installation on RHEL 9

This document describes how to install **RKE2 (Rancher Kubernetes Engine 2)** in a **fully air-gapped environment** on **RHEL 9**, using an on-prem private image registry.

## Environment

- OS: RHEL 9
- Kubernetes: RKE2
- Registry: img-registry.ttmtech.local
- Registry Access: HTTPS (internal CA)
- Internet Access: None

---

## 0. Required Artifacts (Pre-staged)

The following files must be copied into the air-gapped environment:

- get.rke2.io
- rke2.linux-amd64.tar.gz
- rke2-images.linux-amd64.tar.zst
- registry-ca.crt

Pin a specific RKE2 version. Do not use latest.

---

## 1. Node Preparation (All Nodes)

### Disable Swap
```bash
swapoff -a
sed -i.bak '/\sswap\s/s/^/#/' /etc/fstab
```

### Kernel Modules
```bash
cat <<EOF | tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

modprobe overlay
modprobe br_netfilter
```

### sysctl Settings
```bash
cat <<EOF | tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

sysctl --system
```

### Required Packages
```bash
dnf install -y curl tar unzip jq
```

---

## 2. Trust the Registry CA

```bash
cp registry-ca.crt /etc/pki/ca-trust/source/anchors/
update-ca-trust
```

Verify:
```bash
openssl s_client -connect img-registry.ttmtech.local:443 \
-servername img-registry.ttmtech.local </dev/null 2>/dev/null \
| openssl x509 -noout -subject -issuer
```

---

## 3. Configure Registry for RKE2

Create on **every node**:

### /etc/rancher/rke2/registries.yaml
```yaml
mirrors:
  docker.io:
    endpoint:
      - "https://img-registry.ttmtech.local"
  registry.k8s.io:
    endpoint:
      - "https://img-registry.ttmtech.local"
  ghcr.io:
    endpoint:
      - "https://img-registry.ttmtech.local"
  quay.io:
    endpoint:
      - "https://img-registry.ttmtech.local"

configs:
  "img-registry.ttmtech.local":
    tls:
      ca_file: /etc/pki/ca-trust/source/anchors/registry-ca.crt
```

---

## 4. Stage RKE2 Images (Air-Gap Trigger)

```bash
mkdir -p /var/lib/rancher/rke2/agent/images
cp rke2-images.linux-amd64.tar.zst /var/lib/rancher/rke2/agent/images/
```

---

## 5. Install RKE2 (Offline)

```bash
chmod +x get.rke2.io
```

### Control Plane
```bash
INSTALL_RKE2_TYPE=server \
INSTALL_RKE2_METHOD=tar \
sh ./get.rke2.io
```

### Worker
```bash
INSTALL_RKE2_TYPE=agent \
INSTALL_RKE2_METHOD=tar \
sh ./get.rke2.io
```

---

## 6. First Control Plane Configuration

### /etc/rancher/rke2/config.yaml
```yaml
token: "REPLACE_WITH_STRONG_TOKEN"
write-kubeconfig-mode: "0644"
tls-san:
  - "k8s-api.ttmtech.local"
```

Start:
```bash
systemctl enable rke2-server --now
```

Verify:
```bash
export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
/var/lib/rancher/rke2/bin/kubectl get nodes -o wide
```

---

## 7. Join Additional Control Planes (HA)

```yaml
server: https://k8s-api.ttmtech.local:9345
token: "REPLACE_WITH_STRONG_TOKEN"
write-kubeconfig-mode: "0644"
```

```bash
systemctl enable rke2-server --now
```

---

## 8. Join Worker Nodes

```yaml
server: https://k8s-api.ttmtech.local:9345
token: "REPLACE_WITH_STRONG_TOKEN"
```

```bash
systemctl enable rke2-agent --now
```

---

## 9. Firewall Ports (Minimum)

```bash
firewall-cmd --permanent --add-port=6443/tcp
firewall-cmd --permanent --add-port=9345/tcp
firewall-cmd --permanent --add-port=2379-2380/tcp
firewall-cmd --reload
```

---

## 10. Validate Air-Gap

```bash
kubectl get pods -A -o wide
```

```bash
kubectl get pods -A \
-o jsonpath='{range .items[*]}{.metadata.namespace}{"\t"}{.metadata.name}{"\t"}{.spec.containers[*].image}{"\n"}{end}'
```

All images must resolve through:

img-registry.ttmtech.local

---

## Troubleshooting

```bash
journalctl -u rke2-server -f
journalctl -u rke2-agent -f
```

Common issues:
- Missing registries.yaml
- Registry CA not trusted
- Image tarball not present
- Unmirrored add-on images
