vault secrets enable -path=pki_root pki
vault secrets tune -max-lease-ttl=87600h pki_root


vault write -format=json pki_root/root/generate/internal \
  common_name="OCP-AI Temporary Root CA" \
  ttl=87600h | jq -r '.data.certificate' > /tmp/root-ca.pem


vault write -format=json pki_root/root/sign-intermediate \
  csr=@/tmp/ocp-ai-intermediate.csr \
  format=pem_bundle \
  ttl=43800h | jq -r '.data.certificate' > /tmp/signed-intermediate.pem


vault write pki_int/intermediate/set-signed certificate=@/tmp/signed-intermediate.pem


vault write pki_int/config/urls \
  issuing_certificates="https://plnx-vault.calix.local:8200/v1/pki_int/ca" \
  crl_distribution_points="https://plnx-vault.calix.local:8200/v1/pki_int/crl"


vault write pki_int/roles/ocp-ai \
  allowed_domains="calix.local" \
  allow_subdomains=true \
  allow_wildcard_certificates=true \
  max_ttl=8760h


vault write pki_int/issue/ocp-ai \
  common_name="test.ocp-ai.calix.local" \
  ttl=24h


# Get the API server URL
oc cluster-info | grep "Kubernetes control plane"

# Get the CA cert
oc get configmap kube-root-ca.crt -n openshift-gitops -o jsonpath='{.data.ca\.crt}' > /tmp/k8s-ca.crt

# Create a service account for Vault auth
oc create sa vault-auth -n cert-manager
oc adm policy add-cluster-role-to-user system:auth-delegator -z vault-auth -n cert-manager

# Get the SA token
oc create token vault-auth -n cert-manager --duration=87600h



vault write auth/kubernetes-ocp-ai/config \
  kubernetes_host="https://api.ocp-ai.calix.local:6443" \
  kubernetes_ca_cert=@/tmp/ocp-ai-k8s-ca.crt \
  token_reviewer_jwt="PASTE_TOKEN_HERE"



vault policy write ocp-ai-cert-manager - <<EOF
path "pki_int/issue/ocp-ai" {
  capabilities = ["create", "update"]
}
path "pki_int/sign/ocp-ai" {
  capabilities = ["create", "update"]
}
EOF



vault write auth/kubernetes-ocp-ai/role/cert-manager \
  bound_service_account_names=vault-auth \
  bound_service_account_namespaces=cert-manager \
  policies=ocp-ai-cert-manager \
  ttl=1h


[root@plnx-vault ~]#
[root@plnx-vault ~]# vault write auth/kubernetes-ocp-ai/role/cert-manager \
  bound_service_account_names=vault-auth \
  bound_service_account_namespaces=cert-manager \
  policies=ocp-ai-cert-manager \
  ttl=1h
WARNING! The following warnings were returned from Vault:

  * Role cert-manager does not have an audience configured. While audiences
  are not required, consider specifying one if your use case would benefit
  from additional JWT claim verification.

[root@plnx-vault ~]#




cat <<'EOF' | oc apply -f -
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: vault-issuer
spec:
  vault:
    path: pki_int/sign/ocp-ai
    server: https://plnx-vault.calix.local:8200
    caBundle: ""
    auth:
      kubernetes:
        role: cert-manager
        mountPath: /v1/auth/kubernetes-ocp-ai
        serviceAccountRef:
          name: vault-auth
EOF
