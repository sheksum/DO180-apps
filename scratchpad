vault secrets enable -path=pki_root pki
vault secrets tune -max-lease-ttl=87600h pki_root


vault write -format=json pki_root/root/generate/internal \
  common_name="OCP-AI Temporary Root CA" \
  ttl=87600h | jq -r '.data.certificate' > /tmp/root-ca.pem


vault write -format=json pki_root/root/sign-intermediate \
  csr=@/tmp/ocp-ai-intermediate.csr \
  format=pem_bundle \
  ttl=43800h | jq -r '.data.certificate' > /tmp/signed-intermediate.pem


vault write pki_int/intermediate/set-signed certificate=@/tmp/signed-intermediate.pem


vault write pki_int/config/urls \
  issuing_certificates="https://plnx-vault.calix.local:8200/v1/pki_int/ca" \
  crl_distribution_points="https://plnx-vault.calix.local:8200/v1/pki_int/crl"


vault write pki_int/roles/ocp-ai \
  allowed_domains="calix.local" \
  allow_subdomains=true \
  allow_wildcard_certificates=true \
  max_ttl=8760h


vault write pki_int/issue/ocp-ai \
  common_name="test.ocp-ai.calix.local" \
  ttl=24h


# Get the API server URL
oc cluster-info | grep "Kubernetes control plane"

# Get the CA cert
oc get configmap kube-root-ca.crt -n openshift-gitops -o jsonpath='{.data.ca\.crt}' > /tmp/k8s-ca.crt

# Create a service account for Vault auth
oc create sa vault-auth -n cert-manager
oc adm policy add-cluster-role-to-user system:auth-delegator -z vault-auth -n cert-manager

# Get the SA token
oc create token vault-auth -n cert-manager --duration=87600h



vault write auth/kubernetes-ocp-ai/config \
  kubernetes_host="https://api.ocp-ai.calix.local:6443" \
  kubernetes_ca_cert=@/tmp/ocp-ai-k8s-ca.crt \
  token_reviewer_jwt="PASTE_TOKEN_HERE"



vault policy write ocp-ai-cert-manager - <<EOF
path "pki_int/issue/ocp-ai" {
  capabilities = ["create", "update"]
}
path "pki_int/sign/ocp-ai" {
  capabilities = ["create", "update"]
}
EOF



vault write auth/kubernetes-ocp-ai/role/cert-manager \
  bound_service_account_names=vault-auth \
  bound_service_account_namespaces=cert-manager \
  policies=ocp-ai-cert-manager \
  ttl=1h


[root@plnx-vault ~]#
[root@plnx-vault ~]# vault write auth/kubernetes-ocp-ai/role/cert-manager \
  bound_service_account_names=vault-auth \
  bound_service_account_namespaces=cert-manager \
  policies=ocp-ai-cert-manager \
  ttl=1h
WARNING! The following warnings were returned from Vault:

  * Role cert-manager does not have an audience configured. While audiences
  are not required, consider specifying one if your use case would benefit
  from additional JWT claim verification.

[root@plnx-vault ~]#




cat <<'EOF' | oc apply -f -
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: vault-issuer
spec:
  vault:
    path: pki_int/sign/ocp-ai
    server: https://plnx-vault.calix.local:8200
    caBundle: ""
    auth:
      kubernetes:
        role: cert-manager
        mountPath: /v1/auth/kubernetes-ocp-ai
        serviceAccountRef:
          name: vault-auth
EOF


The ClusterIssuer "vault-issuer" is invalid: spec.vault.caBundle: Invalid value: "": spec.vault.caBundle in body must be of type byte: ""
hsuma@plnx-admin:~/ocp-ai-config$


echo | openssl s_client -connect plnx-vault.calix.local:8200 2>/dev/null | openssl x509 -outform PEM | base64 -w0


cat <<'EOF' | oc apply -f -
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: vault-issuer
spec:
  vault:
    path: pki_int/sign/ocp-ai
    server: https://plnx-vault.calix.local:8200
    caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZGRENDQXZ5Z0F3SUJBZ0lVVFdVYktqa3BYdE1QS0VKNkxnRHkrMGlxN3FVd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0lURWZNQjBHQTFVRUF3d1djR3h1ZUMxMllYVnNkQzVqWVd4cGVDNXNiMk5oYkRBZUZ3MHlOVEV5TURZeApPVEE0TVRGYUZ3MHlOakV5TURZeE9UQTRNVEZhTUNFeEh6QWRCZ05WQkFNTUZuQnNibmd0ZG1GMWJIUXVZMkZzCmFYZ3ViRzlqWVd3d2dnSWlNQTBHQ1NxR1NJYjNEUUVCQVFVQUE0SUNEd0F3Z2dJS0FvSUNBUURNNU10SzI2aE4Ka3pQcTJxbXRRK24zSGVJZ1dCbHRlUm1XKzEvbEdsQnNzUDhCN3JjYzk0SDF3SHZBNytrYXlXdEVYODR5RWNLdApJeVBGS1QzSzVxbCtCNHlQOEhoSXBYL0tidjFTMC93blpNMDRyd05EZ1VlL3lHWnVDbEJDdEw5U2E5UGZxaHR1ClF1SXRsUEdLTHpkQnB5Y042dXo0VEE1WWViSm5ENTRFeklxYXJDaDY0Yy9FWVJUZzR3NWlDK3NSRnpVc1k0bFcKdWFvZmJheW9OOUF2Nm5rUWJHLytJZEtuVVR1VVc2c01tMUFTSGxObGhlWDJMOHRlYm5jNm0wUVcxd1o5cHhuVwpRT2l3YTgweHhiWHZHVSs4U0JtQlpwTkR6ZURHeVgxdE8ySnlZcUNpWWdrZmpxdU8rdzd0bWQyOE05NFQ3ZjlRCitxbmlmaW9TNWVRR1l1MDIvT0o2cFZyWEluRjhHT21WeFp1SHRQZGlnKzBLOTNyeUxkU0xLTmNuQmVJcEtmaWkKemJERVEwRU8xN0ZmOExrb2I1YUUzTHNlaW5YTFlIbVZCT1BtZm9UNnpMa2J6aTBWMnJUcEhWRUVuQzErd09jRApVdzlrNEZ2S1hoQUFpUGE5SFVsak1WdnM2bEI0UVlaZlVzbFRnUTVRT3lXQjNsZ25PbDdMcWdBTytKMDduYnZnCm9iYnhtTHcyaktTbGxEU0JCdE91c3Y5NEFCRExoTktQNWlmYkJTZ3d3eWw1Zk5LWDZ4V1JmbWxsZFF5TFBMQm0KVmI1THh0ejh4VXhUWU5QbEdTZW5EVFZadlR6akQ0T0xad2xJRllzSG9qSE42M1hERlNKQU53eWw5ejZibEl6bAowbC9KTnJTT1hvaWJPM0dDWXZmSkpoTlB5UWV1clRZcC9RSURBUUFCbzBRd1FqQWhCZ05WSFJFRUdqQVlnaFp3CmJHNTRMWFpoZFd4MExtTmhiR2w0TG14dlkyRnNNQjBHQTFVZERnUVdCQlJ5d3VnOVA5SjBjU2hsaGlUckxWbzAKbm95N2FEQU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FnRUFKaE1IckZnT1N5aGxoTUxyNWF5WURKb0laRU5rcjdyUQpoOHgrQmJ0U1VMQzlXcEFXMXc3TEprU0dHQTZTdko0ZVFIL3FuT3ZqLytpencwSWVEVis2K0JxYUFwb1IzQlYwCjAzOTQwVjViWDZMQ0s3OXpCMUpqM1RXamNpZktQOHR2NWFFOEZENmV1MlhFcm5KcHJjSFFBdWNwbmtXSXVmajUKNzYvK1FIdUVUWTc5WVRSNi9SbDBDSFJubTI4bU9vN1VBY2F4TnBvbVFxYkNYaXZwWksybnVHMmdxWU9UY01KRAp4R0p5a0ZMMzBTUEp4cWJrVUJXcVEzK28zYzVnekNITVRUTmtkdGZhcVdiZHRMV1VHaGR2dVpaM0xIWERoNm9QCktZNEphdjBNRXlEUlExSkM5OWxCSjdBRnd3NmZZWEdldVN4Q25zSzROcmVIVDkxUnpGOUtZSFAxejhlQUd2dW4KeE5QMk1zWlpybmdHc2VWNWN1WmpKallDckgyZllWK0VWOWpVcFhEUXI0ZVA3czVHZmNPN0NiSk5WZE02aDJsawpXN0Naald5YmZySC9HYmRTTjV2MWRPSW5RbjZ4cFBmdW0zLzFEeEIzSnJuRXFIOXE0WktRUVRtNDhBb2tYTjhsCk4rMWlUeGFZU094N2RZamZJWllPL0p4b3R3am1PZm0rS3RsWVlZdlBQRzRaaTJhb0dDMzFuOXhReGt5eHlPTUoKQ1RaTFptbzlGSU1JUyszKzB1QmlvakNUa25IMW5zNFJ2UWhWTkh1c3RrR2FlZUlQemx4SmI1K3pPNWdaa2dYbgpFWUpJUHZPUXBYSDdiVXh0dkJuS1lCQmJTMkhWaElCKzV5eW50WXNRb0R4Tk9wUlR4SVF1ektWUm5lUHBVWk1CCmJ1TkZoeUFiTEw4PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    auth:
      kubernetes:
        role: cert-manager
        mountPath: /v1/auth/kubernetes-ocp-ai
        serviceAccountRef:
          name: vault-auth
EOF

  Conditions:
    Last Transition Time:  2026-02-19T21:06:58Z
    Message:               Failed to initialize Vault client: while requesting a Vault token using the Kubernetes auth: while requesting a token for the service account /vault-auth: serviceaccounts "vault-auth" is forbidden: User "system:serviceaccount:cert-manager:cert-manager" cannot create resource "serviceaccounts/token" in API group "" in the namespace "cert-manager"
    Observed Generation:   1
    Reason:                VaultError
    Status:                False
    Type:                  Ready
Events:
  Type     Reason         Age               From                         Message
  ----     ------         ----              ----                         -------
  Warning  ErrInitIssuer  9s (x5 over 74s)  cert-manager-clusterissuers  Error initializing issuer: while requesting a Vault token using the Kubernetes auth: while requesting a token for the service account /vault-auth: serviceaccounts "vault-auth" is forbidden: User "system:serviceaccount:cert-manager:cert-manager" cannot create resource "serviceaccounts/token" in API group "" in the namespace "cert-manager"





cat <<'EOF' | oc apply -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cert-manager-vault-tokenrequest
rules:
- apiGroups: [""]
  resources: ["serviceaccounts/token"]
  verbs: ["create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cert-manager-vault-tokenrequest
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cert-manager-vault-tokenrequest
subjects:
- kind: ServiceAccount
  name: cert-manager
  namespace: cert-manager
EOF


    Last Transition Time:  2026-02-19T21:11:27Z
    Message:               Failed to initialize Vault client: while requesting a Vault token using the Kubernetes auth: error calling Vault server: Post "https://plnx-vault.calix.local:8200/v1/auth/kubernetes-ocp-ai/login": tls: failed to verify certificate: x509: certificate signed by unknown authority (possibly because of "x509: invalid signature: parent certificate cannot sign this kind of certificate" while trying to verify candidate authority certificate "plnx-vault.calix.local")
    Observed Generation:   1
    Reason:                VaultError
    Status:                False
    Type:                  Ready
Events:
  Type     Reason         Age                From                         Message
  ----     ------         ----               ----                         -------
  Warning  ErrInitIssuer  39s (x4 over 64s)  cert-manager-clusterissuers  Error initializing issuer: while requesting a Vault token using the Kubernetes auth: error calling Vault server: Post "https://plnx-vault.calix.local:8200/v1/auth/kubernetes-ocp-ai/login": tls: failed to verify certificate: x509: certificate signed by unknown authority (possibly because of "x509: invalid signature: parent certificate cannot sign this kind of certificate" while trying to verify candidate authority certificate "plnx-vault.calix.local")
hsuma@plnx-admin:~/ocp-ai-config$



    Last Transition Time:  2026-02-19T21:11:27Z
    Message:               Failed to initialize Vault client: while requesting a Vault token using the Kubernetes auth: error calling Vault server: Post "https://plnx-vault.calix.local:8200/v1/auth/kubernetes-ocp-ai/login": tls: failed to verify certificate: x509: certificate signed by unknown authority (possibly because of "x509: invalid signature: parent certificate cannot sign this kind of certificate" while trying to verify candidate authority certificate "plnx-vault.calix.local")
    Observed Generation:   1
    Reason:                VaultError
    Status:                False
    Type:                  Ready
Events:
  Type     Reason         Age                From                         Message
  ----     ------         ----               ----                         -------
  Warning  ErrInitIssuer  39s (x4 over 64s)  cert-manager-clusterissuers  Error initializing issuer: while requesting a Vault token using the Kubernetes auth: error calling Vault server: Post "https://plnx-vault.calix.local:8200/v1/auth/kubernetes-ocp-ai/login": tls: failed to verify certificate: x509: certificate signed by unknown authority (possibly because of "x509: invalid signature: parent certificate cannot sign this kind of certificate" while trying to verify candidate authority certificate "plnx-vault.calix.local")
hsuma@plnx-admin:~/ocp-ai-config$




openssl req -x509 -newkey rsa:4096 -sha256 -days 365 \
  -nodes -keyout /opt/vault/tls/tls.key \
  -out /opt/vault/tls/tls.crt \
  -subj "/CN=plnx-vault.calix.local" \
  -addext "subjectAltName=DNS:plnx-vault.calix.local" \
  -addext "basicConstraints=critical,CA:TRUE"



cat <<EOF | oc apply -f -
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: vault-issuer
spec:
  vault:
    path: pki_int/sign/ocp-ai
    server: https://plnx-vault.calix.local:8200
    caBundle: PASTE_BASE64_HERE
    auth:
      kubernetes:
        role: cert-manager
        mountPath: /v1/auth/kubernetes-ocp-ai
        serviceAccountRef:
          name: vault-auth
EOF





cat <<'EOF' | oc apply -f -
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: test-cert
  namespace: default
spec:
  secretName: test-cert-tls
  issuerRef:
    name: vault-issuer
    kind: ClusterIssuer
  commonName: test.ocp-ai.calix.local
  dnsNames:
    - test.ocp-ai.calix.local
EOF
