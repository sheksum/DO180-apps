vault secrets enable -path=pki_root pki
vault secrets tune -max-lease-ttl=87600h pki_root


vault write -format=json pki_root/root/generate/internal \
  common_name="OCP-AI Temporary Root CA" \
  ttl=87600h | jq -r '.data.certificate' > /tmp/root-ca.pem


vault write -format=json pki_root/root/sign-intermediate \
  csr=@/tmp/ocp-ai-intermediate.csr \
  format=pem_bundle \
  ttl=43800h | jq -r '.data.certificate' > /tmp/signed-intermediate.pem


vault write pki_int/intermediate/set-signed certificate=@/tmp/signed-intermediate.pem


vault write pki_int/config/urls \
  issuing_certificates="https://plnx-vault.calix.local:8200/v1/pki_int/ca" \
  crl_distribution_points="https://plnx-vault.calix.local:8200/v1/pki_int/crl"


vault write pki_int/roles/ocp-ai \
  allowed_domains="calix.local" \
  allow_subdomains=true \
  allow_wildcard_certificates=true \
  max_ttl=8760h


vault write pki_int/issue/ocp-ai \
  common_name="test.ocp-ai.calix.local" \
  ttl=24h


# Get the API server URL
oc cluster-info | grep "Kubernetes control plane"

# Get the CA cert
oc get configmap kube-root-ca.crt -n openshift-gitops -o jsonpath='{.data.ca\.crt}' > /tmp/k8s-ca.crt

# Create a service account for Vault auth
oc create sa vault-auth -n cert-manager
oc adm policy add-cluster-role-to-user system:auth-delegator -z vault-auth -n cert-manager

# Get the SA token
oc create token vault-auth -n cert-manager --duration=87600h



[root@plnx-vault ~]# vault read auth/kubernetes/config
Key                                  Value
---                                  -----
disable_iss_validation               true
disable_local_ca_jwt                 false
issuer                               n/a
kubernetes_ca_cert                   -----BEGIN CERTIFICATE-----
MIIBejCCAR+gAwIBAgIBADAKBggqhkjOPQQDAjAkMSIwIAYDVQQDDBlya2UyLXNl cnZlci1jYUAxNzUzNzU2NDI5MB4XDTI1MDcyOTAyMzM0OVoXDTM1MDcyNzAyMzM0 OVowJDEiMCAGA1UEAwwZcmtlMi1zZXJ2ZXItY2FAMTc1Mzc1NjQyOTBZMBMGByqG SM49AgEGCCqGSM49AwEHA0IABCRXBINMz0JPfpLCqfw2XtFRElyRO1PUhy2BloOa 3dLszJ4WVmeXcYEqN0Uneq84jM9gXkuIdydDK6fHI79Xu5ajQjBAMA4GA1UdDwEB /wQEAwICpDAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBTezOHXA4jcuWRNWerD D9cO6oGXYTAKBggqhkjOPQQDAgNJADBGAiEAjqxsXaDEvh6KePHJmjv9tFHim5bN eSLpwuhuujtZ3SACIQDCLPFF5bus14ncvWWNMX34we9C/XQhy7xtDV5sjwnmbQ==
-----END CERTIFICATE-----
kubernetes_host                      10.172.249.105:6443
pem_keys                             []
token_reviewer_jwt_set               true
use_annotations_as_alias_metadata    false
[root@plnx-vault ~]#

