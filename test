#!/bin/bash

# Retrieve the list of all namespaces in the cluster
current_namespaces=$(kubectl get namespaces -o jsonpath='{.items[*].metadata.name}')

# Retrieve the list of all IP pools (e.g., from Calico or your CNI)
# Adjust this for your CNI, here it's assumed you're using Calico
allocated_ips=$(calicoctl get ippool -o json | jq -r '.items[].metadata.name')

# Loop through each IP pool
for ip_pool in $allocated_ips; do
    # Check if the IP pool corresponds to an existing namespace
    if echo "$current_namespaces" | grep -q "$ip_pool"; then
        # IP pool is in use, as the namespace exists
        echo "IP pool '$ip_pool' is in use by the namespace."
    else
        # IP pool is unused, as the namespace no longer exists
        echo "IP pool '$ip_pool' is unused and should be cleaned up."
    fi
done
