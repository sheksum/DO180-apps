Dear Team,
Today we have noticed that the connectivity the connectivity between bamboo ,bitbucket(stash,pln-stash) has been broken.When we investigate the issue the application level, we  have noticed that the below error messages in the atlassian-bamboo.log.


2025-11-24 08:11:38,258 WARN [support-zip] [DefaultRuntimeHelper] Failed to spawn a process
java.io.IOException: Cannot run program "/usr/bin/git": error=0, Failed to exec spawn helper: pid: 1769215, exit value: 1
	at java.lang.ProcessBuilder.start(ProcessBuilder.java:1143) ~[?:?]
	at java.lang.ProcessBuilder.start(ProcessBuilder.java:1073) ~[?:?]
	at java.lang.Runtime.exec(Runtime.java:594) ~[?:?]
	at java.lang.Runtime.exec(Runtime.java:453) ~[?:?]
2025-11-24 08:12:01,198 ERROR [12-DelayedChangeDetectionThread:pool-13-thread-64048] [ChainExecutionManagerImpl] Plan 'CCS-DTMITYSEFS27' could not be started. Exception: com.atlassian.bamboo.plugins.stash.repository.StashRepositoryException: com.atlassian.bamboo.repository.RepositoryException: com.atlassian.bamboo.executor.CancelException: /usr/bin/git could not be started: command [/usr/bin/git version] failed with code -1. Working directory was [/]. []
com.atlassian.bamboo.repository.RepositoryException: com.atlassian.bamboo.plugins.stash.repository.StashRepositoryException: com.atlassian.bamboo.repository.RepositoryException: com.atlassian.bamboo.executor.CancelException: /usr/bin/git could not be started: command [/usr/bin/git version] failed with code -1. Working directory was [/]. []
	at com.atlassian.bamboo.v2.trigger.DefaultChangeDetectionManager.collectInitialStateForBranchBuild(DefaultChangeDetectionManager.java:387) ~[atlassian-bamboo-core-9.6.16.jar:?]
	at com.atlassian.bamboo.v2.trigger.DefaultChangeDetectionManager.collectAllChangesSinceLastBuild(DefaultChangeDetectionManager.java:172) ~[atlassian-bamboo-core-9.6.16.jar:?]
	at com.atlassian.bamboo.v2.trigger.DefaultChangeDetectionManager.collectAllChangesSinceLastBuild(DefaultChangeDetectionManager.java:211) ~[atlassian-bamboo-core-9.6.16.jar:?]
	at com.atlassian.bamboo.v2.trigger.InitialBuildDetectionAction.performDelayedChangeDetection(InitialBuildDetectionAction.java:76) ~[atlassian-bamboo-core-9.6.16.jar:?]
	at com.atlassian.bamboo.chains.ChainExecutionManagerImpl$1.getChainState(ChainExecutionManagerImpl.java:281) ~[atlassian-bamboo-core-9.6.16.jar:?]
	at com.atlassian.bamboo.chains.ChainExecutionManagerImpl.tryStartChainState(ChainExecutionManagerImpl.java:355) ~[atlassian-bamboo-core-9.6.16.jar:?]
	at com.atlassian.bamboo.chains.ChainExecutionManagerImpl.delayedStart(ChainExecutionManagerImpl.java:273) ~[atlassian-bamboo-core-9.6.16.jar:?]
	at jdk.internal.reflect.GeneratedMethodAccessor3074.invoke(Unknown Source) ~[?:?
We have verified the /var/log/apt/history.log and /var/log/unattended-upgrades/unattended-upgrades-dpkg.log  to find the RCA and noticed that  below entries in unattended-upgrades-dpkg.log file


Log started: 2025-11-24  06:35:08
(Reading database ... 182764 files and directories currently installed.)
Preparing to unpack .../openjdk-17-jdk_17.0.17+10-1~22.04_amd64.deb ...
Unpacking openjdk-17-jdk:amd64 (17.0.17+10-1~22.04) over (17.0.16+8~us1-0ubuntu1~22.04.1) ...
Preparing to unpack .../openjdk-17-jdk-headless_17.0.17+10-1~22.04_amd64.deb ...
Unpacking openjdk-17-jdk-headless:amd64 (17.0.17+10-1~22.04) over (17.0.16+8~us1-0ubuntu1~22.04.1) ...
Preparing to unpack .../openjdk-17-jre_17.0.17+10-1~22.04_amd64.deb ...
Unpacking openjdk-17-jre:amd64 (17.0.17+10-1~22.04) over (17.0.16+8~us1-0ubuntu1~22.04.1) ...
Preparing to unpack .../openjdk-17-jre-headless_17.0.17+10-1~22.04_amd64.deb ...
Unpacking openjdk-17-jre-headless:amd64 (17.0.17+10-1~22.04) over (17.0.16+8~us1-0ubuntu1~22.04.1) ...
Setting up openjdk-17-jre-headless:amd64 (17.0.17+10-1~22.04) ...
Installing new version of config file /etc/java-17-openjdk/security/default.policy ...
Installing new version of config file /etc/java-17-openjdk/security/java.security ...
Setting up sgml-base (1.30) ...
/var/lib/dpkg/info/sgml-base.postinst: 64: update-catalog: not found
dpkg: error processing package sgml-base (--configure):
 installed sgml-base package post-installation script subprocess returned error exit status 127
dpkg: dependency problems prevent configuration of sgml-data:
 sgml-data depends on sgml-base (>= 1.28); however:
  Package sgml-base is not configured yet.


Previously similar issue happend  we have raised a re quest to disable the  we have disabled the OS level patch upgrades.Please refer the ticket for more information.https://calix.atlassian.net/browse/EOSM-32068 
Could you please let us know if there is any planned activity or change request for the patch level upgrades.





âœ… Root Cause Analysis (RCA)

Host: pln-hoffman (Ubuntu 22.04 / Jammy)
Date: 2025-11-24

Summary

Early this morning the system pulled in OS updates, even though unattended-upgrades was disabled. The apt timers were still active (apt-daily.timer and apt-daily-upgrade.timer), so the system ran its usual 06:30 update cycle.

One of the packages (sgml-base) failed to install cleanly during this run, which left dpkg in a half-configured state. Because of that, AppArmor ended up loading incomplete/old profiles, and those profiles started blocking /usr/bin/git and Python subprocesses. Bamboo relies on git to talk to Bitbucket/Stash, which explains why all Git operations suddenly started failing.

Detailed Findings

sgml-base and sgml-data were unpacked but failed during their post-install scripts because two helper binaries (update-catalog and update-xmlcatalog) were missing.

This caused dpkg to stop in the middle of configuring packages.

AppArmor then loaded an outdated profile set left behind by the failed install.

As soon as Bamboo tried to run pipelines, AppArmor denied the git subprocess calls (DENIED change_onexec, label not found).

The root cause was the unattended apt timers still running, pulling in updates despite the service itself being disabled.

Fix Applied

Restored the missing helper binaries needed by sgml-base / xml-core:

/usr/sbin/update-catalog

update-xmlcatalog no longer required on Jammy; package configured successfully without it.

Forced dpkg to re-run configuration to clean up the broken install.

Verified dpkg state is clean (dpkg --audit shows nothing).

Disabled all apt-related timers to avoid this happening again:

apt-daily.timer

apt-daily-upgrade.timer

Confirmed AppArmor profiles are no longer blocking git.

Current State

dpkg is clean

sgml-base and sgml-data are installed and configured

apt auto-update timers are off

AppArmor no longer blocks /usr/bin/git

System is stable
