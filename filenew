
cat > /tmp/topo-segment.ldif << 'EOF'
dn: cn=cpeg-to-pln,cn=domain,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local
objectClass: ipaReplTopoSegment
objectClass: top
cn: cpeg-to-pln
ipaReplTopoSegmentDirection: both
ipaReplTopoSegmentLeftNode: cpeg-ipareplica.ipa.calix.local
ipaReplTopoSegmentRightNode: pln-petipareplica.ipa.calix.local
EOF

ldapadd -x -H ldap://localhost -D "cn=directory manager" -W -f /tmp/topo-segment.ldif



ldapsearch -x -H ldap://localhost -D "cn=directory manager" -W -b "cn=cpeg-ipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local" -s base "(objectclass=*)" ipaReplTopoManagedSuffix



ldapsearch -x -H ldap://localhost -D "cn=directory manager" -W -b "cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local" -s base "(objectclass=*)" ipaReplTopoManagedSuffix


ldapsearch -Y GSSAPI -H ldap://pln-petipareplica.ipa.calix.local -b "" -s base



kinit -k -t /etc/dirsrv/ds.keytab ldap/cpeg-ipareplica.ipa.calix.local
klist



ldapsearch -x -H ldap://localhost -D "cn=directory manager" -W -b "cn=config" "(nsds5replicahost=pln-petipareplica.ipa.calix.local)" nsds5ReplicaBindMethod nsds5ReplicaTransportInfo nsds5replicaport


klist -kt /etc/dirsrv/ds.keytab


kinit -k -t /etc/dirsrv/ds.keytab ldap/pln-petipareplica.ipa.calix.local


cat > /tmp/pln-services.ldif << 'EOF'
dn: cn=HTTP,cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local
objectClass: nsContainer
objectClass: ipaConfigObject
objectClass: top
cn: HTTP
ipaConfigString: startOrder 40
ipaConfigString: enabledService

dn: cn=OTPD,cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local
objectClass: nsContainer
objectClass: ipaConfigObject
objectClass: top
cn: OTPD
ipaConfigString: startOrder 80
ipaConfigString: enabledService

dn: cn=KEYS,cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local
objectClass: nsContainer
objectClass: ipaConfigObject
objectClass: top
cn: KEYS
ipaConfigString: startOrder 41
ipaConfigString: enabledService
EOF

ldapadd -x -H ldap://localhost -D "cn=directory manager" -W -f /tmp/pln-services.ldif


cat > /tmp/pln-kpasswd.ldif << 'EOF'
dn: cn=KPASSWD,cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local
objectClass: nsContainer
objectClass: ipaConfigObject
objectClass: top
cn: KPASSWD
ipaConfigString: startOrder 20
ipaConfigString: enabledService
EOF

ldapadd -x -H ldap://localhost -D "cn=directory manager" -W -f /tmp/pln-kpasswd.ldif


cat > /tmp/pln-update.ldif << 'EOF'
dn: cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local
changetype: modify
add: objectClass
objectClass: ipaReplTopoManagedServer
objectClass: ipaSupportedDomainLevelConfig
-
add: ipaReplTopoManagedSuffix
ipaReplTopoManagedSuffix: dc=ipa,dc=calix,dc=local
-
add: ipaMinDomainLevel
ipaMinDomainLevel: 1
-
add: ipaMaxDomainLevel
ipaMaxDomainLevel: 1
EOF

ldapmodify -x -H ldap://localhost -D "cn=directory manager" -W -f /tmp/pln-update.ldif

ipa server-role-find --server=pln-petipareplica.ipa.calix.local

ipa topologysegment-add domain --left=cpeg-ipareplica.ipa.calix.local --right=pln-petipareplica.ipa.calix.local








ldapsearch -x -H ldap://localhost -D "cn=directory manager" -W -b "cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local" "(objectclass=*)"






ldapsearch -x -H ldap://localhost -D "cn=directory manager" -W -b "cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local" "(objectclass=*)"


ipa topologysegment-add domain --left=cpeg-ipareplica.ipa.calix.local --right=pln-petipareplica.ipa.calix.local --name=cpeg-to-pln



ldapsearch -x -H ldap://localhost -D "cn=directory manager" -W -b "cn=config" "(nsds5replicahost=pln-petipareplica.ipa.calix.local)" nsds5ReplicaTransportInfo nsds5replicaport




ldapdelete -x -H ldap://localhost -D "cn=directory manager" -W "cn=KDC,cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local"
ldapdelete -x -H ldap://localhost -D "cn=directory manager" -W "cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local"


ipa server-del pln-petipareplica.ipa.calix.local --force


# Verify these still exist
ipa host-show pln-petipareplica.ipa.calix.local
ipa service-show HTTP/pln-petipareplica.ipa.calix.local


ipa-server-install --uninstall --ignore-topology-disconnect
ipa-replica-install --principal admin --admin-password '<password>' --setup-ca --domain ipa.calix.local --server cpeg-ipareplica.ipa.calix.local --realm IPA.CALIX.LOCAL --force-join




ldapsearch -x -H ldap://localhost -D "cn=directory manager" -W -b "cn=KDC,cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local" "(objectclass=*)"


cat > /tmp/pln-kdc.ldif << 'EOF'
dn: cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local
objectClass: nsContainer
objectClass: ipaConfigObject
objectClass: top
cn: pln-petipareplica.ipa.calix.local

dn: cn=KDC,cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local
objectClass: nsContainer
objectClass: ipaConfigObject
objectClass: top
ipaConfigString: startOrder 10
ipaConfigString: configuredService
ipaConfigString: kdcProxyEnabled
ipaConfigString: pkinitEnabled
ipaConfigString: enabledService
cn: KDC
EOF

ldapadd -x -H ldap://localhost -D "cn=directory manager" -W -f /tmp/pln-kdc.ldif




# Check if the KDC entry exists on the master now
ldapsearch -x -H ldap://localhost -D "cn=directory manager" -W -b "cn=KDC,cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local" "(objectclass=*)"


ldapsearch -x -H ldap://localhost -D "cn=directory manager" -W -b "cn=KDC,cn=cpeg-ipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local" "(objectclass=*)"


ldapsearch -x -H ldap://localhost -D "cn=directory manager" -W -b "cn=config" "(objectclass=nsds5replicationagreement)" nsds5replicahost nsds5replicaLastUpdateStatus



ldapsearch -x -H ldap://cpeg-ipareplica.ipa.calix.local -D "cn=directory manager" -W -b "cn=config" "(objectclass=nsds5replicationagreement)" nsds5replicahost nsds5replicaLastUpdateStatus
