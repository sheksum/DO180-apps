
ldapdelete -x -H ldap://localhost -D "cn=directory manager" -W "cn=KDC,cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local"
ldapdelete -x -H ldap://localhost -D "cn=directory manager" -W "cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local"


ipa server-del pln-petipareplica.ipa.calix.local --force


# Verify these still exist
ipa host-show pln-petipareplica.ipa.calix.local
ipa service-show HTTP/pln-petipareplica.ipa.calix.local


ipa-server-install --uninstall --ignore-topology-disconnect
ipa-replica-install --principal admin --admin-password '<password>' --setup-ca --domain ipa.calix.local --server cpeg-ipareplica.ipa.calix.local --realm IPA.CALIX.LOCAL --force-join




ldapsearch -x -H ldap://localhost -D "cn=directory manager" -W -b "cn=KDC,cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local" "(objectclass=*)"


cat > /tmp/pln-kdc.ldif << 'EOF'
dn: cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local
objectClass: nsContainer
objectClass: ipaConfigObject
objectClass: top
cn: pln-petipareplica.ipa.calix.local

dn: cn=KDC,cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local
objectClass: nsContainer
objectClass: ipaConfigObject
objectClass: top
ipaConfigString: startOrder 10
ipaConfigString: configuredService
ipaConfigString: kdcProxyEnabled
ipaConfigString: pkinitEnabled
ipaConfigString: enabledService
cn: KDC
EOF

ldapadd -x -H ldap://localhost -D "cn=directory manager" -W -f /tmp/pln-kdc.ldif




# Check if the KDC entry exists on the master now
ldapsearch -x -H ldap://localhost -D "cn=directory manager" -W -b "cn=KDC,cn=pln-petipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local" "(objectclass=*)"


ldapsearch -x -H ldap://localhost -D "cn=directory manager" -W -b "cn=KDC,cn=cpeg-ipareplica.ipa.calix.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=calix,dc=local" "(objectclass=*)"


ldapsearch -x -H ldap://localhost -D "cn=directory manager" -W -b "cn=config" "(objectclass=nsds5replicationagreement)" nsds5replicahost nsds5replicaLastUpdateStatus



ldapsearch -x -H ldap://cpeg-ipareplica.ipa.calix.local -D "cn=directory manager" -W -b "cn=config" "(objectclass=nsds5replicationagreement)" nsds5replicahost nsds5replicaLastUpdateStatus
