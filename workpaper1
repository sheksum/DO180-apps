hsuma@plnx-admin:~/ocp-ai-config$ oc describe mcp worker grep worker | grep -A10 Degraded
    Type:                  PinnedImageSetsDegraded
    Last Transition Time:  2026-02-15T22:46:19Z
    Message:
    Reason:
    Status:                False
    Type:                  NodeDegraded
    Last Transition Time:  2026-02-26T19:13:52Z
    Message:               All nodes are updated with MachineConfig rendered-worker-3c8750c881df6f82403924904fac6469
    Reason:
    Status:                True
    Type:                  Updated
    Last Transition Time:  2026-02-26T19:13:52Z
    Message:
    Reason:
    Status:                False
    Type:                  Updating
--
    Type:                  RenderDegraded
    Last Transition Time:  2026-02-26T20:10:01Z
    Message:
    Reason:
    Status:                True
    Type:                  Degraded
  Configuration:
    Name:  rendered-worker-3c8750c881df6f82403924904fac6469
    Source:
      API Version:         machineconfiguration.openshift.io/v1
      Kind:                MachineConfig
      Name:                00-override-worker-generated-crio-default-ulimits
      API Version:         machineconfiguration.openshift.io/v1
      Kind:                MachineConfig
      Name:                00-worker
      API Version:         machineconfiguration.openshift.io/v1
--
  Degraded Machine Count:  0
  Machine Count:           2
  Observed Generation:     5
  Pool Synchronizers Status:
    Available Machine Count:    2
    Machine Count:              2
    Pool Synchronizer Type:     PinnedImageSets
    Ready Machine Count:        2
    Unavailable Machine Count:  0
    Updated Machine Count:      2
  Ready Machine Count:          2
--
Error from server (NotFound): machineconfigpools.machineconfiguration.openshift.io "grep" not found
    Type:                  PinnedImageSetsDegraded
    Last Transition Time:  2026-02-15T22:46:19Z
    Message:
    Reason:
    Status:                False
    Type:                  NodeDegraded
    Last Transition Time:  2026-02-26T19:13:52Z
    Message:               All nodes are updated with MachineConfig rendered-worker-3c8750c881df6f82403924904fac6469
    Reason:
    Status:                True
    Type:                  Updated
    Last Transition Time:  2026-02-26T19:13:52Z
    Message:
    Reason:
    Status:                False
    Type:                  Updating
--
    Type:                  RenderDegraded
    Last Transition Time:  2026-02-26T20:10:01Z
    Message:
    Reason:
    Status:                True
    Type:                  Degraded
  Configuration:
    Name:  rendered-worker-3c8750c881df6f82403924904fac6469
    Source:
      API Version:         machineconfiguration.openshift.io/v1
      Kind:                MachineConfig
      Name:                00-override-worker-generated-crio-default-ulimits
      API Version:         machineconfiguration.openshift.io/v1
      Kind:                MachineConfig
      Name:                00-worker
      API Version:         machineconfiguration.openshift.io/v1
--
  Degraded Machine Count:  0
  Machine Count:           2
  Observed Generation:     5
  Pool Synchronizers Status:
    Available Machine Count:    2
    Machine Count:              2
    Pool Synchronizer Type:     PinnedImageSets
    Ready Machine Count:        2
    Unavailable Machine Count:  0
    Updated Machine Count:      2
  Ready Machine Count:          2
hsuma@plnx-admin:~/ocp-ai-config$



oc get mcp worker -o jsonpath='{.status.conditions[?(@.type=="Degraded")].message}{"\n"}'

oc get nodes
oc get mcp worker -o jsonpath='{.status.degradedMachineCount}{"\n"}'

[core@ocp-ai-gpu01 ~]$
[core@ocp-ai-gpu01 ~]$ sudo cat /etc/NetworkManager/NetworkManager.conf
# Configuration file for NetworkManager.
#
# See "man 5 NetworkManager.conf" for details.
#
# The directories /usr/lib/NetworkManager/conf.d/ and /run/NetworkManager/conf.d/
# can contain additional .conf snippets installed by packages. These files are
# read before NetworkManager.conf and have thus lowest priority.
# The directory /etc/NetworkManager/conf.d/ can contain additional .conf
# snippets. Those snippets are merged last and overwrite the settings from this main
# file.
#
# The files within one conf.d/ directory are read in asciibetical order.
#
# You can prevent loading a file /usr/lib/NetworkManager/conf.d/NAME.conf
# by having a file NAME.conf in either /run/NetworkManager/conf.d/ or /etc/NetworkManager/conf.d/.
# Likewise, snippets from /run can be prevented from loading by placing
# a file with the same name in /etc/NetworkManager/conf.d/.
#
# If two files define the same key, the one that is read afterwards will overwrite
# the previous one.

[main]
#plugins=keyfile,ifcfg-rh


[logging]
# When debugging NetworkManager, enabling debug logging is of great help.
#
# Logfiles contain no passwords and little sensitive information. But please
# check before posting the file online. You can also personally hand over the
# logfile to a NM developer to treat it confidential. Meet us on #nm on Libera.Chat.
#
# You can also change the log-level at runtime via
#   $ nmcli general logging level TRACE domains ALL
# However, usually it's cleaner to enable debug logging
# in the configuration and restart NetworkManager so that
# debug logging is enabled from the start.
#
# You will find the logfiles in syslog, for example via
#   $ journalctl -u NetworkManager
#
# Please post full logfiles for bug reports without pre-filtering or truncation.
# Also, for debugging the entire `journalctl` output can be interesting. Don't
# limit unnecessarily with `journalctl -u`. Exceptions are if you are worried
# about private data. Check before posting logfiles!
#
# Note that debug logging of NetworkManager can be quite verbose. Some messages
# might be rate-limited by the logging daemon (see RateLimitIntervalSec, RateLimitBurst
# in man journald.conf). Please disable rate-limiting before collecting debug logs!
#
#level=TRACE
#domains=ALL
[core@ocp-ai-gpu01 ~]$
[core@ocp-ai-gpu01 ~]$
[core@ocp-ai-gpu01 ~]$ sudo ls /etc/NetworkManager/conf.d/
01-ipv6.conf  20-keyfiles.conf	99-kni.conf  sdn.conf
[core@ocp-ai-gpu01 ~]$ sudo cat /etc/NetworkManager/*.conf
# Configuration file for NetworkManager.
#
# See "man 5 NetworkManager.conf" for details.
#
# The directories /usr/lib/NetworkManager/conf.d/ and /run/NetworkManager/conf.d/
# can contain additional .conf snippets installed by packages. These files are
# read before NetworkManager.conf and have thus lowest priority.
# The directory /etc/NetworkManager/conf.d/ can contain additional .conf
# snippets. Those snippets are merged last and overwrite the settings from this main
# file.
#
# The files within one conf.d/ directory are read in asciibetical order.
#
# You can prevent loading a file /usr/lib/NetworkManager/conf.d/NAME.conf
# by having a file NAME.conf in either /run/NetworkManager/conf.d/ or /etc/NetworkManager/conf.d/.
# Likewise, snippets from /run can be prevented from loading by placing
# a file with the same name in /etc/NetworkManager/conf.d/.
#
# If two files define the same key, the one that is read afterwards will overwrite
# the previous one.

[main]
#plugins=keyfile,ifcfg-rh


[logging]
# When debugging NetworkManager, enabling debug logging is of great help.
#
# Logfiles contain no passwords and little sensitive information. But please
# check before posting the file online. You can also personally hand over the
# logfile to a NM developer to treat it confidential. Meet us on #nm on Libera.Chat.
#
# You can also change the log-level at runtime via
#   $ nmcli general logging level TRACE domains ALL
# However, usually it's cleaner to enable debug logging
# in the configuration and restart NetworkManager so that
# debug logging is enabled from the start.
#
# You will find the logfiles in syslog, for example via
#   $ journalctl -u NetworkManager
#
# Please post full logfiles for bug reports without pre-filtering or truncation.
# Also, for debugging the entire `journalctl` output can be interesting. Don't
# limit unnecessarily with `journalctl -u`. Exceptions are if you are worried
# about private data. Check before posting logfiles!
#
# Note that debug logging of NetworkManager can be quite verbose. Some messages
# might be rate-limited by the logging daemon (see RateLimitIntervalSec, RateLimitBurst
# in man journald.conf). Please disable rate-limiting before collecting debug logs!
#
#level=TRACE
#domains=ALL
[core@ocp-ai-gpu01 ~]$ nmcli con show --active
NAME                UUID                                  TYPE           DEVICE
ovs-if-br-ex        e9b37514-d254-4193-bdf2-0d9944fad04b  ovs-interface  br-ex
bond0.1510          7492829a-0516-4732-93ad-8427ea7fd417  vlan           bond0.1510
bond0.1792          fb754d74-c927-4a8c-a7ac-349d8450c04a  vlan           bond0.1792
bond0.1793          295bcfab-abe5-467a-8a01-806b4a9b079a  vlan           bond0.1793
bond0.1794          58d4be3e-bcc2-4f39-9114-8f8ea1fb551c  vlan           bond0.1794
bond0.1796          8bdbd875-5bdc-4aae-8d67-a53896401c84  vlan           bond0.1796
bond0.1797          cba6ef11-4bb6-4459-81d6-0e1f63eae908  vlan           bond0.1797
bond0.1798          797fc58b-c29e-483d-a522-09bd5ae18c7c  vlan           bond0.1798
Wired connection 6  24ceb865-f4fe-3a70-9f57-40c3e42364a1  ethernet       ens8f1np1
bond0               15d7874f-ff19-4ea8-bc37-5430907030c0  bond           bond0
br-ex               291eff6f-ef7f-42fd-9970-a1459ca93533  ovs-bridge     br-ex
ethernet            58e93027-fd74-4c3a-932e-b27f2ae6b4c8  ethernet       ens8f0np0
ovs-if-phys0        a74704d1-5fda-4cdf-b7e3-31cadad26049  ethernet       eno8303
ovs-port-br-ex      ce8acaa2-99c3-4060-97d6-f1c3388550eb  ovs-port       br-ex
ovs-port-phys0      1ac2139e-220c-4f2b-bbb0-b67ae0ba3a44  ovs-port       eno8303
lo                  3d5c806e-9dd6-4654-b15b-ab1c121ef746  loopback       lo
[core@ocp-ai-gpu01 ~]$ nmcli dev show | grep -i dns
[core@ocp-ai-gpu01 ~]$ nmcli dev show | grep -i dns


WARNING: Direct SSH access to machines is not recommended; instead,
make configuration changes via `machineconfig` objects:
  https://docs.openshift.com/container-platform/4.20/architecture/architecture-rhcos.html

---
Last login: Thu Feb 19 13:51:20 2026 from 10.172.248.105
[systemd]
Failed Units: 1
  NetworkManager-wait-online.service
[core@ocp-ai-gpu02 ~]$
[core@ocp-ai-gpu02 ~]$
[core@ocp-ai-gpu02 ~]$
[core@ocp-ai-gpu02 ~]$ nmcli dev show | grep -i dns
IP4.DNS[1]:                             10.172.248.31
IP4.DNS[2]:                             10.172.248.32
[core@ocp-ai-gpu02 ~]$ nmcli connection show bond0.1510 | grep -i dns
Error: bond0.1510 - no such connection profile.
[core@ocp-ai-gpu02 ~]$ nmcli connection show bnd0.1510 | grep -i dns
Error: bnd0.1510 - no such connection profile.
[core@ocp-ai-gpu02 ~]$ cat /var/run/NetworkManager/resolv.conf
# Generated by NetworkManager
search calix.local
nameserver 10.172.248.31
nameserver 10.172.248.32
[core@ocp-ai-gpu02 ~]$


# First find which connection carries the 10.172.248.x IP
nmcli connection show bond0.1510 | grep -i "ipv4.dns\|ipv4.addresses\|ipv4.method"


sudo nmcli connection modify bond0.1510 ipv4.dns "10.172.248.31 10.172.248.32" ipv4.dns-search "calix.local"
sudo nmcli connection up bond0.1510


nmcli dev show | grep -i dns
cat /var/run/NetworkManager/resolv.conf


[core@ocp-ai-gpu02 ~]$
[core@ocp-ai-gpu02 ~]$
[core@ocp-ai-gpu02 ~]$ nmcli connection show --active | head -20
NAME                UUID                                  TYPE           DEVICE
ovs-if-br-ex        ff5b2c30-73bb-4b39-8f81-182c556d02fa  ovs-interface  br-ex
bond0.1792          2992b029-93d8-41c0-9153-8a2401ba4985  vlan           bond0.1792
bond0.1793          eae6fa54-406d-4d11-9e91-a879b8b2bcc6  vlan           bond0.1793
bond0.1794          ea4efb6d-8b02-4aa7-b749-189ee9d6ec00  vlan           bond0.1794
bond0.1796          ff375638-8030-463e-8956-9e454ddbf1a5  vlan           bond0.1796
bond0.1797          5d25ff6b-49a6-4ed5-88b5-318863f69c90  vlan           bond0.1797
bond0.1798          60d7d5b9-b5ba-42b4-943d-56ab3c181088  vlan           bond0.1798
Wired connection 5  90b82598-3c5e-3776-a331-6824be73d59b  ethernet       ens8f0np0
Wired connection 6  553332f3-a032-3010-b70c-a31da9669eff  ethernet       ens8f1np1
bond0               ce7c5fb7-4bc6-4227-931d-a8ac9a8eb96b  bond           bond0
br-ex               271d5445-a067-4fb7-b4b1-5f5bef4f5881  ovs-bridge     br-ex
ovs-if-phys0        58ec7ae0-8e76-4de2-984a-af17a99380cc  ethernet       eno8303
ovs-port-br-ex      baaf44bd-b73d-44f6-a401-a15a9ba10a1b  ovs-port       br-ex
ovs-port-phys0      3257742e-c497-4646-b19c-8c9e06a629fa  ovs-port       eno8303
lo                  8cbb7cdd-98b8-4aa3-8972-8d5eae6edf0d  loopback       lo
[core@ocp-ai-gpu02 ~]$ exit
logout
Connection to ocp-ai-gpu02.calix.local closed.
hsuma@plnx-admin:~$ ssh -i ~/.ssh/ocp-ai core@ocp-ai-gpu01.calix.local
Red Hat Enterprise Linux CoreOS 9.6.20260128-1
  Part of OpenShift 4.20, RHCOS is a Kubernetes-native operating system
  managed by the Machine Config Operator (`clusteroperator/machine-config`).

WARNING: Direct SSH access to machines is not recommended; instead,
make configuration changes via `machineconfig` objects:
  https://docs.openshift.com/container-platform/4.20/architecture/architecture-rhcos.html

---
Last login: Thu Feb 26 18:23:41 2026 from 10.172.248.105
[core@ocp-ai-gpu01 ~]$ sudo nmcli connection show bond0.1510 | grep -i "ipv4.dns\|ipv4.addresses\|ipv4.method"
ipv4.method:                            disabled
ipv4.dns:                               --
ipv4.dns-search:                        --
ipv4.dns-options:                       --
ipv4.dns-priority:                      0
ipv4.addresses:                         --
[core@ocp-ai-gpu01 ~]$ sudo nmcli connection modify bond0.1510 ipv4.dns "10.172.248.31 10.172.248.32" ipv4.dns-search "calix.local"
Error: Failed to modify connection 'bond0.1510': ipv4.dns: this property is not allowed for 'method=disabled'
[core@ocp-ai-gpu01 ~]$


[core@ocp-ai-gpu01 ~]$
[core@ocp-ai-gpu01 ~]$
[core@ocp-ai-gpu01 ~]$
[core@ocp-ai-gpu01 ~]$ ip addr show | grep 10.172.248
    inet 10.172.248.153/24 brd 10.172.248.255 scope global noprefixroute br-ex
[core@ocp-ai-gpu01 ~]$
[core@ocp-ai-gpu01 ~]$
[core@ocp-ai-gpu01 ~]$ nmcli connection show --active | head -20
NAME                UUID                                  TYPE           DEVICE
ovs-if-br-ex        e9b37514-d254-4193-bdf2-0d9944fad04b  ovs-interface  br-ex
bond0.1510          7492829a-0516-4732-93ad-8427ea7fd417  vlan           bond0.1510
bond0.1792          fb754d74-c927-4a8c-a7ac-349d8450c04a  vlan           bond0.1792
bond0.1793          295bcfab-abe5-467a-8a01-806b4a9b079a  vlan           bond0.1793
bond0.1794          58d4be3e-bcc2-4f39-9114-8f8ea1fb551c  vlan           bond0.1794
bond0.1796          8bdbd875-5bdc-4aae-8d67-a53896401c84  vlan           bond0.1796
bond0.1797          cba6ef11-4bb6-4459-81d6-0e1f63eae908  vlan           bond0.1797
bond0.1798          797fc58b-c29e-483d-a522-09bd5ae18c7c  vlan           bond0.1798
Wired connection 6  24ceb865-f4fe-3a70-9f57-40c3e42364a1  ethernet       ens8f1np1
bond0               15d7874f-ff19-4ea8-bc37-5430907030c0  bond           bond0
br-ex               291eff6f-ef7f-42fd-9970-a1459ca93533  ovs-bridge     br-ex
ethernet            58e93027-fd74-4c3a-932e-b27f2ae6b4c8  ethernet       ens8f0np0
ovs-if-phys0        a74704d1-5fda-4cdf-b7e3-31cadad26049  ethernet       eno8303
ovs-port-br-ex      ce8acaa2-99c3-4060-97d6-f1c3388550eb  ovs-port       br-ex
ovs-port-phys0      1ac2139e-220c-4f2b-bbb0-b67ae0ba3a44  ovs-port       eno8303
lo                  3d5c806e-9dd6-4654-b15b-ab1c121ef746  loopback       lo
[core@ocp-ai-gpu01 ~]$ exit
logout
Connection to ocp-ai-gpu01.calix.local closed.
hsuma@plnx-admin:~$ ssh -i ~/.ssh/ocp-ai core@ocp-ai-gpu02.calix.local
Red Hat Enterprise Linux CoreOS 9.6.20260128-1
  Part of OpenShift 4.20, RHCOS is a Kubernetes-native operating system
  managed by the Machine Config Operator (`clusteroperator/machine-config`).

WARNING: Direct SSH access to machines is not recommended; instead,
make configuration changes via `machineconfig` objects:
  https://docs.openshift.com/container-platform/4.20/architecture/architecture-rhcos.html

---
Last login: Thu Feb 26 18:31:52 2026 from 10.172.248.105
[systemd]
Failed Units: 1
  NetworkManager-wait-online.service
[core@ocp-ai-gpu02 ~]$ ip addr show | grep 10.172.248
    inet 10.172.248.154/24 brd 10.172.248.255 scope global noprefixroute br-ex
[core@ocp-ai-gpu02 ~]$ nmcli connection show --active | head -20
NAME                UUID                                  TYPE           DEVICE
ovs-if-br-ex        ff5b2c30-73bb-4b39-8f81-182c556d02fa  ovs-interface  br-ex
bond0.1792          2992b029-93d8-41c0-9153-8a2401ba4985  vlan           bond0.1792
bond0.1793          eae6fa54-406d-4d11-9e91-a879b8b2bcc6  vlan           bond0.1793
bond0.1794          ea4efb6d-8b02-4aa7-b749-189ee9d6ec00  vlan           bond0.1794
bond0.1796          ff375638-8030-463e-8956-9e454ddbf1a5  vlan           bond0.1796
bond0.1797          5d25ff6b-49a6-4ed5-88b5-318863f69c90  vlan           bond0.1797
bond0.1798          60d7d5b9-b5ba-42b4-943d-56ab3c181088  vlan           bond0.1798
Wired connection 5  90b82598-3c5e-3776-a331-6824be73d59b  ethernet       ens8f0np0
Wired connection 6  553332f3-a032-3010-b70c-a31da9669eff  ethernet       ens8f1np1
bond0               ce7c5fb7-4bc6-4227-931d-a8ac9a8eb96b  bond           bond0
br-ex               271d5445-a067-4fb7-b4b1-5f5bef4f5881  ovs-bridge     br-ex
ovs-if-phys0        58ec7ae0-8e76-4de2-984a-af17a99380cc  ethernet       eno8303
ovs-port-br-ex      baaf44bd-b73d-44f6-a401-a15a9ba10a1b  ovs-port       br-ex
ovs-port-phys0      3257742e-c497-4646-b19c-8c9e06a629fa  ovs-port       eno8303
lo                  8cbb7cdd-98b8-4aa3-8972-8d5eae6edf0d  loopback       lo
[core@ocp-ai-gpu02 ~]$ nmcli -f NAME,DEVICE,TYPE connection show --active
NAME                DEVICE      TYPE
ovs-if-br-ex        br-ex       ovs-interface
bond0.1792          bond0.1792  vlan
bond0.1793          bond0.1793  vlan
bond0.1794          bond0.1794  vlan
bond0.1796          bond0.1796  vlan
bond0.1797          bond0.1797  vlan
bond0.1798          bond0.1798  vlan
Wired connection 5  ens8f0np0   ethernet
Wired connection 6  ens8f1np1   ethernet
bond0               bond0       bond
br-ex               br-ex       ovs-bridge
ovs-if-phys0        eno8303     ethernet
ovs-port-br-ex      br-ex       ovs-port
ovs-port-phys0      eno8303     ovs-port
lo                  lo          loopback
[core@ocp-ai-gpu02 ~]$ ip



# On gpu02 (still connected)
nmcli connection show ovs-if-br-ex | grep -i "ipv4.dns\|ipv4.addresses\|ipv4.method"

ssh core@ocp-ai-gpu01.calix.local
nmcli connection show ovs-if-br-ex | grep -i "ipv4.dns\|ipv4.addresses\|ipv4.method"


[core@ocp-ai-gpu02 ~]$
[core@ocp-ai-gpu02 ~]$
[core@ocp-ai-gpu02 ~]$ nmcli connection show ovs-if-br-ex | grep -i "ipv4.dns\|ipv4.addresses\|ipv4.method"
ipv4.method:                            manual
ipv4.dns:                               10.172.248.31,10.172.248.32
ipv4.dns-search:                        --
ipv4.dns-options:                       ""
ipv4.dns-priority:                      40
ipv4.addresses:                         10.172.248.154/24
[core@ocp-ai-gpu02 ~]$ exit
logout
Connection to ocp-ai-gpu02.calix.local closed.
hsuma@plnx-admin:~$ ssh -i ~/.ssh/ocp-ai core@ocp-ai-gpu01.calix.local
Red Hat Enterprise Linux CoreOS 9.6.20260128-1
  Part of OpenShift 4.20, RHCOS is a Kubernetes-native operating system
  managed by the Machine Config Operator (`clusteroperator/machine-config`).

WARNING: Direct SSH access to machines is not recommended; instead,
make configuration changes via `machineconfig` objects:
  https://docs.openshift.com/container-platform/4.20/architecture/architecture-rhcos.html

---
Last login: Thu Feb 26 18:34:54 2026 from 10.172.248.105
[core@ocp-ai-gpu01 ~]$
[core@ocp-ai-gpu01 ~]$ nmcli connection show ovs-if-br-ex | grep -i "ipv4.dns\|ipv4.addresses\|ipv4.method"
ipv4.method:                            manual
ipv4.dns:                               --
ipv4.dns-search:                        --
ipv4.dns-options:                       --
ipv4.dns-priority:                      0
ipv4.addresses:                         10.172.248.153/24
[core@ocp-ai-gpu01 ~]$


sudo nmcli connection modify ovs-if-br-ex ipv4.dns "10.172.248.31 10.172.248.32" ipv4.dns-priority 40
sudo nmcli connection up ovs-if-br-ex


# From plnx-admin - check what MachineConfigPool the GPU nodes are in
oc get mcp
oc get nodes --show-labels | grep gpu

# Check if both GPU nodes have the same rendered MachineConfig
oc get node ocp-ai-gpu01.calix.local -o jsonpath='{.metadata.annotations.machineconfiguration\.openshift\.io/currentConfig}'
oc get node ocp-ai-gpu02.calix.local -o jsonpath='{.metadata.annotations.machineconfiguration\.openshift\.io/currentConfig}'



hsuma@plnx-admin:~$ oc get node ocp-ai-gpu01.calix.local -o jsonpath='{.metadata.annotations.machineconfiguration\.openshift\.io/currentConfig}'
rendered-worker-3c8750c881df6f82403924904fac6469hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ oc get node ocp-ai-gpu02.calix.local -o jsonpath='{.metadata.annotations.machineconfiguration\.openshift\.io/currentConfig}'
rendered-worker-3c8750c881df6f82403924904fac6469hsuma@plnx-admin:~$


# List all worker MachineConfigs
oc get mc | grep worker

# Look at the rendered config for NM connection files
oc get mc rendered-worker-3c8750c881df6f82403924904fac6469 -o jsonpath='{.spec.config.storage.files[*].path}' | tr ' ' '\n' | grep -i -E "network|resolv|nmconnection"


hsuma@plnx-admin:~$ oc get mc | grep worker
00-override-worker-generated-crio-default-ulimits                                              3.5.0             10d
00-worker                                           035a7f3c16e820ed0461b25ba82c263131ff6c3d   3.5.0             10d
01-worker-container-runtime                         035a7f3c16e820ed0461b25ba82c263131ff6c3d   3.5.0             10d
01-worker-kubelet                                   035a7f3c16e820ed0461b25ba82c263131ff6c3d   3.5.0             10d
50-worker-auto-sizing-disabled                                                                 3.5.0             10d
50-workers-chrony-configuration                                                                3.1.0             10d
97-worker-generated-kubelet                         035a7f3c16e820ed0461b25ba82c263131ff6c3d   3.5.0             10d
98-worker-generated-kubelet                         035a7f3c16e820ed0461b25ba82c263131ff6c3d   3.5.0             10d
99-worker-chrony                                                                               3.2.0             7d1h
99-worker-generated-registries                      035a7f3c16e820ed0461b25ba82c263131ff6c3d   3.5.0             10d
99-worker-mtu-9000                                                                             3.2.0             8d
99-worker-ssh                                                                                  3.2.0             10d
rendered-worker-3c8750c881df6f82403924904fac6469    035a7f3c16e820ed0461b25ba82c263131ff6c3d   3.5.0             2d17h
rendered-worker-d634f7e297ea4aeb892ca8279b049985    035a7f3c16e820ed0461b25ba82c263131ff6c3d   3.5.0             8d
rendered-worker-d93ebcbc2d78faaf1b91419d22f75387    035a7f3c16e820ed0461b25ba82c263131ff6c3d   3.5.0             7d1h
rendered-worker-d98bd75b78ad2605cb64e1bbd15eaf0c    035a7f3c16e820ed0461b25ba82c263131ff6c3d   3.5.0             10d
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ oc get mc rendered-worker-3c8750c881df6f82403924904fac6469 -o jsonpath='{.spec.config.storage.files[*].path}' | tr ' ' '\n' | grep -i -E "network|resolv|nmconnection"
/etc/NetworkManager/conf.d/01-ipv6.conf
/etc/NetworkManager/conf.d/20-keyfiles.conf
/etc/NetworkManager/conf.d/99-kni.conf
/etc/NetworkManager/dispatcher.d/30-resolv-prepender
/etc/NetworkManager/dispatcher.d/99-esp-offload
/etc/NetworkManager/dispatcher.d/99-gcp-disable-idpf-tx-checksum-off
/etc/NetworkManager/conf.d/sdn.conf
/etc/NetworkManager/dispatcher.d/pre-up.d/10-ofport-request.sh
/usr/local/bin/resolv-prepender.sh
/etc/NetworkManager/dispatcher.d/99-vsphere-disable-tx-udp-tnl
hsuma@plnx-admin:~$


[core@ocp-ai-gpu01 ~]$ cat /etc/NetworkManager/dispatcher.d/30-resolv-prepender
#!/bin/bash
set -eo pipefail
IFACE=$1
STATUS=$2

function resolv_prepender {
  mkdir -p /run/resolv-prepender
  echo "IP4_DOMAINS=$IP4_DOMAINS" > /run/resolv-prepender/env.new
  echo "IP6_DOMAINS=$IP6_DOMAINS" >> /run/resolv-prepender/env.new

  if ! diff -q /run/resolv-prepender/env /run/resolv-prepender/env.new; then
    >&2 echo "NM resolv-prepender: Environment variable(s) changed. Systemd path unit will pick the change."
    mv -f /run/resolv-prepender/env.new /run/resolv-prepender/env
  fi
}

export IP4_DOMAINS IP6_DOMAINS
export -f resolv_prepender

# For RHEL8 with NetworkManager >= 1.36 and RHEL9 with NetworkManager >=1.42 we can use simplified logic
# of observing only a single "dns-change" event. Older version of NetworkManager require however that we
# react on a set of multiple events. Once dns-change event is detected we create a flag file to ignore
# subsequent up&co. events as undesired.
#
# Given an overall Network Manager dispatcher timeout of 90 seconds, we are enforcing a slightly shorter
# timeout for the observed events. It is not really required because all we do in this function is to write a file.
# We could get rid of this timeout completely, but it also does not cost much to keep it.
case "$STATUS" in
  dns-change)
    >&2 echo "NM resolv-prepender triggered by ${IFACE} ${STATUS}."
    if [ ! -f "/run/networkmanager-dns-event-detected" ]; then
      touch /run/networkmanager-dns-event-detected
    fi
    if ! timeout 60s bash -c resolv_prepender; then
      >&2 echo "NM resolv-prepender: Timeout occurred"
      exit 1
    fi
  ;;

  up|dhcp4-change|dhcp6-change|reapply)
    if [ ! -f "/run/networkmanager-dns-event-detected" ]; then
      >&2 echo "NM resolv-prepender triggered by ${IFACE} ${STATUS}."
      if ! timeout 30s bash -c resolv_prepender; then
        >&2 echo "NM resolv-prepender: Timeout occurred"
        exit 1
      fi
    fi

    # If $DHCP6_FQDN_FQDN is not empty and is not localhost.localdomain and static hostname was not already set
    if [[ -n "$DHCP6_FQDN_FQDN" && "$DHCP6_FQDN_FQDN" != "localhost.localdomain" && "$DHCP6_FQDN_FQDN" =~ "." ]] ; then
       STATIC_HOSTNAME="$(test ! -e /etc/hostname && echo -n || cat /etc/hostname | xargs)"

       if [[ -z "$STATIC_HOSTNAME" || "$STATIC_HOSTNAME" == "localhost.localdomain" ]] ; then
          # run with systemd-run to avoid selinux problems
          systemd-run --property=Type=oneshot --unit resolve-prepender-hostnamectl -Pq \
              hostnamectl set-hostname --static --transient $DHCP6_FQDN_FQDN
       fi
    fi

    if [[ "$STATUS" == "up" ]] && [[ $IFACE == "br-ex" ]]; then
        /bin/mkdir -p /run/nodeip-configuration
        touch /run/nodeip-configuration/br-ex-up
    fi
  ;;
  *)
  ;;
esac
[core@ocp-ai-gpu01 ~]$




===


[core@ocp-ai-gpu01 ~]$ cat /usr/local/bin/resolv-prepender.sh
#!/bin/bash
set -eo pipefail

function pull_baremetal_runtime_cfg_image {
    # By default podman retries to pull an image 3 times with 1 second back-off. It is not configurable. For this
    # reason we are implementing our own logic of pulling image and retrying indefinitely.
    # Ref.: https://github.com/containers/common/blob/e028741ef77fdfa3ae261b9d23cdd50253d586c4/libimage/copier.go#L27-L30

    >&2 echo "NM resolv-prepender: Checking if baremetal runtime cfg image already exists"
    if ! /usr/bin/podman image exists "quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:08de867062cd36fdbdced721a950eca386875d9d130e191ea6c1e1c9d2ed9bcd"; then
      >&2 echo "NM resolv-prepender: Starting download of baremetal runtime cfg image"
      while ! /usr/bin/podman pull --authfile /var/lib/kubelet/config.json "quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:08de867062cd36fdbdced721a950eca386875d9d130e191ea6c1e1c9d2ed9bcd"; do sleep 1; done
      >&2 echo "NM resolv-prepender: Download of baremetal runtime cfg image completed"
    else
      >&2 echo "NM resolv-prepender: Image exists, no need to download"
    fi
}

function resolv_prepender {
        # In DHCP connections, the resolv.conf content may be late, thus we wait for nameservers
        while ! grep nameserver /var/run/NetworkManager/resolv.conf; do
            >&2 echo  "NM resolv-prepender: NM resolv.conf still empty of nameserver"
            sleep 0.5
        done

        # Ensure resolv.conf exists and contains nameservers before we try to pull image or run podman
        if [[ ! -e /etc/resolv.conf ]] || ! grep -q nameserver /etc/resolv.conf; then
            cp /var/run/NetworkManager/resolv.conf /etc/resolv.conf
        fi

        # Ensure baremetalRuntimeCfgImage is pulled in a reliable way before trying to use it
        # in the subsequent code
        pull_baremetal_runtime_cfg_image

        NAMESERVER_IP="$(/usr/bin/podman run --rm \
            --authfile /var/lib/kubelet/config.json \
            --net=host \
            quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:08de867062cd36fdbdced721a950eca386875d9d130e191ea6c1e1c9d2ed9bcd \
            node-ip \
            show \
            "10.172.248.155"  \
            "10.172.248.156" )"
        DOMAINS="${IP4_DOMAINS:-} ${IP6_DOMAINS:-} ocp-ai.calix.local"
        if [[ -n "$NAMESERVER_IP" ]]; then
            KNICONFDONEPATH="/run/resolv-prepender-kni-conf-done"
            if systemctl -q is-enabled systemd-resolved; then
                >&2 echo "NM resolv-prepender: Configure for OKD domain and local IP"
                mkdir -p /etc/systemd/resolved.conf.d
                KNICONFTMPPATH="$(mktemp)"
                KNICONFPATH="/etc/systemd/resolved.conf.d/60-kni.conf"
                echo "[Resolve]" > "${KNICONFTMPPATH}"
                echo "DNS=$NAMESERVER_IP" >> "${KNICONFTMPPATH}"
                echo "Domains=${DOMAINS}" >> "${KNICONFTMPPATH}"

                # If KNI conf is not created or doesn't match what is generated or
                # if we haven't completed a full update - create or update it
                if [[ ! -f "${KNICONFPATH}" ]] || [[ ! -f "${KNICONFDONEPATH}" ]] || ! cmp --silent "${KNICONFPATH}" "${KNICONFTMPPATH}"; then
                    >&2 echo "NM resolv-prepender: Creating/updating /etc/systemd/resolved.conf.d/60-kni.conf"
                    # Remove the done file flag before writing the config
                    # This would guard against interruptions and
                    # prevent double restart of systemd-resolved
                    rm -f "${KNICONFDONEPATH}"
                    # Copy tmp file contents to preserve permissions and SELinux label
                    cat "${KNICONFTMPPATH}" > "${KNICONFPATH}"
                fi

                if [[ ! -f "${KNICONFDONEPATH}" ]]; then
                    if systemctl -q is-active systemd-resolved; then
                        >&2 echo "NM resolv-prepender: Restarting systemd-resolved"
                        systemctl restart systemd-resolved
                    fi
                    touch "${KNICONFDONEPATH}"
                fi
                rm -rf "${KNICONFTMPPATH}"
            else
                >&2 echo "NM resolv-prepender: Prepending 'nameserver $NAMESERVER_IP' to /etc/resolv.conf (other nameservers from /var/run/NetworkManager/resolv.conf)"
                RESOLVCONFTMPPATH="$(mktemp)"
                sed -e "/Generated by/c# Generated by KNI resolv prepender NM dispatcher script" \
                    /var/run/NetworkManager/resolv.conf > "${RESOLVCONFTMPPATH}"
                sed -i "0,/^nameserver.*/s//nameserver $NAMESERVER_IP\n\0/" "${RESOLVCONFTMPPATH}"
                if ! grep -q search "${RESOLVCONFTMPPATH}"; then
                    # Make sure we have a search entry
                    echo "search ocp-ai.calix.local" >> "${RESOLVCONFTMPPATH}"
                else
                    # Make sure cluster domain is first in the search list
                    sed -i "s/^search \(.*\)/search ocp-ai.calix.local \1/" "${RESOLVCONFTMPPATH}"
                    # Remove duplicate cluster domain entries
                    sed -i "s/\(search ocp-ai.calix.local.*\) ocp-ai.calix.local\( .*\|$\)/\1\2/" "${RESOLVCONFTMPPATH}"
                fi
                # Only leave the first 3 nameservers in /etc/resolv.conf
                sed -i ':a $!{N; ba}; s/\(^\|\n\)nameserver/\n# nameserver/4g' "${RESOLVCONFTMPPATH}"
                # Only touch existing resolv.conf if files actually differ
                if ! cmp -s "${RESOLVCONFTMPPATH}" /etc/resolv.conf; then
                  chmod 644 "${RESOLVCONFTMPPATH}"
                  mv -Zf "${RESOLVCONFTMPPATH}" /etc/resolv.conf
                  # Workaround for bz 1929160. Reload NetworkManager to force it to
                  # re-run the lookup of the hostname now that we know we have DNS
                  # servers configured correctly in resolv.conf.
                  nmcli general reload dns-rc
                fi
                touch "${KNICONFDONEPATH}"
                rm -rf "${RESOLVCONFTMPPATH}"
            fi
        fi
}

resolv_prepender
[core@ocp-ai-gpu01 ~]$


[core@ocp-ai-gpu01 ~]$
[core@ocp-ai-gpu01 ~]$ cat /etc/NetworkManager/system-connections/
Wired connection 6.nmconnection  bond0.1792.nmconnection          bond0.1794.nmconnection          bond0.1797.nmconnection          bond0.nmconnection               ethernet.nmconnection
bond0.1510.nmconnection          bond0.1793.nmconnection          bond0.1796.nmconnection          bond0.1798.nmconnection          eno8303.nmconnection
[core@ocp-ai-gpu01 ~]$ cat /etc/NetworkManager/system-connections/ovs-if-br-ex.nmconnection
cat: /etc/NetworkManager/system-connections/ovs-if-br-ex.nmconnection: No such file or directory
[core@ocp-ai-gpu01 ~]$
[core@ocp-ai-gpu01 ~]$
[core@ocp-ai-gpu01 ~]$ exit
logout
Connection to ocp-ai-gpu01.calix.local closed.
hsuma@plnx-admin:~$ ssh -i ~/.ssh/ocp-ai core@ocp-ai-gpu02.calix.local
Red Hat Enterprise Linux CoreOS 9.6.20260128-1
  Part of OpenShift 4.20, RHCOS is a Kubernetes-native operating system
  managed by the Machine Config Operator (`clusteroperator/machine-config`).

WARNING: Direct SSH access to machines is not recommended; instead,
make configuration changes via `machineconfig` objects:
  https://docs.openshift.com/container-platform/4.20/architecture/architecture-rhcos.html

---
Last login: Thu Feb 26 18:46:14 2026 from 10.172.248.105
[systemd]
Failed Units: 1
  NetworkManager-wait-online.service
[core@ocp-ai-gpu02 ~]$ cat /etc/NetworkManager/system-connections/
Wired connection 3.nmconnection  Wired connection 6.nmconnection  bond0.1793.nmconnection          bond0.1796.nmconnection          bond0.1798.nmconnection
Wired connection 5.nmconnection  bond0.1792.nmconnection          bond0.1794.nmconnection          bond0.1797.nmconnection          bond0.nmconnection
[core@ocp-ai-gpu02 ~]$ cat /etc/NetworkManager/system-connections/ovs-if-br-ex.nmconnectio
cat: /etc/NetworkManager/system-connections/ovs-if-br-ex.nmconnectio: No such file or directory
[core@ocp-ai-gpu02 ~]$


hsuma@plnx-admin:~$
hsuma@plnx-admin:~$ oc logs nfd-worker-2d76r -n openshift-nfd
I0226 19:46:48.121628       1 main.go:59] "version not set! Set -ldflags \"-X github.com/openshift/node-feature-discovery/pkg/version.version=`git describe --tags --dirty --always --match 'v*'`\" during build or run."
I0226 19:46:48.122085       1 nfd-worker.go:294] "Node Feature Discovery Worker" version="undefined" nodeName="ocp-ai-gpu01.calix.local" namespace="openshift-nfd"
I0226 19:46:48.122326       1 nfd-worker.go:493] "configuration file parsed" path="/etc/kubernetes/node-feature-discovery/nfd-worker.conf"
E0226 19:47:18.123896       1 nfd-worker.go:261] "failed to get self pod, cannot inherit ownerReference for NodeFeature" err="Get \"https://172.30.0.1:443/api/v1/namespaces/openshift-nfd/pods/nfd-worker-2d76r\": dial tcp 172.30.0.1:443: i/o timeout"
E0226 19:47:18.123920       1 main.go:70] "error while running" err="Get \"https://172.30.0.1:443/api/v1/namespaces/openshift-nfd/pods/nfd-worker-2d76r\": dial tcp 172.30.0.1:443: i/o timeout"
hsuma@plnx-admin:~$
