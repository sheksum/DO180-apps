sudo tee /etc/syslog-ng/syslog-ng.conf << 'EOF'
@version: 4.2
@include "scl.conf"

# Global options
options {
    keep_hostname(yes);
    use_dns(no);
    use_fqdn(no);
    chain_hostnames(off);
    stats_freq(0);
    flush_lines(0);
    time_reopen(10);
    log_fifo_size(10000);
};

# Source - receive logs from Kubernetes cluster
source s_kindo {
    tcp(
        ip("0.0.0.0")
        port(6514)
        flags(no-parse)
    );
    udp(
        ip("0.0.0.0")
        port(514)
    );
};

# Destination - write all logs with full message content
destination d_kindo_all {
    file("/var/log/kindo/all/${YEAR}-${MONTH}-${DAY}/${SOURCEIP}.log"
        create_dirs(yes)
        perm(0640)
        dir_perm(0750)
        template("${ISODATE} ${SOURCEIP} ${MSG}\n")
    );
};

# Forward to SDL (Restricted) - NO TLS FOR NOW
destination d_sdl_restricted {
    tcp("10.200.248.147" port(6514));
};

# Log path - store locally AND forward to SDL
log {
    source(s_kindo);
    destination(d_kindo_all);
    destination(d_sdl_restricted);
};

# Local system logging for this VM
source s_sys {
    system();
    internal();
};

destination d_messages { file("/var/log/messages"); };

log { source(s_sys); destination(d_messages); };
EOF

cat > /tmp/fluent-bit-ds.yaml << 'ENDOFFILE'
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluent-bit
  namespace: logging
  labels:
    app: fluent-bit
spec:
  selector:
    matchLabels:
      app: fluent-bit
  template:
    metadata:
      labels:
        app: fluent-bit
    spec:
      serviceAccountName: fluent-bit
      tolerations:
        - operator: Exists
      containers:
        - name: fluent-bit
          image: fluent/fluent-bit:2.2
          resources:
            limits:
              memory: 512Mi
              cpu: 300m
            requests:
              memory: 256Mi
              cpu: 100m
          volumeMounts:
            - name: varlog
              mountPath: /var/log
              readOnly: true
            - name: varlibdockercontainers
              mountPath: /var/lib/docker/containers
              readOnly: true
            - name: runlogjournal
              mountPath: /run/log/journal
              readOnly: true
            - name: varlogjournal
              mountPath: /var/log/journal
              readOnly: true
            - name: fluent-bit-config
              mountPath: /fluent-bit/etc/
            - name: machineid
              mountPath: /etc/machine-id
              readOnly: true
      volumes:
        - name: varlog
          hostPath:
            path: /var/log
        - name: varlibdockercontainers
          hostPath:
            path: /var/lib/docker/containers
        - name: runlogjournal
          hostPath:
            path: /run/log/journal
        - name: varlogjournal
          hostPath:
            path: /var/log/journal
        - name: fluent-bit-config
          configMap:
            name: fluent-bit-config
        - name: machineid
          hostPath:
            path: /etc/machine-id
ENDOFFILE

kubectl apply -f /tmp/fluent-bit-ds.yaml
